module.exports=[48206,e=>{"use strict";let t,s,n;var i,a,r,o,l,c,u,d,p,h,m,g,f,y,b,w,_,v,k,S,A,C,P,R,I,E,x,M,T,$,N,O,q,L,j,D,U,W,F,B,G,H,V,z,X,K,J,Y,Q,Z,ee,et,es,en,ei,ea,er,eo,el,ec,eu,ed,ep,eh,em,eg,ef=e.i(47909),ey=e.i(74017),eb=e.i(96250),ew=e.i(59756),e_=e.i(61916),ev=e.i(14444),ek=e.i(37092),eS=e.i(69741),eA=e.i(16795),eC=e.i(87718),eP=e.i(95169),eR=e.i(47587),eI=e.i(66012),eE=e.i(70101),ex=e.i(26937),eM=e.i(10372),eT=e.i(93695);e.i(52474);var e$=e.i(220),eN=e.i(89171);function eO(e,t,s,n,i){if("m"===n)throw TypeError("Private method is not writable");if("a"===n&&!i)throw TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,s):i?i.value=s:t.set(e,s),s}function eq(e,t,s,n){if("a"===s&&!n)throw TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw TypeError("Cannot read private member from an object whose class did not declare it");return"m"===s?n:"a"===s?n.call(e):n?n.value:t.get(e)}let eL=function(){let{crypto:e}=globalThis;if(e?.randomUUID)return eL=e.randomUUID.bind(e),e.randomUUID();let t=new Uint8Array(1),s=e?()=>e.getRandomValues(t)[0]:()=>255*Math.random()&255;return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,e=>(e^s()&15>>e/4).toString(16))};function ej(e){return"object"==typeof e&&null!==e&&("name"in e&&"AbortError"===e.name||"message"in e&&String(e.message).includes("FetchRequestCanceledException"))}let eD=e=>{if(e instanceof Error)return e;if("object"==typeof e&&null!==e){try{if("[object Error]"===Object.prototype.toString.call(e)){let t=Error(e.message,e.cause?{cause:e.cause}:{});return e.stack&&(t.stack=e.stack),e.cause&&!t.cause&&(t.cause=e.cause),e.name&&(t.name=e.name),t}}catch{}try{return Error(JSON.stringify(e))}catch{}}return Error(e)};class eU extends Error{}class eW extends eU{constructor(e,t,s,n){super(`${eW.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.requestID=n?.get("request-id"),this.error=t}static makeMessage(e,t,s){let n=t?.message?"string"==typeof t.message?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){return e&&n?400===e?new eH(e,t,s,n):401===e?new eV(e,t,s,n):403===e?new ez(e,t,s,n):404===e?new eX(e,t,s,n):409===e?new eK(e,t,s,n):422===e?new eJ(e,t,s,n):429===e?new eY(e,t,s,n):e>=500?new eQ(e,t,s,n):new eW(e,t,s,n):new eB({message:s,cause:eD(t)})}}class eF extends eW{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0)}}class eB extends eW{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class eG extends eB{constructor({message:e}={}){super({message:e??"Request timed out."})}}class eH extends eW{}class eV extends eW{}class ez extends eW{}class eX extends eW{}class eK extends eW{}class eJ extends eW{}class eY extends eW{}class eQ extends eW{}let eZ=/^[a-z][a-z0-9+.-]*:/i,e0=e=>(e0=Array.isArray)(e),e1=e0;function e2(e){return"object"!=typeof e?{}:e??{}}let e4=e=>{try{return JSON.parse(e)}catch(e){return}},e5="0.71.2",e3=e=>"x32"===e?"x32":"x86_64"===e||"x64"===e?"x64":"arm"===e?"arm":"aarch64"===e||"arm64"===e?"arm64":e?`other:${e}`:"unknown",e9=e=>(e=e.toLowerCase()).includes("ios")?"iOS":"android"===e?"Android":"darwin"===e?"MacOS":"win32"===e?"Windows":"freebsd"===e?"FreeBSD":"openbsd"===e?"OpenBSD":"linux"===e?"Linux":e?`Other:${e}`:"Unknown";function e6(...e){let t=globalThis.ReadableStream;if(void 0===t)throw Error("`ReadableStream` is not defined as a global; You will need to polyfill it, `globalThis.ReadableStream = ReadableStream`");return new t(...e)}function e8(e){let t=Symbol.asyncIterator in e?e[Symbol.asyncIterator]():e[Symbol.iterator]();return e6({start(){},async pull(e){let{done:s,value:n}=await t.next();s?e.close():e.enqueue(n)},async cancel(){await t.return?.()}})}function e7(e){if(e[Symbol.asyncIterator])return e;let t=e.getReader();return{async next(){try{let e=await t.read();return e?.done&&t.releaseLock(),e}catch(e){throw t.releaseLock(),e}},async return(){let e=t.cancel();return t.releaseLock(),await e,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}async function te(e){if(null===e||"object"!=typeof e)return;if(e[Symbol.asyncIterator])return void await e[Symbol.asyncIterator]().return?.();let t=e.getReader(),s=t.cancel();t.releaseLock(),await s}let tt=({headers:e,body:t})=>({bodyHeaders:{"content-type":"application/json"},body:JSON.stringify(t)});function ts(e){let t;return(s??(s=(t=new globalThis.TextEncoder).encode.bind(t)))(e)}function tn(e){let t;return(n??(n=(t=new globalThis.TextDecoder).decode.bind(t)))(e)}class ti{constructor(){i.set(this,void 0),a.set(this,void 0),eO(this,i,new Uint8Array,"f"),eO(this,a,null,"f")}decode(e){let t;if(null==e)return[];let s=e instanceof ArrayBuffer?new Uint8Array(e):"string"==typeof e?ts(e):e;eO(this,i,function(e){let t=0;for(let s of e)t+=s.length;let s=new Uint8Array(t),n=0;for(let t of e)s.set(t,n),n+=t.length;return s}([eq(this,i,"f"),s]),"f");let n=[];for(;null!=(t=function(e,t){for(let s=t??0;s<e.length;s++){if(10===e[s])return{preceding:s,index:s+1,carriage:!1};if(13===e[s])return{preceding:s,index:s+1,carriage:!0}}return null}(eq(this,i,"f"),eq(this,a,"f")));){if(t.carriage&&null==eq(this,a,"f")){eO(this,a,t.index,"f");continue}if(null!=eq(this,a,"f")&&(t.index!==eq(this,a,"f")+1||t.carriage)){n.push(tn(eq(this,i,"f").subarray(0,eq(this,a,"f")-1))),eO(this,i,eq(this,i,"f").subarray(eq(this,a,"f")),"f"),eO(this,a,null,"f");continue}let e=null!==eq(this,a,"f")?t.preceding-1:t.preceding,s=tn(eq(this,i,"f").subarray(0,e));n.push(s),eO(this,i,eq(this,i,"f").subarray(t.index),"f"),eO(this,a,null,"f")}return n}flush(){return eq(this,i,"f").length?this.decode("\n"):[]}}i=new WeakMap,a=new WeakMap,ti.NEWLINE_CHARS=new Set(["\n","\r"]),ti.NEWLINE_REGEXP=/\r\n|[\n\r]/g;let ta={off:0,error:200,warn:300,info:400,debug:500},tr=(e,t,s)=>{if(e){if(Object.prototype.hasOwnProperty.call(ta,e))return e;td(s).warn(`${t} was set to ${JSON.stringify(e)}, expected one of ${JSON.stringify(Object.keys(ta))}`)}};function to(){}function tl(e,t,s){return!t||ta[e]>ta[s]?to:t[e].bind(t)}let tc={error:to,warn:to,info:to,debug:to},tu=new WeakMap;function td(e){let t=e.logger,s=e.logLevel??"off";if(!t)return tc;let n=tu.get(t);if(n&&n[0]===s)return n[1];let i={error:tl("error",t,s),warn:tl("warn",t,s),info:tl("info",t,s),debug:tl("debug",t,s)};return tu.set(t,[s,i]),i}let tp=e=>(e.options&&(e.options={...e.options},delete e.options.headers),e.headers&&(e.headers=Object.fromEntries((e.headers instanceof Headers?[...e.headers]:Object.entries(e.headers)).map(([e,t])=>[e,"x-api-key"===e.toLowerCase()||"authorization"===e.toLowerCase()||"cookie"===e.toLowerCase()||"set-cookie"===e.toLowerCase()?"***":t]))),"retryOfRequestLogID"in e&&(e.retryOfRequestLogID&&(e.retryOf=e.retryOfRequestLogID),delete e.retryOfRequestLogID),e);class th{constructor(e,t,s){this.iterator=e,r.set(this,void 0),this.controller=t,eO(this,r,s,"f")}static fromSSEResponse(e,t,s){let n=!1,i=s?td(s):console;async function*a(){if(n)throw new eU("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let s=!1;try{for await(let s of tm(e,t)){if("completion"===s.event)try{yield JSON.parse(s.data)}catch(e){throw i.error("Could not parse message into JSON:",s.data),i.error("From chunk:",s.raw),e}if("message_start"===s.event||"message_delta"===s.event||"message_stop"===s.event||"content_block_start"===s.event||"content_block_delta"===s.event||"content_block_stop"===s.event)try{yield JSON.parse(s.data)}catch(e){throw i.error("Could not parse message into JSON:",s.data),i.error("From chunk:",s.raw),e}if("ping"!==s.event&&"error"===s.event)throw new eW(void 0,e4(s.data)??s.data,void 0,e.headers)}s=!0}catch(e){if(ej(e))return;throw e}finally{s||t.abort()}}return new th(a,t,s)}static fromReadableStream(e,t,s){let n=!1;async function*i(){let t=new ti;for await(let s of e7(e))for(let e of t.decode(s))yield e;for(let e of t.flush())yield e}return new th(async function*(){if(n)throw new eU("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");n=!0;let e=!1;try{for await(let t of i())!e&&t&&(yield JSON.parse(t));e=!0}catch(e){if(ej(e))return;throw e}finally{e||t.abort()}},t,s)}[(r=new WeakMap,Symbol.asyncIterator)](){return this.iterator()}tee(){let e=[],t=[],s=this.iterator(),n=n=>({next:()=>{if(0===n.length){let n=s.next();e.push(n),t.push(n)}return n.shift()}});return[new th(()=>n(e),this.controller,eq(this,r,"f")),new th(()=>n(t),this.controller,eq(this,r,"f"))]}toReadableStream(){let e,t=this;return e6({async start(){e=t[Symbol.asyncIterator]()},async pull(t){try{let{value:s,done:n}=await e.next();if(n)return t.close();let i=ts(JSON.stringify(s)+"\n");t.enqueue(i)}catch(e){t.error(e)}},async cancel(){await e.return?.()}})}}async function*tm(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new eU("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new eU("Attempted to iterate over a response with no body")}let s=new tf,n=new ti;for await(let t of tg(e7(e.body)))for(let e of n.decode(t)){let t=s.decode(e);t&&(yield t)}for(let e of n.flush()){let t=s.decode(e);t&&(yield t)}}async function*tg(e){let t=new Uint8Array;for await(let s of e){let e;if(null==s)continue;let n=s instanceof ArrayBuffer?new Uint8Array(s):"string"==typeof s?ts(s):s,i=new Uint8Array(t.length+n.length);for(i.set(t),i.set(n,t.length),t=i;-1!==(e=function(e){for(let t=0;t<e.length-1;t++){if(10===e[t]&&10===e[t+1]||13===e[t]&&13===e[t+1])return t+2;if(13===e[t]&&10===e[t+1]&&t+3<e.length&&13===e[t+2]&&10===e[t+3])return t+4}return -1}(t));)yield t.slice(0,e),t=t.slice(e)}t.length>0&&(yield t)}class tf{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){var t;let s;if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let e={event:this.event,data:this.data.join("\n"),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],e}if(this.chunks.push(e),e.startsWith(":"))return null;let[n,i,a]=-1!==(s=(t=e).indexOf(":"))?[t.substring(0,s),":",t.substring(s+1)]:[t,"",""];return a.startsWith(" ")&&(a=a.substring(1)),"event"===n?this.event=a:"data"===n&&this.data.push(a),null}}async function ty(e,t){let{response:s,requestLogID:n,retryOfRequestLogID:i,startTime:a}=t,r=await (async()=>{if(t.options.stream)return(td(e).debug("response",s.status,s.url,s.headers,s.body),t.options.__streamClass)?t.options.__streamClass.fromSSEResponse(s,t.controller):th.fromSSEResponse(s,t.controller);if(204===s.status)return null;if(t.options.__binaryResponse)return s;let n=s.headers.get("content-type"),i=n?.split(";")[0]?.trim();return i?.includes("application/json")||i?.endsWith("+json")?tb(await s.json(),s):await s.text()})();return td(e).debug(`[${n}] response parsed`,tp({retryOfRequestLogID:i,url:s.url,status:s.status,body:r,durationMs:Date.now()-a})),r}function tb(e,t){return!e||"object"!=typeof e||Array.isArray(e)?e:Object.defineProperty(e,"_request_id",{value:t.headers.get("request-id"),enumerable:!1})}class tw extends Promise{constructor(e,t,s=ty){super(e=>{e(null)}),this.responsePromise=t,this.parseResponse=s,o.set(this,void 0),eO(this,o,e,"f")}_thenUnwrap(e){return new tw(eq(this,o,"f"),this.responsePromise,async(t,s)=>tb(e(await this.parseResponse(t,s),s),s.response))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t,request_id:t.headers.get("request-id")}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(e=>this.parseResponse(eq(this,o,"f"),e))),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}o=new WeakMap;class t_{constructor(e,t,s,n){l.set(this,void 0),eO(this,l,e,"f"),this.options=n,this.response=t,this.body=s}hasNextPage(){return!!this.getPaginatedItems().length&&null!=this.nextPageRequestOptions()}async getNextPage(){let e=this.nextPageRequestOptions();if(!e)throw new eU("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");return await eq(this,l,"f").requestAPIList(this.constructor,e)}async *iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async *[(l=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}}class tv extends tw{constructor(e,t,s){super(e,t,async(e,t)=>new s(e,t.response,await ty(e,t),t.options))}async *[Symbol.asyncIterator](){for await(let e of(await this))yield e}}class tk extends t_{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.first_id=s.first_id||null,this.last_id=s.last_id||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){if(this.options.query?.before_id){let e=this.first_id;return e?{...this.options,query:{...e2(this.options.query),before_id:e}}:null}let e=this.last_id;return e?{...this.options,query:{...e2(this.options.query),after_id:e}}:null}}class tS extends t_{constructor(e,t,s,n){super(e,t,s,n),this.data=s.data||[],this.has_more=s.has_more||!1,this.next_page=s.next_page||null}getPaginatedItems(){return this.data??[]}hasNextPage(){return!1!==this.has_more&&super.hasNextPage()}nextPageRequestOptions(){let e=this.next_page;return e?{...this.options,query:{...e2(this.options.query),page:e}}:null}}let tA=()=>{if("undefined"==typeof File){let{process:e}=globalThis;throw Error("`File` is not defined as a global, which is required for file uploads."+("string"==typeof e?.versions?.node&&20>parseInt(e.versions.node.split("."))?" Update to Node 20 LTS or newer, or set `globalThis.File` to `import('node:buffer').File`.":""))}};function tC(e,t,s){return tA(),new File(e,t??"unknown_file",s)}function tP(e){return("object"==typeof e&&null!==e&&("name"in e&&e.name&&String(e.name)||"url"in e&&e.url&&String(e.url)||"filename"in e&&e.filename&&String(e.filename)||"path"in e&&e.path&&String(e.path))||"").split(/[\\/]/).pop()||void 0}let tR=e=>null!=e&&"object"==typeof e&&"function"==typeof e[Symbol.asyncIterator],tI=async(e,t)=>({...e,body:await tx(e.body,t)}),tE=new WeakMap,tx=async(e,t)=>{if(!await function(e){let t="function"==typeof e?e:e.fetch,s=tE.get(t);if(s)return s;let n=(async()=>{try{let e="Response"in t?t.Response:(await t("data:,")).constructor,s=new FormData;if(s.toString()===await new e(s).text())return!1;return!0}catch{return!0}})();return tE.set(t,n),n}(t))throw TypeError("The provided fetch function does not support file uploads with the current global FormData class.");let s=new FormData;return await Promise.all(Object.entries(e||{}).map(([e,t])=>t$(s,e,t))),s},tM=e=>e instanceof Blob&&"name"in e,tT=e=>{if("object"==typeof e&&null!==e&&(e instanceof Response||tR(e)||tM(e)))return!0;if(Array.isArray(e))return e.some(tT);if(e&&"object"==typeof e){for(let t in e)if(tT(e[t]))return!0}return!1},t$=async(e,t,s)=>{if(void 0!==s){if(null==s)throw TypeError(`Received null for "${t}"; to pass null in FormData, you must use the string 'null'`);if("string"==typeof s||"number"==typeof s||"boolean"==typeof s)e.append(t,String(s));else if(s instanceof Response){let n={},i=s.headers.get("Content-Type");i&&(n={type:i}),e.append(t,tC([await s.blob()],tP(s),n))}else if(tR(s))e.append(t,tC([await new Response(e8(s)).blob()],tP(s)));else if(tM(s))e.append(t,tC([s],tP(s),{type:s.type}));else if(Array.isArray(s))await Promise.all(s.map(s=>t$(e,t+"[]",s)));else if("object"==typeof s)await Promise.all(Object.entries(s).map(([s,n])=>t$(e,`${t}[${s}]`,n)));else throw TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${s} instead`)}},tN=e=>null!=e&&"object"==typeof e&&"number"==typeof e.size&&"string"==typeof e.type&&"function"==typeof e.text&&"function"==typeof e.slice&&"function"==typeof e.arrayBuffer;async function tO(e,t,s){let n,i;if(tA(),e=await e,t||(t=tP(e)),null!=(n=e)&&"object"==typeof n&&"string"==typeof n.name&&"number"==typeof n.lastModified&&tN(n))return e instanceof File&&null==t&&null==s?e:tC([await e.arrayBuffer()],t??e.name,{type:e.type,lastModified:e.lastModified,...s});if(null!=(i=e)&&"object"==typeof i&&"string"==typeof i.url&&"function"==typeof i.blob){let n=await e.blob();return t||(t=new URL(e.url).pathname.split(/[\\/]/).pop()),tC(await tq(n),t,s)}let a=await tq(e);if(!s?.type){let e=a.find(e=>"object"==typeof e&&"type"in e&&e.type);"string"==typeof e&&(s={...s,type:e})}return tC(a,t,s)}async function tq(e){let t=[];if("string"==typeof e||ArrayBuffer.isView(e)||e instanceof ArrayBuffer)t.push(e);else if(tN(e))t.push(e instanceof Blob?e:await e.arrayBuffer());else if(tR(e))for await(let s of e)t.push(...await tq(s));else{let t=e?.constructor?.name;throw Error(`Unexpected data type: ${typeof e}${t?`; constructor: ${t}`:""}${function(e){if("object"!=typeof e||null===e)return"";let t=Object.getOwnPropertyNames(e);return`; props: [${t.map(e=>`"${e}"`).join(", ")}]`}(e)}`)}return t}class tL{constructor(e){this._client=e}}let tj=Symbol.for("brand.privateNullableHeaders"),tD=e=>{let t=new Headers,s=new Set;for(let n of e){let e=new Set;for(let[i,a]of function*(e){let t;if(!e)return;if(tj in e){let{values:t,nulls:s}=e;for(let e of(yield*t.entries(),s))yield[e,null];return}let s=!1;for(let n of(e instanceof Headers?t=e.entries():e1(e)?t=e:(s=!0,t=Object.entries(e??{})),t)){let e=n[0];if("string"!=typeof e)throw TypeError("expected header name to be a string");let t=e1(n[1])?n[1]:[n[1]],i=!1;for(let n of t)void 0!==n&&(s&&!i&&(i=!0,yield[e,null]),yield[e,n])}}(n)){let n=i.toLowerCase();e.has(n)||(t.delete(i),e.add(n)),null===a?(t.delete(i),s.add(n)):(t.append(i,a),s.delete(n))}}return{[tj]:!0,values:t,nulls:s}};function tU(e){return e.replace(/[^A-Za-z0-9\-._~!$&'()*+,;=:@]+/g,encodeURIComponent)}let tW=Object.freeze(Object.create(null)),tF=((e=tU)=>function(t,...s){let n;if(1===t.length)return t[0];let i=!1,a=[],r=t.reduce((t,n,r)=>{/[?#]/.test(n)&&(i=!0);let o=s[r],l=(i?encodeURIComponent:e)(""+o);return r!==s.length&&(null==o||"object"==typeof o&&o.toString===Object.getPrototypeOf(Object.getPrototypeOf(o.hasOwnProperty??tW)??tW)?.toString)&&(l=o+"",a.push({start:t.length+n.length,length:l.length,error:`Value of type ${Object.prototype.toString.call(o).slice(8,-1)} is not a valid path parameter`})),t+n+(r===s.length?"":l)},""),o=r.split(/[?#]/,1)[0],l=/(?<=^|\/)(?:\.|%2e){1,2}(?=\/|$)/gi;for(;null!==(n=l.exec(o));)a.push({start:n.index,length:n[0].length,error:`Value "${n[0]}" can't be safely passed as a path parameter`});if(a.sort((e,t)=>e.start-t.start),a.length>0){let e=0,t=a.reduce((t,s)=>{let n=" ".repeat(s.start-e),i="^".repeat(s.length);return e=s.start+s.length,t+n+i},"");throw new eU(`Path parameters result in path with invalid segments:
${a.map(e=>e.error).join("\n")}
${r}
${t}`)}return r})(tU);class tB extends tL{list(e={},t){let{betas:s,...n}=e??{};return this._client.getAPIList("/v1/files",tk,{query:n,...t,headers:tD([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},t?.headers])})}delete(e,t={},s){let{betas:n}=t??{};return this._client.delete(tF`/v1/files/${e}`,{...s,headers:tD([{"anthropic-beta":[...n??[],"files-api-2025-04-14"].toString()},s?.headers])})}download(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/files/${e}/content`,{...s,headers:tD([{"anthropic-beta":[...n??[],"files-api-2025-04-14"].toString(),Accept:"application/binary"},s?.headers]),__binaryResponse:!0})}retrieveMetadata(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/files/${e}`,{...s,headers:tD([{"anthropic-beta":[...n??[],"files-api-2025-04-14"].toString()},s?.headers])})}upload(e,t){let{betas:s,...n}=e;return this._client.post("/v1/files",tI({body:n,...t,headers:tD([{"anthropic-beta":[...s??[],"files-api-2025-04-14"].toString()},t?.headers])},this._client))}}class tG extends tL{retrieve(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/models/${e}?beta=true`,{...s,headers:tD([{...n?.toString()!=null?{"anthropic-beta":n?.toString()}:void 0},s?.headers])})}list(e={},t){let{betas:s,...n}=e??{};return this._client.getAPIList("/v1/models?beta=true",tk,{query:n,...t,headers:tD([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},t?.headers])})}}let tH={"claude-opus-4-20250514":8192,"claude-opus-4-0":8192,"claude-4-opus-20250514":8192,"anthropic.claude-opus-4-20250514-v1:0":8192,"claude-opus-4@20250514":8192,"claude-opus-4-1-20250805":8192,"anthropic.claude-opus-4-1-20250805-v1:0":8192,"claude-opus-4-1@20250805":8192};function tV(e,t,s){return t&&"parse"in(t.output_format??{})?tz(e,t,s):{...e,content:e.content.map(e=>"text"===e.type?Object.defineProperty(Object.defineProperty({...e},"parsed_output",{value:null,enumerable:!1}),"parsed",{get:()=>(s.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),null),enumerable:!1}):e),parsed_output:null}}function tz(e,t,s){let n=null,i=e.content.map(e=>{if("text"===e.type){let i=function(e,t){if(e.output_format?.type!=="json_schema")return null;try{if("parse"in e.output_format)return e.output_format.parse(t);return JSON.parse(t)}catch(e){throw new eU(`Failed to parse structured output: ${e}`)}}(t,e.text);return null===n&&(n=i),Object.defineProperty(Object.defineProperty({...e},"parsed_output",{value:i,enumerable:!1}),"parsed",{get:()=>(s.logger.warn("The `parsed` property on `text` blocks is deprecated, please use `parsed_output` instead."),i),enumerable:!1})}return e});return{...e,content:i,parsed_output:n}}let tX=e=>{if(0===e.length)return e;let t=e[e.length-1];switch(t.type){case"separator":return tX(e=e.slice(0,e.length-1));case"number":let s=t.value[t.value.length-1];if("."===s||"-"===s)return tX(e=e.slice(0,e.length-1));case"string":let n=e[e.length-2];if(n?.type==="delimiter"||n?.type==="brace"&&"{"===n.value)return tX(e=e.slice(0,e.length-1));break;case"delimiter":return tX(e=e.slice(0,e.length-1))}return e},tK=e=>{var t;let s,n;return JSON.parse((t=tX((e=>{let t=0,s=[];for(;t<e.length;){let n=e[t];if("\\"===n){t++;continue}if("{"===n){s.push({type:"brace",value:"{"}),t++;continue}if("}"===n){s.push({type:"brace",value:"}"}),t++;continue}if("["===n){s.push({type:"paren",value:"["}),t++;continue}if("]"===n){s.push({type:"paren",value:"]"}),t++;continue}if(":"===n){s.push({type:"separator",value:":"}),t++;continue}if(","===n){s.push({type:"delimiter",value:","}),t++;continue}if('"'===n){let i="",a=!1;for(n=e[++t];'"'!==n;){if(t===e.length){a=!0;break}if("\\"===n){if(++t===e.length){a=!0;break}i+=n+e[t],n=e[++t]}else i+=n,n=e[++t]}n=e[++t],a||s.push({type:"string",value:i});continue}let i=/\s/;if(n&&i.test(n)){t++;continue}let a=/[0-9]/;if(n&&a.test(n)||"-"===n||"."===n){let i="";for("-"===n&&(i+=n,n=e[++t]);n&&a.test(n)||"."===n;)i+=n,n=e[++t];s.push({type:"number",value:i});continue}let r=/[a-z]/i;if(n&&r.test(n)){let i="";for(;n&&r.test(n)&&t!==e.length;)i+=n,n=e[++t];"true"==i||"false"==i||"null"===i?s.push({type:"name",value:i}):t++;continue}t++}return s})(e)),s=[],t.map(e=>{"brace"===e.type&&("{"===e.value?s.push("}"):s.splice(s.lastIndexOf("}"),1)),"paren"===e.type&&("["===e.value?s.push("]"):s.splice(s.lastIndexOf("]"),1))}),s.length>0&&s.reverse().map(e=>{"}"===e?t.push({type:"brace",value:"}"}):"]"===e&&t.push({type:"paren",value:"]"})}),n="",t.map(e=>{"string"===e.type?n+='"'+e.value+'"':n+=e.value}),n))},tJ="__json_buf";function tY(e){return"tool_use"===e.type||"server_tool_use"===e.type||"mcp_tool_use"===e.type}class tQ{constructor(e,t){c.add(this),this.messages=[],this.receivedMessages=[],u.set(this,void 0),d.set(this,null),this.controller=new AbortController,p.set(this,void 0),h.set(this,()=>{}),m.set(this,()=>{}),g.set(this,void 0),f.set(this,()=>{}),y.set(this,()=>{}),b.set(this,{}),w.set(this,!1),_.set(this,!1),v.set(this,!1),k.set(this,!1),S.set(this,void 0),A.set(this,void 0),C.set(this,void 0),I.set(this,e=>{if(eO(this,_,!0,"f"),ej(e)&&(e=new eF),e instanceof eF)return eO(this,v,!0,"f"),this._emit("abort",e);if(e instanceof eU)return this._emit("error",e);if(e instanceof Error){let t=new eU(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new eU(String(e)))}),eO(this,p,new Promise((e,t)=>{eO(this,h,e,"f"),eO(this,m,t,"f")}),"f"),eO(this,g,new Promise((e,t)=>{eO(this,f,e,"f"),eO(this,y,t,"f")}),"f"),eq(this,p,"f").catch(()=>{}),eq(this,g,"f").catch(()=>{}),eO(this,d,e,"f"),eO(this,C,t?.logger??console,"f")}get response(){return eq(this,S,"f")}get request_id(){return eq(this,A,"f")}async withResponse(){eO(this,k,!0,"f");let e=await eq(this,p,"f");if(!e)throw Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new tQ(null);return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s,{logger:n}={}){let i=new tQ(t,{logger:n});for(let e of t.messages)i._addMessageParam(e);return eO(i,d,{...t,stream:!0},"f"),i._run(()=>i._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),i}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},eq(this,I,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n,i=s?.signal;i&&(i.aborted&&this.controller.abort(),n=this.controller.abort.bind(this.controller),i.addEventListener("abort",n));try{eq(this,c,"m",E).call(this);let{response:n,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();for await(let e of(this._connected(n),i))eq(this,c,"m",x).call(this,e);if(i.controller.signal?.aborted)throw new eF;eq(this,c,"m",M).call(this)}finally{i&&n&&i.removeEventListener("abort",n)}}_connected(e){this.ended||(eO(this,S,e,"f"),eO(this,A,e?.headers.get("request-id"),"f"),eq(this,h,"f").call(this,e),this._emit("connect"))}get ended(){return eq(this,w,"f")}get errored(){return eq(this,_,"f")}get aborted(){return eq(this,v,"f")}abort(){this.controller.abort()}on(e,t){return(eq(this,b,"f")[e]||(eq(this,b,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=eq(this,b,"f")[e];if(!s)return this;let n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(eq(this,b,"f")[e]||(eq(this,b,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{eO(this,k,!0,"f"),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){eO(this,k,!0,"f"),await eq(this,g,"f")}get currentMessage(){return eq(this,u,"f")}async finalMessage(){return await this.done(),eq(this,c,"m",P).call(this)}async finalText(){return await this.done(),eq(this,c,"m",R).call(this)}_emit(e,...t){if(eq(this,w,"f"))return;"end"===e&&(eO(this,w,!0,"f"),eq(this,f,"f").call(this));let s=eq(this,b,"f")[e];if(s&&(eq(this,b,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];eq(this,k,"f")||s?.length||Promise.reject(e),eq(this,m,"f").call(this,e),eq(this,y,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];eq(this,k,"f")||s?.length||Promise.reject(e),eq(this,m,"f").call(this,e),eq(this,y,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",eq(this,c,"m",P).call(this))}async _fromReadableStream(e,t){let s,n=t?.signal;n&&(n.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),n.addEventListener("abort",s));try{eq(this,c,"m",E).call(this),this._connected(null);let t=th.fromReadableStream(e,this.controller);for await(let e of t)eq(this,c,"m",x).call(this,e);if(t.controller.signal?.aborted)throw new eF;eq(this,c,"m",M).call(this)}finally{n&&s&&n.removeEventListener("abort",s)}}[(u=new WeakMap,d=new WeakMap,p=new WeakMap,h=new WeakMap,m=new WeakMap,g=new WeakMap,f=new WeakMap,y=new WeakMap,b=new WeakMap,w=new WeakMap,_=new WeakMap,v=new WeakMap,k=new WeakMap,S=new WeakMap,A=new WeakMap,C=new WeakMap,I=new WeakMap,c=new WeakSet,P=function(){if(0===this.receivedMessages.length)throw new eU("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},R=function(){if(0===this.receivedMessages.length)throw new eU("stream ended without producing a Message with role=assistant");let e=this.receivedMessages.at(-1).content.filter(e=>"text"===e.type).map(e=>e.text);if(0===e.length)throw new eU("stream ended without producing a content block with type=text");return e.join(" ")},E=function(){this.ended||eO(this,u,void 0,"f")},x=function(e){if(this.ended)return;let t=eq(this,c,"m",T).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{let s=t.content.at(-1);switch(e.delta.type){case"text_delta":"text"===s.type&&this._emit("text",e.delta.text,s.text||"");break;case"citations_delta":"text"===s.type&&this._emit("citation",e.delta.citation,s.citations??[]);break;case"input_json_delta":tY(s)&&s.input&&this._emit("inputJson",e.delta.partial_json,s.input);break;case"thinking_delta":"thinking"===s.type&&this._emit("thinking",e.delta.thinking,s.thinking);break;case"signature_delta":"thinking"===s.type&&this._emit("signature",s.signature);break;default:tZ(e.delta)}break}case"message_stop":this._addMessageParam(t),this._addMessage(tV(t,eq(this,d,"f"),{logger:eq(this,C,"f")}),!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":eO(this,u,t,"f")}},M=function(){if(this.ended)throw new eU("stream has ended, this shouldn't happen");let e=eq(this,u,"f");if(!e)throw new eU("request ended without sending any chunks");return eO(this,u,void 0,"f"),tV(e,eq(this,d,"f"),{logger:eq(this,C,"f")})},T=function(e){let t=eq(this,u,"f");if("message_start"===e.type){if(t)throw new eU(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new eU(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.container=e.delta.container,t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,t.context_management=e.context_management,null!=e.usage.input_tokens&&(t.usage.input_tokens=e.usage.input_tokens),null!=e.usage.cache_creation_input_tokens&&(t.usage.cache_creation_input_tokens=e.usage.cache_creation_input_tokens),null!=e.usage.cache_read_input_tokens&&(t.usage.cache_read_input_tokens=e.usage.cache_read_input_tokens),null!=e.usage.server_tool_use&&(t.usage.server_tool_use=e.usage.server_tool_use),t;case"content_block_start":return t.content.push(e.content_block),t;case"content_block_delta":{let s=t.content.at(e.index);switch(e.delta.type){case"text_delta":s?.type==="text"&&(t.content[e.index]={...s,text:(s.text||"")+e.delta.text});break;case"citations_delta":s?.type==="text"&&(t.content[e.index]={...s,citations:[...s.citations??[],e.delta.citation]});break;case"input_json_delta":if(s&&tY(s)){let n=s[tJ]||"";n+=e.delta.partial_json;let i={...s};if(Object.defineProperty(i,tJ,{value:n,enumerable:!1,writable:!0}),n)try{i.input=tK(n)}catch(t){let e=new eU(`Unable to parse tool parameter JSON from model. Please retry your request or adjust your prompt. Error: ${t}. JSON: ${n}`);eq(this,I,"f").call(this,e)}t.content[e.index]=i}break;case"thinking_delta":s?.type==="thinking"&&(t.content[e.index]={...s,thinking:s.thinking+e.delta.thinking});break;case"signature_delta":s?.type==="thinking"&&(t.content[e.index]={...s,signature:e.delta.signature});break;default:tZ(e.delta)}return t}}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",s=>{let n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{for(let e of(s=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new th(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function tZ(e){}let t0=`You have been working on the task described above but have not yet completed it. Write a continuation summary that will allow you (or another instance of yourself) to resume work efficiently in a future context window where the conversation history will be replaced with this summary. Your summary should be structured, concise, and actionable. Include:
1. Task Overview
The user's core request and success criteria
Any clarifications or constraints they specified
2. Current State
What has been completed so far
Files created, modified, or analyzed (with paths if relevant)
Key outputs or artifacts produced
3. Important Discoveries
Technical constraints or requirements uncovered
Decisions made and their rationale
Errors encountered and how they were resolved
What approaches were tried that didn't work (and why)
4. Next Steps
Specific actions needed to complete the task
Any blockers or open questions to resolve
Priority order if multiple steps remain
5. Context to Preserve
User preferences or style requirements
Domain-specific details that aren't obvious
Any promises made to the user
Be concise but completeâ€”err on the side of including information that would prevent duplicate work or repeated mistakes. Write in a way that enables immediate resumption of the task.
Wrap your summary in <summary></summary> tags.`;function t1(){let e,t;return{promise:new Promise((s,n)=>{e=s,t=n}),resolve:e,reject:t}}class t2{constructor(e,t,s){$.add(this),this.client=e,N.set(this,!1),O.set(this,!1),q.set(this,void 0),L.set(this,void 0),j.set(this,void 0),D.set(this,void 0),U.set(this,void 0),W.set(this,0),eO(this,q,{params:{...t,messages:structuredClone(t.messages)}},"f"),eO(this,L,{...s,headers:tD([{"x-stainless-helper":"BetaToolRunner"},s?.headers])},"f"),eO(this,U,t1(),"f")}async *[(N=new WeakMap,O=new WeakMap,q=new WeakMap,L=new WeakMap,j=new WeakMap,D=new WeakMap,U=new WeakMap,W=new WeakMap,$=new WeakSet,F=async function(){let e=eq(this,q,"f").params.compactionControl;if(!e||!e.enabled)return!1;let t=0;if(void 0!==eq(this,j,"f"))try{let e=await eq(this,j,"f");t=e.usage.input_tokens+(e.usage.cache_creation_input_tokens??0)+(e.usage.cache_read_input_tokens??0)+e.usage.output_tokens}catch{return!1}if(t<(e.contextTokenThreshold??1e5))return!1;let s=e.model??eq(this,q,"f").params.model,n=e.summaryPrompt??t0,i=eq(this,q,"f").params.messages;if("assistant"===i[i.length-1].role){let e=i[i.length-1];if(Array.isArray(e.content)){let t=e.content.filter(e=>"tool_use"!==e.type);0===t.length?i.pop():e.content=t}}let a=await this.client.beta.messages.create({model:s,messages:[...i,{role:"user",content:[{type:"text",text:n}]}],max_tokens:eq(this,q,"f").params.max_tokens},{headers:{"x-stainless-helper":"compaction"}});if(a.content[0]?.type!=="text")throw new eU("Expected text response for compaction");return eq(this,q,"f").params.messages=[{role:"user",content:a.content}],!0},Symbol.asyncIterator)](){var e;if(eq(this,N,"f"))throw new eU("Cannot iterate over a consumed stream");eO(this,N,!0,"f"),eO(this,O,!0,"f"),eO(this,D,void 0,"f");try{for(;;){let t;try{if(eq(this,q,"f").params.max_iterations&&eq(this,W,"f")>=eq(this,q,"f").params.max_iterations)break;eO(this,O,!1,"f"),eO(this,D,void 0,"f"),eO(this,W,(e=eq(this,W,"f"),++e),"f"),eO(this,j,void 0,"f");let{max_iterations:s,compactionControl:n,...i}=eq(this,q,"f").params;if(i.stream?(t=this.client.beta.messages.stream({...i},eq(this,L,"f")),eO(this,j,t.finalMessage(),"f"),eq(this,j,"f").catch(()=>{}),yield t):(eO(this,j,this.client.beta.messages.create({...i,stream:!1},eq(this,L,"f")),"f"),yield eq(this,j,"f")),!await eq(this,$,"m",F).call(this)){if(!eq(this,O,"f")){let{role:e,content:t}=await eq(this,j,"f");eq(this,q,"f").params.messages.push({role:e,content:t})}let e=await eq(this,$,"m",B).call(this,eq(this,q,"f").params.messages.at(-1));if(e)eq(this,q,"f").params.messages.push(e);else if(!eq(this,O,"f"))break}}finally{t&&t.abort()}}if(!eq(this,j,"f"))throw new eU("ToolRunner concluded without a message from the server");eq(this,U,"f").resolve(await eq(this,j,"f"))}catch(e){throw eO(this,N,!1,"f"),eq(this,U,"f").promise.catch(()=>{}),eq(this,U,"f").reject(e),eO(this,U,t1(),"f"),e}}setMessagesParams(e){"function"==typeof e?eq(this,q,"f").params=e(eq(this,q,"f").params):eq(this,q,"f").params=e,eO(this,O,!0,"f"),eO(this,D,void 0,"f")}async generateToolResponse(){let e=await eq(this,j,"f")??this.params.messages.at(-1);return e?eq(this,$,"m",B).call(this,e):null}done(){return eq(this,U,"f").promise}async runUntilDone(){if(!eq(this,N,"f"))for await(let e of this);return this.done()}get params(){return eq(this,q,"f").params}pushMessages(...e){this.setMessagesParams(t=>({...t,messages:[...t.messages,...e]}))}then(e,t){return this.runUntilDone().then(e,t)}}async function t4(e,t=e.messages.at(-1)){if(!t||"assistant"!==t.role||!t.content||"string"==typeof t.content)return null;let s=t.content.filter(e=>"tool_use"===e.type);return 0===s.length?null:{role:"user",content:await Promise.all(s.map(async t=>{let s=e.tools.find(e=>("name"in e?e.name:e.mcp_server_name)===t.name);if(!s||!("run"in s))return{type:"tool_result",tool_use_id:t.id,content:`Error: Tool '${t.name}' not found`,is_error:!0};try{let e=t.input;"parse"in s&&s.parse&&(e=s.parse(e));let n=await s.run(e);return{type:"tool_result",tool_use_id:t.id,content:n}}catch(e){return{type:"tool_result",tool_use_id:t.id,content:`Error: ${e instanceof Error?e.message:String(e)}`,is_error:!0}}}))}}B=async function(e){return void 0!==eq(this,D,"f")||eO(this,D,t4(eq(this,q,"f").params,e),"f"),eq(this,D,"f")};class t5{constructor(e,t){this.iterator=e,this.controller=t}async *decoder(){let e=new ti;for await(let t of this.iterator)for(let s of e.decode(t))yield JSON.parse(s);for(let t of e.flush())yield JSON.parse(t)}[Symbol.asyncIterator](){return this.decoder()}static fromResponse(e,t){if(!e.body){if(t.abort(),void 0!==globalThis.navigator&&"ReactNative"===globalThis.navigator.product)throw new eU("The default react-native fetch implementation does not support streaming. Please use expo/fetch: https://docs.expo.dev/versions/latest/sdk/expo/#expofetch-api");throw new eU("Attempted to iterate over a response with no body")}return new t5(e7(e.body),t)}}class t3 extends tL{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/batches?beta=true",{body:n,...t,headers:tD([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},t?.headers])})}retrieve(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/messages/batches/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString()},s?.headers])})}list(e={},t){let{betas:s,...n}=e??{};return this._client.getAPIList("/v1/messages/batches?beta=true",tk,{query:n,...t,headers:tD([{"anthropic-beta":[...s??[],"message-batches-2024-09-24"].toString()},t?.headers])})}delete(e,t={},s){let{betas:n}=t??{};return this._client.delete(tF`/v1/messages/batches/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString()},s?.headers])})}cancel(e,t={},s){let{betas:n}=t??{};return this._client.post(tF`/v1/messages/batches/${e}/cancel?beta=true`,{...s,headers:tD([{"anthropic-beta":[...n??[],"message-batches-2024-09-24"].toString()},s?.headers])})}async results(e,t={},s){let n=await this.retrieve(e);if(!n.results_url)throw new eU(`No batch \`results_url\`; Has it finished processing? ${n.processing_status} - ${n.id}`);let{betas:i}=t??{};return this._client.get(n.results_url,{...s,headers:tD([{"anthropic-beta":[...i??[],"message-batches-2024-09-24"].toString(),Accept:"application/binary"},s?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((e,t)=>t5.fromResponse(t.response,t.controller))}}let t9={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};class t6 extends tL{constructor(){super(...arguments),this.batches=new t3(this._client)}create(e,t){let{betas:s,...n}=e;n.model in t9&&console.warn(`The model '${n.model}' is deprecated and will reach end-of-life on ${t9[n.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let i=this._client._options.timeout;if(!n.stream&&null==i){let e=tH[n.model]??void 0;i=this._client.calculateNonstreamingTimeout(n.max_tokens,e)}return this._client.post("/v1/messages?beta=true",{body:n,timeout:i??6e5,...t,headers:tD([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}parse(e,t){return t={...t,headers:tD([{"anthropic-beta":[...e.betas??[],"structured-outputs-2025-11-13"].toString()},t?.headers])},this.create(e,t).then(t=>tz(t,e,{logger:this._client.logger??console}))}stream(e,t){return tQ.createMessage(this,e,t)}countTokens(e,t){let{betas:s,...n}=e;return this._client.post("/v1/messages/count_tokens?beta=true",{body:n,...t,headers:tD([{"anthropic-beta":[...s??[],"token-counting-2024-11-01"].toString()},t?.headers])})}toolRunner(e,t){return new t2(this._client,e,t)}}t6.Batches=t3,t6.BetaToolRunner=t2;class t8 extends tL{create(e,t={},s){let{betas:n,...i}=t??{};return this._client.post(tF`/v1/skills/${e}/versions?beta=true`,tI({body:i,...s,headers:tD([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},s?.headers])},this._client))}retrieve(e,t,s){let{skill_id:n,betas:i}=t;return this._client.get(tF`/v1/skills/${n}/versions/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},s?.headers])})}list(e,t={},s){let{betas:n,...i}=t??{};return this._client.getAPIList(tF`/v1/skills/${e}/versions?beta=true`,tS,{query:i,...s,headers:tD([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},s?.headers])})}delete(e,t,s){let{skill_id:n,betas:i}=t;return this._client.delete(tF`/v1/skills/${n}/versions/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...i??[],"skills-2025-10-02"].toString()},s?.headers])})}}class t7 extends tL{constructor(){super(...arguments),this.versions=new t8(this._client)}create(e={},t){let{betas:s,...n}=e??{};return this._client.post("/v1/skills?beta=true",tI({body:n,...t,headers:tD([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},t?.headers])},this._client))}retrieve(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/skills/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},s?.headers])})}list(e={},t){let{betas:s,...n}=e??{};return this._client.getAPIList("/v1/skills?beta=true",tS,{query:n,...t,headers:tD([{"anthropic-beta":[...s??[],"skills-2025-10-02"].toString()},t?.headers])})}delete(e,t={},s){let{betas:n}=t??{};return this._client.delete(tF`/v1/skills/${e}?beta=true`,{...s,headers:tD([{"anthropic-beta":[...n??[],"skills-2025-10-02"].toString()},s?.headers])})}}t7.Versions=t8;class se extends tL{constructor(){super(...arguments),this.models=new tG(this._client),this.messages=new t6(this._client),this.files=new tB(this._client),this.skills=new t7(this._client)}}se.Models=tG,se.Messages=t6,se.Files=tB,se.Skills=t7;class st extends tL{create(e,t){let{betas:s,...n}=e;return this._client.post("/v1/complete",{body:n,timeout:this._client._options.timeout??6e5,...t,headers:tD([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},t?.headers]),stream:e.stream??!1})}}let ss="__json_buf";function sn(e){return"tool_use"===e.type||"server_tool_use"===e.type}class si{constructor(){G.add(this),this.messages=[],this.receivedMessages=[],H.set(this,void 0),this.controller=new AbortController,V.set(this,void 0),z.set(this,()=>{}),X.set(this,()=>{}),K.set(this,void 0),J.set(this,()=>{}),Y.set(this,()=>{}),Q.set(this,{}),Z.set(this,!1),ee.set(this,!1),et.set(this,!1),es.set(this,!1),en.set(this,void 0),ei.set(this,void 0),eo.set(this,e=>{if(eO(this,ee,!0,"f"),ej(e)&&(e=new eF),e instanceof eF)return eO(this,et,!0,"f"),this._emit("abort",e);if(e instanceof eU)return this._emit("error",e);if(e instanceof Error){let t=new eU(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new eU(String(e)))}),eO(this,V,new Promise((e,t)=>{eO(this,z,e,"f"),eO(this,X,t,"f")}),"f"),eO(this,K,new Promise((e,t)=>{eO(this,J,e,"f"),eO(this,Y,t,"f")}),"f"),eq(this,V,"f").catch(()=>{}),eq(this,K,"f").catch(()=>{})}get response(){return eq(this,en,"f")}get request_id(){return eq(this,ei,"f")}async withResponse(){eO(this,es,!0,"f");let e=await eq(this,V,"f");if(!e)throw Error("Could not resolve a `Response` object");return{data:this,response:e,request_id:e.headers.get("request-id")}}static fromReadableStream(e){let t=new si;return t._run(()=>t._fromReadableStream(e)),t}static createMessage(e,t,s){let n=new si;for(let e of t.messages)n._addMessageParam(e);return n._run(()=>n._createMessage(e,{...t,stream:!0},{...s,headers:{...s?.headers,"X-Stainless-Helper-Method":"stream"}})),n}_run(e){e().then(()=>{this._emitFinal(),this._emit("end")},eq(this,eo,"f"))}_addMessageParam(e){this.messages.push(e)}_addMessage(e,t=!0){this.receivedMessages.push(e),t&&this._emit("message",e)}async _createMessage(e,t,s){let n,i=s?.signal;i&&(i.aborted&&this.controller.abort(),n=this.controller.abort.bind(this.controller),i.addEventListener("abort",n));try{eq(this,G,"m",el).call(this);let{response:n,data:i}=await e.create({...t,stream:!0},{...s,signal:this.controller.signal}).withResponse();for await(let e of(this._connected(n),i))eq(this,G,"m",ec).call(this,e);if(i.controller.signal?.aborted)throw new eF;eq(this,G,"m",eu).call(this)}finally{i&&n&&i.removeEventListener("abort",n)}}_connected(e){this.ended||(eO(this,en,e,"f"),eO(this,ei,e?.headers.get("request-id"),"f"),eq(this,z,"f").call(this,e),this._emit("connect"))}get ended(){return eq(this,Z,"f")}get errored(){return eq(this,ee,"f")}get aborted(){return eq(this,et,"f")}abort(){this.controller.abort()}on(e,t){return(eq(this,Q,"f")[e]||(eq(this,Q,"f")[e]=[])).push({listener:t}),this}off(e,t){let s=eq(this,Q,"f")[e];if(!s)return this;let n=s.findIndex(e=>e.listener===t);return n>=0&&s.splice(n,1),this}once(e,t){return(eq(this,Q,"f")[e]||(eq(this,Q,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,s)=>{eO(this,es,!0,"f"),"error"!==e&&this.once("error",s),this.once(e,t)})}async done(){eO(this,es,!0,"f"),await eq(this,K,"f")}get currentMessage(){return eq(this,H,"f")}async finalMessage(){return await this.done(),eq(this,G,"m",ea).call(this)}async finalText(){return await this.done(),eq(this,G,"m",er).call(this)}_emit(e,...t){if(eq(this,Z,"f"))return;"end"===e&&(eO(this,Z,!0,"f"),eq(this,J,"f").call(this));let s=eq(this,Q,"f")[e];if(s&&(eq(this,Q,"f")[e]=s.filter(e=>!e.once),s.forEach(({listener:e})=>e(...t))),"abort"===e){let e=t[0];eq(this,es,"f")||s?.length||Promise.reject(e),eq(this,X,"f").call(this,e),eq(this,Y,"f").call(this,e),this._emit("end");return}if("error"===e){let e=t[0];eq(this,es,"f")||s?.length||Promise.reject(e),eq(this,X,"f").call(this,e),eq(this,Y,"f").call(this,e),this._emit("end")}}_emitFinal(){this.receivedMessages.at(-1)&&this._emit("finalMessage",eq(this,G,"m",ea).call(this))}async _fromReadableStream(e,t){let s,n=t?.signal;n&&(n.aborted&&this.controller.abort(),s=this.controller.abort.bind(this.controller),n.addEventListener("abort",s));try{eq(this,G,"m",el).call(this),this._connected(null);let t=th.fromReadableStream(e,this.controller);for await(let e of t)eq(this,G,"m",ec).call(this,e);if(t.controller.signal?.aborted)throw new eF;eq(this,G,"m",eu).call(this)}finally{n&&s&&n.removeEventListener("abort",s)}}[(H=new WeakMap,V=new WeakMap,z=new WeakMap,X=new WeakMap,K=new WeakMap,J=new WeakMap,Y=new WeakMap,Q=new WeakMap,Z=new WeakMap,ee=new WeakMap,et=new WeakMap,es=new WeakMap,en=new WeakMap,ei=new WeakMap,eo=new WeakMap,G=new WeakSet,ea=function(){if(0===this.receivedMessages.length)throw new eU("stream ended without producing a Message with role=assistant");return this.receivedMessages.at(-1)},er=function(){if(0===this.receivedMessages.length)throw new eU("stream ended without producing a Message with role=assistant");let e=this.receivedMessages.at(-1).content.filter(e=>"text"===e.type).map(e=>e.text);if(0===e.length)throw new eU("stream ended without producing a content block with type=text");return e.join(" ")},el=function(){this.ended||eO(this,H,void 0,"f")},ec=function(e){if(this.ended)return;let t=eq(this,G,"m",ed).call(this,e);switch(this._emit("streamEvent",e,t),e.type){case"content_block_delta":{let s=t.content.at(-1);switch(e.delta.type){case"text_delta":"text"===s.type&&this._emit("text",e.delta.text,s.text||"");break;case"citations_delta":"text"===s.type&&this._emit("citation",e.delta.citation,s.citations??[]);break;case"input_json_delta":sn(s)&&s.input&&this._emit("inputJson",e.delta.partial_json,s.input);break;case"thinking_delta":"thinking"===s.type&&this._emit("thinking",e.delta.thinking,s.thinking);break;case"signature_delta":"thinking"===s.type&&this._emit("signature",s.signature);break;default:sa(e.delta)}break}case"message_stop":this._addMessageParam(t),this._addMessage(t,!0);break;case"content_block_stop":this._emit("contentBlock",t.content.at(-1));break;case"message_start":eO(this,H,t,"f")}},eu=function(){if(this.ended)throw new eU("stream has ended, this shouldn't happen");let e=eq(this,H,"f");if(!e)throw new eU("request ended without sending any chunks");return eO(this,H,void 0,"f"),e},ed=function(e){let t=eq(this,H,"f");if("message_start"===e.type){if(t)throw new eU(`Unexpected event order, got ${e.type} before receiving "message_stop"`);return e.message}if(!t)throw new eU(`Unexpected event order, got ${e.type} before "message_start"`);switch(e.type){case"message_stop":case"content_block_stop":return t;case"message_delta":return t.stop_reason=e.delta.stop_reason,t.stop_sequence=e.delta.stop_sequence,t.usage.output_tokens=e.usage.output_tokens,null!=e.usage.input_tokens&&(t.usage.input_tokens=e.usage.input_tokens),null!=e.usage.cache_creation_input_tokens&&(t.usage.cache_creation_input_tokens=e.usage.cache_creation_input_tokens),null!=e.usage.cache_read_input_tokens&&(t.usage.cache_read_input_tokens=e.usage.cache_read_input_tokens),null!=e.usage.server_tool_use&&(t.usage.server_tool_use=e.usage.server_tool_use),t;case"content_block_start":return t.content.push({...e.content_block}),t;case"content_block_delta":{let s=t.content.at(e.index);switch(e.delta.type){case"text_delta":s?.type==="text"&&(t.content[e.index]={...s,text:(s.text||"")+e.delta.text});break;case"citations_delta":s?.type==="text"&&(t.content[e.index]={...s,citations:[...s.citations??[],e.delta.citation]});break;case"input_json_delta":if(s&&sn(s)){let n=s[ss]||"";n+=e.delta.partial_json;let i={...s};Object.defineProperty(i,ss,{value:n,enumerable:!1,writable:!0}),n&&(i.input=tK(n)),t.content[e.index]=i}break;case"thinking_delta":s?.type==="thinking"&&(t.content[e.index]={...s,thinking:s.thinking+e.delta.thinking});break;case"signature_delta":s?.type==="thinking"&&(t.content[e.index]={...s,signature:e.delta.signature});break;default:sa(e.delta)}return t}}},Symbol.asyncIterator)](){let e=[],t=[],s=!1;return this.on("streamEvent",s=>{let n=t.shift();n?n.resolve(s):e.push(s)}),this.on("end",()=>{for(let e of(s=!0,t))e.resolve(void 0);t.length=0}),this.on("abort",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),this.on("error",e=>{for(let n of(s=!0,t))n.reject(e);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:s?{value:void 0,done:!0}:new Promise((e,s)=>t.push({resolve:e,reject:s})).then(e=>e?{value:e,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new th(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function sa(e){}class sr extends tL{create(e,t){return this._client.post("/v1/messages/batches",{body:e,...t})}retrieve(e,t){return this._client.get(tF`/v1/messages/batches/${e}`,t)}list(e={},t){return this._client.getAPIList("/v1/messages/batches",tk,{query:e,...t})}delete(e,t){return this._client.delete(tF`/v1/messages/batches/${e}`,t)}cancel(e,t){return this._client.post(tF`/v1/messages/batches/${e}/cancel`,t)}async results(e,t){let s=await this.retrieve(e);if(!s.results_url)throw new eU(`No batch \`results_url\`; Has it finished processing? ${s.processing_status} - ${s.id}`);return this._client.get(s.results_url,{...t,headers:tD([{Accept:"application/binary"},t?.headers]),stream:!0,__binaryResponse:!0})._thenUnwrap((e,t)=>t5.fromResponse(t.response,t.controller))}}class so extends tL{constructor(){super(...arguments),this.batches=new sr(this._client)}create(e,t){e.model in sl&&console.warn(`The model '${e.model}' is deprecated and will reach end-of-life on ${sl[e.model]}
Please migrate to a newer model. Visit https://docs.anthropic.com/en/docs/resources/model-deprecations for more information.`);let s=this._client._options.timeout;if(!e.stream&&null==s){let t=tH[e.model]??void 0;s=this._client.calculateNonstreamingTimeout(e.max_tokens,t)}return this._client.post("/v1/messages",{body:e,timeout:s??6e5,...t,stream:e.stream??!1})}stream(e,t){return si.createMessage(this,e,t)}countTokens(e,t){return this._client.post("/v1/messages/count_tokens",{body:e,...t})}}let sl={"claude-1.3":"November 6th, 2024","claude-1.3-100k":"November 6th, 2024","claude-instant-1.1":"November 6th, 2024","claude-instant-1.1-100k":"November 6th, 2024","claude-instant-1.2":"November 6th, 2024","claude-3-sonnet-20240229":"July 21st, 2025","claude-3-opus-20240229":"January 5th, 2026","claude-2.1":"July 21st, 2025","claude-2.0":"July 21st, 2025","claude-3-7-sonnet-latest":"February 19th, 2026","claude-3-7-sonnet-20250219":"February 19th, 2026"};so.Batches=sr;class sc extends tL{retrieve(e,t={},s){let{betas:n}=t??{};return this._client.get(tF`/v1/models/${e}`,{...s,headers:tD([{...n?.toString()!=null?{"anthropic-beta":n?.toString()}:void 0},s?.headers])})}list(e={},t){let{betas:s,...n}=e??{};return this._client.getAPIList("/v1/models",tk,{query:n,...t,headers:tD([{...s?.toString()!=null?{"anthropic-beta":s?.toString()}:void 0},t?.headers])})}}let su=e=>void 0!==globalThis.process?globalThis.process.env?.[e]?.trim()??void 0:void 0!==globalThis.Deno?globalThis.Deno.env?.get?.(e)?.trim():void 0;class sd{constructor({baseURL:e=su("ANTHROPIC_BASE_URL"),apiKey:t=su("ANTHROPIC_API_KEY")??null,authToken:s=su("ANTHROPIC_AUTH_TOKEN")??null,...n}={}){ep.add(this),em.set(this,void 0);const i={apiKey:t,authToken:s,...n,baseURL:e||"https://api.anthropic.com"};i.dangerouslyAllowBrowser,this.baseURL=i.baseURL,this.timeout=i.timeout??eh.DEFAULT_TIMEOUT,this.logger=i.logger??console;const a="warn";this.logLevel=a,this.logLevel=tr(i.logLevel,"ClientOptions.logLevel",this)??tr(su("ANTHROPIC_LOG"),"process.env['ANTHROPIC_LOG']",this)??a,this.fetchOptions=i.fetchOptions,this.maxRetries=i.maxRetries??2,this.fetch=i.fetch??function(){if("undefined"!=typeof fetch)return fetch;throw Error("`fetch` is not defined as a global; Either pass `fetch` to the client, `new Anthropic({ fetch })` or polyfill the global, `globalThis.fetch = fetch`")}(),eO(this,em,tt,"f"),this._options=i,this.apiKey="string"==typeof t?t:null,this.authToken=s}withOptions(e){return new this.constructor({...this._options,baseURL:this.baseURL,maxRetries:this.maxRetries,timeout:this.timeout,logger:this.logger,logLevel:this.logLevel,fetch:this.fetch,fetchOptions:this.fetchOptions,apiKey:this.apiKey,authToken:this.authToken,...e})}defaultQuery(){return this._options.defaultQuery}validateHeaders({values:e,nulls:t}){if(!(e.get("x-api-key")||e.get("authorization")||this.apiKey&&e.get("x-api-key")||t.has("x-api-key")||this.authToken&&e.get("authorization"))&&!t.has("authorization"))throw Error('Could not resolve authentication method. Expected either apiKey or authToken to be set. Or for one of the "X-Api-Key" or "Authorization" headers to be explicitly omitted')}async authHeaders(e){return tD([await this.apiKeyAuth(e),await this.bearerAuth(e)])}async apiKeyAuth(e){if(null!=this.apiKey)return tD([{"X-Api-Key":this.apiKey}])}async bearerAuth(e){if(null!=this.authToken)return tD([{Authorization:`Bearer ${this.authToken}`}])}stringifyQuery(e){return Object.entries(e).filter(([e,t])=>void 0!==t).map(([e,t])=>{if("string"==typeof t||"number"==typeof t||"boolean"==typeof t)return`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if(null===t)return`${encodeURIComponent(e)}=`;throw new eU(`Cannot stringify type ${typeof t}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}getUserAgent(){return`${this.constructor.name}/JS ${e5}`}defaultIdempotencyKey(){return`stainless-node-retry-${eL()}`}makeStatusError(e,t,s,n){return eW.generate(e,t,s,n)}buildURL(e,t,s){let n=!eq(this,ep,"m",eg).call(this)&&s||this.baseURL,i=new URL(eZ.test(e)?e:n+(n.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return!function(e){if(!e)return!0;for(let t in e)return!1;return!0}(a)&&(t={...a,...t}),"object"==typeof t&&t&&!Array.isArray(t)&&(i.search=this.stringifyQuery(t)),i.toString()}_calculateNonstreamingTimeout(e){if(3600*e/128e3>600)throw new eU("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#streaming-responses for more details");return 6e5}async prepareOptions(e){}async prepareRequest(e,{url:t,options:s}){}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,s){return this.request(Promise.resolve(s).then(s=>({method:e,path:t,...s})))}request(e,t=null){return new tw(this,this.makeRequest(e,t,void 0))}async makeRequest(e,t,s){let n=await e,i=n.maxRetries??this.maxRetries;null==t&&(t=i),await this.prepareOptions(n);let{req:a,url:r,timeout:o}=await this.buildRequest(n,{retryCount:i-t});await this.prepareRequest(a,{url:r,options:n});let l="log_"+(0x1000000*Math.random()|0).toString(16).padStart(6,"0"),c=void 0===s?"":`, retryOf: ${s}`,u=Date.now();if(td(this).debug(`[${l}] sending request`,tp({retryOfRequestLogID:s,method:n.method,url:r,options:n,headers:a.headers})),n.signal?.aborted)throw new eF;let d=new AbortController,p=await this.fetchWithTimeout(r,a,o,d).catch(eD),h=Date.now();if(p instanceof globalThis.Error){let e=`retrying, ${t} attempts remaining`;if(n.signal?.aborted)throw new eF;let i=ej(p)||/timed? ?out/i.test(String(p)+("cause"in p?String(p.cause):""));if(t)return td(this).info(`[${l}] connection ${i?"timed out":"failed"} - ${e}`),td(this).debug(`[${l}] connection ${i?"timed out":"failed"} (${e})`,tp({retryOfRequestLogID:s,url:r,durationMs:h-u,message:p.message})),this.retryRequest(n,t,s??l);if(td(this).info(`[${l}] connection ${i?"timed out":"failed"} - error; no more retries left`),td(this).debug(`[${l}] connection ${i?"timed out":"failed"} (error; no more retries left)`,tp({retryOfRequestLogID:s,url:r,durationMs:h-u,message:p.message})),i)throw new eG;throw new eB({cause:p})}let m=[...p.headers.entries()].filter(([e])=>"request-id"===e).map(([e,t])=>", "+e+": "+JSON.stringify(t)).join(""),g=`[${l}${c}${m}] ${a.method} ${r} ${p.ok?"succeeded":"failed"} with status ${p.status} in ${h-u}ms`;if(!p.ok){let e=await this.shouldRetry(p);if(t&&e){let e=`retrying, ${t} attempts remaining`;return await te(p.body),td(this).info(`${g} - ${e}`),td(this).debug(`[${l}] response error (${e})`,tp({retryOfRequestLogID:s,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),this.retryRequest(n,t,s??l,p.headers)}let i=e?"error; no more retries left":"error; not retryable";td(this).info(`${g} - ${i}`);let a=await p.text().catch(e=>eD(e).message),r=e4(a),o=r?void 0:a;throw td(this).debug(`[${l}] response error (${i})`,tp({retryOfRequestLogID:s,url:p.url,status:p.status,headers:p.headers,message:o,durationMs:Date.now()-u})),this.makeStatusError(p.status,r,o,p.headers)}return td(this).info(g),td(this).debug(`[${l}] response start`,tp({retryOfRequestLogID:s,url:p.url,status:p.status,headers:p.headers,durationMs:h-u})),{response:p,options:n,controller:d,requestLogID:l,retryOfRequestLogID:s,startTime:u}}getAPIList(e,t,s){return this.requestAPIList(t,{method:"get",path:e,...s})}requestAPIList(e,t){return new tv(this,this.makeRequest(t,null,void 0),e)}async fetchWithTimeout(e,t,s,n){let{signal:i,method:a,...r}=t||{};i&&i.addEventListener("abort",()=>n.abort());let o=setTimeout(()=>n.abort(),s),l=globalThis.ReadableStream&&r.body instanceof globalThis.ReadableStream||"object"==typeof r.body&&null!==r.body&&Symbol.asyncIterator in r.body,c={signal:n.signal,...l?{duplex:"half"}:{},method:"GET",...r};a&&(c.method=a.toUpperCase());try{return await this.fetch.call(void 0,e,c)}finally{clearTimeout(o)}}async shouldRetry(e){let t=e.headers.get("x-should-retry");return"true"===t||"false"!==t&&(408===e.status||409===e.status||429===e.status||!!(e.status>=500))}async retryRequest(e,t,s,n){let i,a,r=n?.get("retry-after-ms");if(r){let e=parseFloat(r);Number.isNaN(e)||(i=e)}let o=n?.get("retry-after");if(o&&!i){let e=parseFloat(o);i=Number.isNaN(e)?Date.parse(o)-Date.now():1e3*e}if(!(i&&0<=i&&i<6e4)){let s=e.maxRetries??this.maxRetries;i=this.calculateDefaultRetryTimeoutMillis(t,s)}return await (a=i,new Promise(e=>setTimeout(e,a))),this.makeRequest(e,t-1,s)}calculateDefaultRetryTimeoutMillis(e,t){return Math.min(.5*Math.pow(2,t-e),8)*(1-.25*Math.random())*1e3}calculateNonstreamingTimeout(e,t){if(36e5*e/128e3>6e5||null!=t&&e>t)throw new eU("Streaming is required for operations that may take longer than 10 minutes. See https://github.com/anthropics/anthropic-sdk-typescript#long-requests for more details");return 6e5}async buildRequest(e,{retryCount:t=0}={}){let s={...e},{method:n,path:i,query:a,defaultBaseURL:r}=s,o=this.buildURL(i,a,r);"timeout"in s&&((e,t)=>{if("number"!=typeof t||!Number.isInteger(t))throw new eU(`${e} must be an integer`);if(t<0)throw new eU(`${e} must be a positive integer`)})("timeout",s.timeout),s.timeout=s.timeout??this.timeout;let{bodyHeaders:l,body:c}=this.buildBody({options:s}),u=await this.buildHeaders({options:e,method:n,bodyHeaders:l,retryCount:t});return{req:{method:n,headers:u,...s.signal&&{signal:s.signal},...globalThis.ReadableStream&&c instanceof globalThis.ReadableStream&&{duplex:"half"},...c&&{body:c},...this.fetchOptions??{},...s.fetchOptions??{}},url:o,timeout:s.timeout}}async buildHeaders({options:e,method:s,bodyHeaders:n,retryCount:i}){let a={};this.idempotencyHeader&&"get"!==s&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);let r=tD([a,{Accept:"application/json","User-Agent":this.getUserAgent(),"X-Stainless-Retry-Count":String(i),...e.timeout?{"X-Stainless-Timeout":String(Math.trunc(e.timeout/1e3))}:{},...t??(t=(()=>{let e="undefined"!=typeof Deno&&null!=Deno.build?"deno":"undefined"!=typeof EdgeRuntime?"edge":"[object process]"===Object.prototype.toString.call(void 0!==globalThis.process?globalThis.process:0)?"node":"unknown";if("deno"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e5,"X-Stainless-OS":e9(Deno.build.os),"X-Stainless-Arch":e3(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":"string"==typeof Deno.version?Deno.version:Deno.version?.deno??"unknown"};if("undefined"!=typeof EdgeRuntime)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e5,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":globalThis.process.version};if("node"===e)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e5,"X-Stainless-OS":e9(globalThis.process.platform??"unknown"),"X-Stainless-Arch":e3(globalThis.process.arch??"unknown"),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":globalThis.process.version??"unknown"};let t=function(){if("undefined"==typeof navigator||!navigator)return null;for(let{key:e,pattern:t}of[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}]){let s=t.exec(navigator.userAgent);if(s){let t=s[1]||0,n=s[2]||0,i=s[3]||0;return{browser:e,version:`${t}.${n}.${i}`}}}return null}();return t?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e5,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${t.browser}`,"X-Stainless-Runtime-Version":t.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":e5,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}})()),...this._options.dangerouslyAllowBrowser?{"anthropic-dangerous-direct-browser-access":"true"}:void 0,"anthropic-version":"2023-06-01"},await this.authHeaders(e),this._options.defaultHeaders,n,e.headers]);return this.validateHeaders(r),r.values}buildBody({options:{body:e,headers:t}}){if(!e)return{bodyHeaders:void 0,body:void 0};let s=tD([t]);return ArrayBuffer.isView(e)||e instanceof ArrayBuffer||e instanceof DataView||"string"==typeof e&&s.values.has("content-type")||globalThis.Blob&&e instanceof globalThis.Blob||e instanceof FormData||e instanceof URLSearchParams||globalThis.ReadableStream&&e instanceof globalThis.ReadableStream?{bodyHeaders:void 0,body:e}:"object"==typeof e&&(Symbol.asyncIterator in e||Symbol.iterator in e&&"next"in e&&"function"==typeof e.next)?{bodyHeaders:void 0,body:e8(e)}:eq(this,em,"f").call(this,{body:e,headers:s})}}eh=sd,em=new WeakMap,ep=new WeakSet,eg=function(){return"https://api.anthropic.com"!==this.baseURL},sd.Anthropic=eh,sd.HUMAN_PROMPT="\\n\\nHuman:",sd.AI_PROMPT="\\n\\nAssistant:",sd.DEFAULT_TIMEOUT=6e5,sd.AnthropicError=eU,sd.APIError=eW,sd.APIConnectionError=eB,sd.APIConnectionTimeoutError=eG,sd.APIUserAbortError=eF,sd.NotFoundError=eX,sd.ConflictError=eK,sd.RateLimitError=eY,sd.BadRequestError=eH,sd.AuthenticationError=eV,sd.InternalServerError=eQ,sd.PermissionDeniedError=ez,sd.UnprocessableEntityError=eJ,sd.toFile=tO;class sp extends sd{constructor(){super(...arguments),this.completions=new st(this),this.messages=new so(this),this.models=new sc(this),this.beta=new se(this)}}sp.Completions=st,sp.Messages=so,sp.Models=sc,sp.Beta=se;var sh=e.i(89660);let sm=BigInt(0x100000000-1),sg=BigInt(32);function sf(e,t=""){if(!Number.isSafeInteger(e)||e<0){let s=t&&`"${t}" `;throw Error(`${s}expected integer >= 0, got ${e}`)}}function sy(e,t,s=""){let n=e instanceof Uint8Array||ArrayBuffer.isView(e)&&"Uint8Array"===e.constructor.name,i=e?.length,a=void 0!==t;if(!n||a&&i!==t)throw Error((s&&`"${s}" `)+"expected Uint8Array"+(a?` of length ${t}`:"")+", got "+(n?`length=${i}`:`type=${typeof e}`));return e}function sb(e,t=!0){if(e.destroyed)throw Error("Hash instance has been destroyed");if(t&&e.finished)throw Error("Hash#digest() has already been called")}function sw(...e){for(let t=0;t<e.length;t++)e[t].fill(0)}let s_=68===new Uint8Array(new Uint32Array([0x11223344]).buffer)[0]?e=>e:function(e){for(let s=0;s<e.length;s++){var t;e[s]=(t=e[s])<<24&0xff000000|t<<8&0xff0000|t>>>8&65280|t>>>24&255}return e},sv=BigInt(0),sk=BigInt(1),sS=BigInt(2),sA=BigInt(7),sC=BigInt(256),sP=BigInt(113),sR=[],sI=[],sE=[];for(let e=0,t=sk,s=1,n=0;e<24;e++){[s,n]=[n,(2*s+3*n)%5],sR.push(2*(5*n+s)),sI.push((e+1)*(e+2)/2%64);let i=sv;for(let e=0;e<7;e++)(t=(t<<sk^(t>>sA)*sP)%sC)&sS&&(i^=sk<<(sk<<BigInt(e))-sk);sE.push(i)}let sx=function(e,t=!1){let s=e.length,n=new Uint32Array(s),i=new Uint32Array(s);for(let a=0;a<s;a++){let{h:s,l:r}=function(e,t=!1){return t?{h:Number(e&sm),l:Number(e>>sg&sm)}:{h:0|Number(e>>sg&sm),l:0|Number(e&sm)}}(e[a],t);[n[a],i[a]]=[s,r]}return[n,i]}(sE,!0),sM=sx[0],sT=sx[1],s$=(e,t,s)=>s>32?t<<s-32|e>>>64-s:e<<s|t>>>32-s,sN=(e,t,s)=>s>32?e<<s-32|t>>>64-s:t<<s|e>>>32-s;class sO{state;pos=0;posOut=0;finished=!1;state32;destroyed=!1;blockLen;suffix;outputLen;enableXOF=!1;rounds;constructor(e,t,s,n=!1,i=24){if(this.blockLen=e,this.suffix=t,this.outputLen=s,this.enableXOF=n,this.rounds=i,sf(s,"outputLen"),!(0<e&&e<200))throw Error("only keccak-f1600 function is supported");this.state=new Uint8Array(200),this.state32=function(e){return new Uint32Array(e.buffer,e.byteOffset,Math.floor(e.byteLength/4))}(this.state)}clone(){return this._cloneInto()}keccak(){s_(this.state32),function(e,t=24){let s=new Uint32Array(10);for(let n=24-t;n<24;n++){for(let t=0;t<10;t++)s[t]=e[t]^e[t+10]^e[t+20]^e[t+30]^e[t+40];for(let t=0;t<10;t+=2){let n=(t+8)%10,i=(t+2)%10,a=s[i],r=s[i+1],o=s$(a,r,1)^s[n],l=sN(a,r,1)^s[n+1];for(let s=0;s<50;s+=10)e[t+s]^=o,e[t+s+1]^=l}let t=e[2],i=e[3];for(let s=0;s<24;s++){let n=sI[s],a=s$(t,i,n),r=sN(t,i,n),o=sR[s];t=e[o],i=e[o+1],e[o]=a,e[o+1]=r}for(let t=0;t<50;t+=10){for(let n=0;n<10;n++)s[n]=e[t+n];for(let n=0;n<10;n++)e[t+n]^=~s[(n+2)%10]&s[(n+4)%10]}e[0]^=sM[n],e[1]^=sT[n]}sw(s)}(this.state32,this.rounds),s_(this.state32),this.posOut=0,this.pos=0}update(e){sb(this),sy(e);let{blockLen:t,state:s}=this,n=e.length;for(let i=0;i<n;){let a=Math.min(t-this.pos,n-i);for(let t=0;t<a;t++)s[this.pos++]^=e[i++];this.pos===t&&this.keccak()}return this}finish(){if(this.finished)return;this.finished=!0;let{state:e,suffix:t,pos:s,blockLen:n}=this;e[s]^=t,(128&t)!=0&&s===n-1&&this.keccak(),e[n-1]^=128,this.keccak()}writeInto(e){sb(this,!1),sy(e),this.finish();let t=this.state,{blockLen:s}=this;for(let n=0,i=e.length;n<i;){this.posOut>=s&&this.keccak();let a=Math.min(s-this.posOut,i-n);e.set(t.subarray(this.posOut,this.posOut+a),n),this.posOut+=a,n+=a}return e}xofInto(e){if(!this.enableXOF)throw Error("XOF is not possible for this instance");return this.writeInto(e)}xof(e){return sf(e),this.xofInto(new Uint8Array(e))}digestInto(e){sy(e,void 0,"digestInto() output");let t=this.outputLen;if(e.length<t)throw Error('"digestInto() output" expected to be of length >='+t);if(this.finished)throw Error("digest() was already called");return this.writeInto(e),this.destroy(),e}digest(){return this.digestInto(new Uint8Array(this.outputLen))}destroy(){this.destroyed=!0,sw(this.state)}_cloneInto(e){let{blockLen:t,suffix:s,outputLen:n,rounds:i,enableXOF:a}=this;return(e||=new sO(t,s,n,a,i)).state32.set(this.state32),e.pos=this.pos,e.posOut=this.posOut,e.finished=this.finished,e.rounds=i,e.suffix=s,e.outputLen=n,e.enableXOF=a,e.destroyed=this.destroyed,e}}let sq=((e,t,s,n={})=>(function(e,t={}){let s=(t,s)=>e(s).update(t).digest(),n=e(void 0);return s.outputLen=n.outputLen,s.blockLen=n.blockLen,s.create=t=>e(t),Object.assign(s,t),Object.freeze(s)})(()=>new sO(t,e,s),n))(6,72,64,{oid:Uint8Array.from([6,9,96,134,72,1,101,3,4,2,10])});var sL=/^-?(?:\d+(?:\.\d*)?|\.\d+)(?:e[+-]?\d+)?$/i,sj=Math.ceil,sD=Math.floor,sU="[BigNumber Error] ",sW=sU+"Number primitive has more than 15 significant digits: ",sF=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10,1e11,1e12,1e13];function sB(e){var t=0|e;return e>0||e===t?t:t-1}function sG(e){for(var t,s,n=1,i=e.length,a=e[0]+"";n<i;){for(s=14-(t=e[n++]+"").length;s--;t="0"+t);a+=t}for(i=a.length;48===a.charCodeAt(--i););return a.slice(0,i+1||1)}function sH(e,t){var s,n,i=e.c,a=t.c,r=e.s,o=t.s,l=e.e,c=t.e;if(!r||!o)return null;if(s=i&&!i[0],n=a&&!a[0],s||n)return s?n?0:-o:r;if(r!=o)return r;if(s=r<0,n=l==c,!i||!a)return n?0:!i^s?1:-1;if(!n)return l>c^s?1:-1;for(r=0,o=(l=i.length)<(c=a.length)?l:c;r<o;r++)if(i[r]!=a[r])return i[r]>a[r]^s?1:-1;return l==c?0:l>c^s?1:-1}function sV(e,t,s,n){if(e<t||e>s||e!==sD(e))throw Error(sU+(n||"Argument")+("number"==typeof e?e<t||e>s?" out of range: ":" not an integer: ":" not a primitive number: ")+String(e))}function sz(e){var t=e.c.length-1;return sB(e.e/14)==t&&e.c[t]%2!=0}function sX(e,t){return(e.length>1?e.charAt(0)+"."+e.slice(1):e)+(t<0?"e":"e+")+t}function sK(e,t,s){var n,i;if(t<0){for(i=s+".";++t;i+=s);e=i+e}else if(n=e.length,++t>n){for(i=s,t-=n;--t;i+=s);e+=i}else t<n&&(e=e.slice(0,t)+"."+e.slice(t));return e}var sJ=function e(t){var s,n,i,a,r,o,l,c,u,d=C.prototype={constructor:C,toString:null,valueOf:null},p=new C(1),h=20,m=4,g=-7,f=21,y=-1e7,b=1e7,w=!1,_=1,v=0,k={prefix:"",groupSize:3,secondaryGroupSize:0,groupSeparator:",",decimalSeparator:".",fractionGroupSize:0,fractionGroupSeparator:"Â ",suffix:""},S="0123456789abcdefghijklmnopqrstuvwxyz",A=!0;function C(e,t){var s,n,i,a,r,o,l,d,p=this;if(!(p instanceof C))return new C(e,t);if(null==t){if(e&&!0===e._isBigNumber){p.s=e.s,!e.c||e.e>b?p.c=p.e=null:e.e<y?p.c=[p.e=0]:(p.e=e.e,p.c=e.c.slice());return}if((o="number"==typeof e)&&0*e==0){if(p.s=1/e<0?(e=-e,-1):1,e===~~e){for(a=0,r=e;r>=10;r/=10,a++);a>b?p.c=p.e=null:(p.e=a,p.c=[e]);return}d=String(e)}else{if(!sL.test(d=String(e)))return u(p,d,o);p.s=45==d.charCodeAt(0)?(d=d.slice(1),-1):1}(a=d.indexOf("."))>-1&&(d=d.replace(".","")),(r=d.search(/e/i))>0?(a<0&&(a=r),a+=+d.slice(r+1),d=d.substring(0,r)):a<0&&(a=d.length)}else{if(sV(t,2,S.length,"Base"),10==t&&A)return E(p=new C(e),h+p.e+1,m);if(d=String(e),o="number"==typeof e){if(0*e!=0)return u(p,d,o,t);if(p.s=1/e<0?(d=d.slice(1),-1):1,C.DEBUG&&d.replace(/^0\.0*|\./,"").length>15)throw Error(sW+e)}else p.s=45===d.charCodeAt(0)?(d=d.slice(1),-1):1;for(s=S.slice(0,t),a=r=0,l=d.length;r<l;r++)if(0>s.indexOf(n=d.charAt(r))){if("."==n){if(r>a){a=l;continue}}else if(!i&&(d==d.toUpperCase()&&(d=d.toLowerCase())||d==d.toLowerCase()&&(d=d.toUpperCase()))){i=!0,r=-1,a=0;continue}return u(p,String(e),o,t)}o=!1,(a=(d=c(d,t,10,p.s)).indexOf("."))>-1?d=d.replace(".",""):a=d.length}for(r=0;48===d.charCodeAt(r);r++);for(l=d.length;48===d.charCodeAt(--l););if(d=d.slice(r,++l)){if(l-=r,o&&C.DEBUG&&l>15&&(e>0x1fffffffffffff||e!==sD(e)))throw Error(sW+p.s*e);if((a=a-r-1)>b)p.c=p.e=null;else if(a<y)p.c=[p.e=0];else{if(p.e=a,p.c=[],r=(a+1)%14,a<0&&(r+=14),r<l){for(r&&p.c.push(+d.slice(0,r)),l-=14;r<l;)p.c.push(+d.slice(r,r+=14));r=14-(d=d.slice(r)).length}else r-=l;for(;r--;d+="0");p.c.push(+d)}}else p.c=[p.e=0]}function P(e,t,s,n){var i,a,r,o,l;if(null==s?s=m:sV(s,0,8),!e.c)return e.toString();if(i=e.c[0],r=e.e,null==t)l=sG(e.c),l=1==n||2==n&&(r<=g||r>=f)?sX(l,r):sK(l,r,"0");else if(a=(e=E(new C(e),t,s)).e,o=(l=sG(e.c)).length,1==n||2==n&&(t<=a||a<=g)){for(;o<t;l+="0",o++);l=sX(l,a)}else if(t-=r+(2===n&&a>r),l=sK(l,a,"0"),a+1>o){if(--t>0)for(l+=".";t--;l+="0");}else if((t+=a-o)>0)for(a+1==o&&(l+=".");t--;l+="0");return e.s<0&&i?"-"+l:l}function R(e,t){for(var s,n,i=1,a=new C(e[0]);i<e.length;i++)(n=new C(e[i])).s&&(s=sH(a,n))!==t&&(0!==s||a.s!==t)||(a=n);return a}function I(e,t,s){for(var n=1,i=t.length;!t[--i];t.pop());for(i=t[0];i>=10;i/=10,n++);return(s=n+14*s-1)>b?e.c=e.e=null:s<y?e.c=[e.e=0]:(e.e=s,e.c=t),e}function E(e,t,s,n){var i,a,r,o,l,c,u,d=e.c;if(d){e:{for(i=1,o=d[0];o>=10;o/=10,i++);if((a=t-i)<0)a+=14,r=t,u=sD((l=d[c=0])/sF[i-r-1]%10);else if((c=sj((a+1)/14))>=d.length)if(n){for(;d.length<=c;d.push(0));l=u=0,i=1,a%=14,r=a-14+1}else break e;else{for(i=1,l=o=d[c];o>=10;o/=10,i++);a%=14,u=(r=a-14+i)<0?0:sD(l/sF[i-r-1]%10)}if(n=n||t<0||null!=d[c+1]||(r<0?l:l%sF[i-r-1]),n=s<4?(u||n)&&(0==s||s==(e.s<0?3:2)):u>5||5==u&&(4==s||n||6==s&&(a>0?r>0?l/sF[i-r]:0:d[c-1])%10&1||s==(e.s<0?8:7)),t<1||!d[0])return d.length=0,n?(t-=e.e+1,d[0]=sF[(14-t%14)%14],e.e=-t||0):d[0]=e.e=0,e;if(0==a?(d.length=c,o=1,c--):(d.length=c+1,o=sF[14-a],d[c]=r>0?sD(l/sF[i-r]%sF[r])*o:0),n)for(;;)if(0==c){for(a=1,r=d[0];r>=10;r/=10,a++);for(r=d[0]+=o,o=1;r>=10;r/=10,o++);a!=o&&(e.e++,1e14==d[0]&&(d[0]=1));break}else{if(d[c]+=o,1e14!=d[c])break;d[c--]=0,o=1}for(a=d.length;0===d[--a];d.pop());}e.e>b?e.c=e.e=null:e.e<y&&(e.c=[e.e=0])}return e}function x(e){var t,s=e.e;return null===s?e.toString():(t=sG(e.c),t=s<=g||s>=f?sX(t,s):sK(t,s,"0"),e.s<0?"-"+t:t)}return C.clone=e,C.ROUND_UP=0,C.ROUND_DOWN=1,C.ROUND_CEIL=2,C.ROUND_FLOOR=3,C.ROUND_HALF_UP=4,C.ROUND_HALF_DOWN=5,C.ROUND_HALF_EVEN=6,C.ROUND_HALF_CEIL=7,C.ROUND_HALF_FLOOR=8,C.EUCLID=9,C.config=C.set=function(e){var t,s;if(null!=e)if("object"==typeof e){if(e.hasOwnProperty(t="DECIMAL_PLACES")&&(sV(s=e[t],0,1e9,t),h=s),e.hasOwnProperty(t="ROUNDING_MODE")&&(sV(s=e[t],0,8,t),m=s),e.hasOwnProperty(t="EXPONENTIAL_AT")&&((s=e[t])&&s.pop?(sV(s[0],-1e9,0,t),sV(s[1],0,1e9,t),g=s[0],f=s[1]):(sV(s,-1e9,1e9,t),g=-(f=s<0?-s:s))),e.hasOwnProperty(t="RANGE"))if((s=e[t])&&s.pop)sV(s[0],-1e9,-1,t),sV(s[1],1,1e9,t),y=s[0],b=s[1];else if(sV(s,-1e9,1e9,t),s)y=-(b=s<0?-s:s);else throw Error(sU+t+" cannot be zero: "+s);if(e.hasOwnProperty(t="CRYPTO"))if(!!(s=e[t])===s)if(s)if("undefined"!=typeof crypto&&crypto&&(crypto.getRandomValues||crypto.randomBytes))w=s;else throw w=!s,Error(sU+"crypto unavailable");else w=s;else throw Error(sU+t+" not true or false: "+s);if(e.hasOwnProperty(t="MODULO_MODE")&&(sV(s=e[t],0,9,t),_=s),e.hasOwnProperty(t="POW_PRECISION")&&(sV(s=e[t],0,1e9,t),v=s),e.hasOwnProperty(t="FORMAT"))if("object"==typeof(s=e[t]))k=s;else throw Error(sU+t+" not an object: "+s);if(e.hasOwnProperty(t="ALPHABET")){if("string"!=typeof(s=e[t])||/^.?$|[+\-.\s]|(.).*\1/.test(s))throw Error(sU+t+" invalid: "+s);A="0123456789"==s.slice(0,10),S=s}}else throw Error(sU+"Object expected: "+e);return{DECIMAL_PLACES:h,ROUNDING_MODE:m,EXPONENTIAL_AT:[g,f],RANGE:[y,b],CRYPTO:w,MODULO_MODE:_,POW_PRECISION:v,FORMAT:k,ALPHABET:S}},C.isBigNumber=function(e){if(!e||!0!==e._isBigNumber)return!1;if(!C.DEBUG)return!0;var t,s,n=e.c,i=e.e,a=e.s;e:if("[object Array]"==({}).toString.call(n)){if((1===a||-1===a)&&i>=-1e9&&i<=1e9&&i===sD(i)){if(0===n[0]){if(0===i&&1===n.length)return!0;break e}if((t=(i+1)%14)<1&&(t+=14),String(n[0]).length==t){for(t=0;t<n.length;t++)if((s=n[t])<0||s>=1e14||s!==sD(s))break e;if(0!==s)return!0}}}else if(null===n&&null===i&&(null===a||1===a||-1===a))return!0;throw Error(sU+"Invalid BigNumber: "+e)},C.maximum=C.max=function(){return R(arguments,-1)},C.minimum=C.min=function(){return R(arguments,1)},s=0x20000000000000*Math.random()&2097151?function(){return sD(0x20000000000000*Math.random())}:function(){return(0x40000000*Math.random()|0)*8388608+(8388608*Math.random()|0)},C.random=function(e){var t,n,i,a,r,o=0,l=[],c=new C(p);if(null==e?e=h:sV(e,0,1e9),a=sj(e/14),w)if(crypto.getRandomValues){for(t=crypto.getRandomValues(new Uint32Array(a*=2));o<a;)(r=131072*t[o]+(t[o+1]>>>11))>=9e15?(n=crypto.getRandomValues(new Uint32Array(2)),t[o]=n[0],t[o+1]=n[1]):(l.push(r%1e14),o+=2);o=a/2}else if(crypto.randomBytes){for(t=crypto.randomBytes(a*=7);o<a;)(r=(31&t[o])*0x1000000000000+0x10000000000*t[o+1]+0x100000000*t[o+2]+0x1000000*t[o+3]+(t[o+4]<<16)+(t[o+5]<<8)+t[o+6])>=9e15?crypto.randomBytes(7).copy(t,o):(l.push(r%1e14),o+=7);o=a/7}else throw w=!1,Error(sU+"crypto unavailable");if(!w)for(;o<a;)(r=s())<9e15&&(l[o++]=r%1e14);for(a=l[--o],e%=14,a&&e&&(r=sF[14-e],l[o]=sD(a/r)*r);0===l[o];l.pop(),o--);if(o<0)l=[i=0];else{for(i=-1;0===l[0];l.splice(0,1),i-=14);for(o=1,r=l[0];r>=10;r/=10,o++);o<14&&(i-=14-o)}return c.e=i,c.c=l,c},C.sum=function(){for(var e=1,t=arguments,s=new C(t[0]);e<t.length;)s=s.plus(t[e++]);return s},c=function(){var e="0123456789";function t(e,t,s,n){for(var i,a,r=[0],o=0,l=e.length;o<l;){for(a=r.length;a--;r[a]*=t);for(r[0]+=n.indexOf(e.charAt(o++)),i=0;i<r.length;i++)r[i]>s-1&&(null==r[i+1]&&(r[i+1]=0),r[i+1]+=r[i]/s|0,r[i]%=s)}return r.reverse()}return function(s,n,i,a,r){var o,c,u,d,p,g,f,y,b=s.indexOf("."),w=h,_=m;for(b>=0&&(d=v,v=0,s=s.replace(".",""),g=(y=new C(n)).pow(s.length-b),v=d,y.c=t(sK(sG(g.c),g.e,"0"),10,i,e),y.e=y.c.length),u=d=(f=t(s,n,i,r?(o=S,e):(o=e,S))).length;0==f[--d];f.pop());if(!f[0])return o.charAt(0);if(b<0?--u:(g.c=f,g.e=u,g.s=a,f=(g=l(g,y,w,_,i)).c,p=g.r,u=g.e),b=f[c=u+w+1],d=i/2,p=p||c<0||null!=f[c+1],p=_<4?(null!=b||p)&&(0==_||_==(g.s<0?3:2)):b>d||b==d&&(4==_||p||6==_&&1&f[c-1]||_==(g.s<0?8:7)),c<1||!f[0])s=p?sK(o.charAt(1),-w,o.charAt(0)):o.charAt(0);else{if(f.length=c,p)for(--i;++f[--c]>i;)f[c]=0,c||(++u,f=[1].concat(f));for(d=f.length;!f[--d];);for(b=0,s="";b<=d;s+=o.charAt(f[b++]));s=sK(s,u,o.charAt(0))}return s}}(),l=function(){function e(e,t,s){var n,i,a,r,o=0,l=e.length,c=t%1e7,u=t/1e7|0;for(e=e.slice();l--;)n=u*(a=e[l]%1e7)+(r=e[l]/1e7|0)*c,o=((i=c*a+n%1e7*1e7+o)/s|0)+(n/1e7|0)+u*r,e[l]=i%s;return o&&(e=[o].concat(e)),e}function t(e,t,s,n){var i,a;if(s!=n)a=s>n?1:-1;else for(i=a=0;i<s;i++)if(e[i]!=t[i]){a=e[i]>t[i]?1:-1;break}return a}function s(e,t,s,n){for(var i=0;s--;)e[s]-=i,i=+(e[s]<t[s]),e[s]=i*n+e[s]-t[s];for(;!e[0]&&e.length>1;e.splice(0,1));}return function(n,i,a,r,o){var l,c,u,d,p,h,m,g,f,y,b,w,_,v,k,S,A,P=n.s==i.s?1:-1,R=n.c,I=i.c;if(!R||!R[0]||!I||!I[0])return new C(!n.s||!i.s||(R?I&&R[0]==I[0]:!I)?NaN:R&&0==R[0]||!I?0*P:P/0);for(f=(g=new C(P)).c=[],P=a+(c=n.e-i.e)+1,o||(o=1e14,c=sB(n.e/14)-sB(i.e/14),P=P/14|0),u=0;I[u]==(R[u]||0);u++);if(I[u]>(R[u]||0)&&c--,P<0)f.push(1),d=!0;else{for(v=R.length,S=I.length,u=0,P+=2,(p=sD(o/(I[0]+1)))>1&&(I=e(I,p,o),R=e(R,p,o),S=I.length,v=R.length),_=S,b=(y=R.slice(0,S)).length;b<S;y[b++]=0);A=[0].concat(A=I.slice()),k=I[0],I[1]>=o/2&&k++;do{if(p=0,(l=t(I,y,S,b))<0){if(w=y[0],S!=b&&(w=w*o+(y[1]||0)),(p=sD(w/k))>1)for(p>=o&&(p=o-1),m=(h=e(I,p,o)).length,b=y.length;1==t(h,y,m,b);)p--,s(h,S<m?A:I,m,o),m=h.length,l=1;else 0==p&&(l=p=1),m=(h=I.slice()).length;if(m<b&&(h=[0].concat(h)),s(y,h,b,o),b=y.length,-1==l)for(;1>t(I,y,S,b);)p++,s(y,S<b?A:I,b,o),b=y.length}else 0===l&&(p++,y=[0]);f[u++]=p,y[0]?y[b++]=R[_]||0:(y=[R[_]],b=1)}while((_++<v||null!=y[0])&&P--)d=null!=y[0],f[0]||f.splice(0,1)}if(1e14==o){for(u=1,P=f[0];P>=10;P/=10,u++);E(g,a+(g.e=u+14*c-1)+1,r,d)}else g.e=c,g.r=+d;return g}}(),n=/^(-?)0([xbo])(?=\w[\w.]*$)/i,i=/^([^.]+)\.$/,a=/^\.([^.]+)$/,r=/^-?(Infinity|NaN)$/,o=/^\s*\+(?=[\w.])|^\s+|\s+$/g,u=function(e,t,s,l){var c,u=s?t:t.replace(o,"");if(r.test(u))e.s=isNaN(u)?null:u<0?-1:1;else{if(!s&&(u=u.replace(n,function(e,t,s){return c="x"==(s=s.toLowerCase())?16:"b"==s?2:8,l&&l!=c?e:t}),l&&(c=l,u=u.replace(i,"$1").replace(a,"0.$1")),t!=u))return new C(u,c);if(C.DEBUG)throw Error(sU+"Not a"+(l?" base "+l:"")+" number: "+t);e.s=null}e.c=e.e=null},d.absoluteValue=d.abs=function(){var e=new C(this);return e.s<0&&(e.s=1),e},d.comparedTo=function(e,t){return sH(this,new C(e,t))},d.decimalPlaces=d.dp=function(e,t){var s,n,i;if(null!=e)return sV(e,0,1e9),null==t?t=m:sV(t,0,8),E(new C(this),e+this.e+1,t);if(!(s=this.c))return null;if(n=((i=s.length-1)-sB(this.e/14))*14,i=s[i])for(;i%10==0;i/=10,n--);return n<0&&(n=0),n},d.dividedBy=d.div=function(e,t){return l(this,new C(e,t),h,m)},d.dividedToIntegerBy=d.idiv=function(e,t){return l(this,new C(e,t),0,1)},d.exponentiatedBy=d.pow=function(e,t){var s,n,i,a,r,o,l,c,u,d=this;if((e=new C(e)).c&&!e.isInteger())throw Error(sU+"Exponent not an integer: "+x(e));if(null!=t&&(t=new C(t)),o=e.e>14,!d.c||!d.c[0]||1==d.c[0]&&!d.e&&1==d.c.length||!e.c||!e.c[0])return u=new C(Math.pow(+x(d),o?e.s*(2-sz(e)):+x(e))),t?u.mod(t):u;if(l=e.s<0,t){if(t.c?!t.c[0]:!t.s)return new C(NaN);(n=!l&&d.isInteger()&&t.isInteger())&&(d=d.mod(t))}else{if(e.e>9&&(d.e>0||d.e<-1||(0==d.e?d.c[0]>1||o&&d.c[1]>=24e7:d.c[0]<8e13||o&&d.c[0]<=9999975e7)))return a=d.s<0&&sz(e)?-0:0,d.e>-1&&(a=1/a),new C(l?1/a:a);v&&(a=sj(v/14+2))}for(o?(s=new C(.5),l&&(e.s=1),c=sz(e)):c=(i=Math.abs(+x(e)))%2,u=new C(p);;){if(c){if(!(u=u.times(d)).c)break;a?u.c.length>a&&(u.c.length=a):n&&(u=u.mod(t))}if(i){if(0===(i=sD(i/2)))break;c=i%2}else if(E(e=e.times(s),e.e+1,1),e.e>14)c=sz(e);else{if(0==(i=+x(e)))break;c=i%2}d=d.times(d),a?d.c&&d.c.length>a&&(d.c.length=a):n&&(d=d.mod(t))}return n?u:(l&&(u=p.div(u)),t?u.mod(t):a?E(u,v,m,r):u)},d.integerValue=function(e){var t=new C(this);return null==e?e=m:sV(e,0,8),E(t,t.e+1,e)},d.isEqualTo=d.eq=function(e,t){return 0===sH(this,new C(e,t))},d.isFinite=function(){return!!this.c},d.isGreaterThan=d.gt=function(e,t){return sH(this,new C(e,t))>0},d.isGreaterThanOrEqualTo=d.gte=function(e,t){return 1===(t=sH(this,new C(e,t)))||0===t},d.isInteger=function(){return!!this.c&&sB(this.e/14)>this.c.length-2},d.isLessThan=d.lt=function(e,t){return 0>sH(this,new C(e,t))},d.isLessThanOrEqualTo=d.lte=function(e,t){return -1===(t=sH(this,new C(e,t)))||0===t},d.isNaN=function(){return!this.s},d.isNegative=function(){return this.s<0},d.isPositive=function(){return this.s>0},d.isZero=function(){return!!this.c&&0==this.c[0]},d.minus=function(e,t){var s,n,i,a,r=this.s;if(t=(e=new C(e,t)).s,!r||!t)return new C(NaN);if(r!=t)return e.s=-t,this.plus(e);var o=this.e/14,l=e.e/14,c=this.c,u=e.c;if(!o||!l){if(!c||!u)return c?(e.s=-t,e):new C(u?this:NaN);if(!c[0]||!u[0])return u[0]?(e.s=-t,e):new C(c[0]?this:3==m?-0:0)}if(o=sB(o),l=sB(l),c=c.slice(),r=o-l){for((a=r<0)?(r=-r,i=c):(l=o,i=u),i.reverse(),t=r;t--;i.push(0));i.reverse()}else for(n=(a=(r=c.length)<(t=u.length))?r:t,r=t=0;t<n;t++)if(c[t]!=u[t]){a=c[t]<u[t];break}if(a&&(i=c,c=u,u=i,e.s=-e.s),(t=(n=u.length)-(s=c.length))>0)for(;t--;c[s++]=0);for(t=1e14-1;n>r;){if(c[--n]<u[n]){for(s=n;s&&!c[--s];c[s]=t);--c[s],c[n]+=1e14}c[n]-=u[n]}for(;0==c[0];c.splice(0,1),--l);return c[0]?I(e,c,l):(e.s=3==m?-1:1,e.c=[e.e=0],e)},d.modulo=d.mod=function(e,t){var s,n;return(e=new C(e,t),this.c&&e.s&&(!e.c||e.c[0]))?e.c&&(!this.c||this.c[0])?(9==_?(n=e.s,e.s=1,s=l(this,e,0,3),e.s=n,s.s*=n):s=l(this,e,0,_),(e=this.minus(s.times(e))).c[0]||1!=_||(e.s=this.s),e):new C(this):new C(NaN)},d.multipliedBy=d.times=function(e,t){var s,n,i,a,r,o,l,c,u,d,p,h,m,g=this.c,f=(e=new C(e,t)).c;if(!g||!f||!g[0]||!f[0])return this.s&&e.s&&(!g||g[0]||f)&&(!f||f[0]||g)?(e.s*=this.s,g&&f?(e.c=[0],e.e=0):e.c=e.e=null):e.c=e.e=e.s=null,e;for(n=sB(this.e/14)+sB(e.e/14),e.s*=this.s,(l=g.length)<(d=f.length)&&(m=g,g=f,f=m,i=l,l=d,d=i),i=l+d,m=[];i--;m.push(0));for(i=d;--i>=0;){for(s=0,p=f[i]%1e7,h=f[i]/1e7|0,a=i+(r=l);a>i;)o=h*(c=g[--r]%1e7)+(u=g[r]/1e7|0)*p,s=((c=p*c+o%1e7*1e7+m[a]+s)/1e14|0)+(o/1e7|0)+h*u,m[a--]=c%1e14;m[a]=s}return s?++n:m.splice(0,1),I(e,m,n)},d.negated=function(){var e=new C(this);return e.s=-e.s||null,e},d.plus=function(e,t){var s,n=this.s;if(t=(e=new C(e,t)).s,!n||!t)return new C(NaN);if(n!=t)return e.s=-t,this.minus(e);var i=this.e/14,a=e.e/14,r=this.c,o=e.c;if(!i||!a){if(!r||!o)return new C(n/0);if(!r[0]||!o[0])return o[0]?e:new C(r[0]?this:0*n)}if(i=sB(i),a=sB(a),r=r.slice(),n=i-a){for(n>0?(a=i,s=o):(n=-n,s=r),s.reverse();n--;s.push(0));s.reverse()}for((n=r.length)-(t=o.length)<0&&(s=o,o=r,r=s,t=n),n=0;t;)n=(r[--t]=r[t]+o[t]+n)/1e14|0,r[t]=1e14===r[t]?0:r[t]%1e14;return n&&(r=[n].concat(r),++a),I(e,r,a)},d.precision=d.sd=function(e,t){var s,n,i;if(null!=e&&!!e!==e)return sV(e,1,1e9),null==t?t=m:sV(t,0,8),E(new C(this),e,t);if(!(s=this.c))return null;if(n=14*(i=s.length-1)+1,i=s[i]){for(;i%10==0;i/=10,n--);for(i=s[0];i>=10;i/=10,n++);}return e&&this.e+1>n&&(n=this.e+1),n},d.shiftedBy=function(e){return sV(e,-0x1fffffffffffff,0x1fffffffffffff),this.times("1e"+e)},d.squareRoot=d.sqrt=function(){var e,t,s,n,i,a=this.c,r=this.s,o=this.e,c=h+4,u=new C("0.5");if(1!==r||!a||!a[0])return new C(!r||r<0&&(!a||a[0])?NaN:a?this:1/0);if(0==(r=Math.sqrt(+x(this)))||r==1/0?(((t=sG(a)).length+o)%2==0&&(t+="0"),r=Math.sqrt(+t),o=sB((o+1)/2)-(o<0||o%2),s=new C(t=r==1/0?"5e"+o:(t=r.toExponential()).slice(0,t.indexOf("e")+1)+o)):s=new C(r+""),s.c[0]){for((r=(o=s.e)+c)<3&&(r=0);;)if(i=s,s=u.times(i.plus(l(this,i,c,1))),sG(i.c).slice(0,r)===(t=sG(s.c)).slice(0,r)){if(s.e<o&&--r,"9999"!=(t=t.slice(r-3,r+1))&&(n||"4999"!=t)){+t&&(+t.slice(1)||"5"!=t.charAt(0))||(E(s,s.e+h+2,1),e=!s.times(s).eq(this));break}if(!n&&(E(i,i.e+h+2,0),i.times(i).eq(this))){s=i;break}c+=4,r+=4,n=1}}return E(s,s.e+h+1,m,e)},d.toExponential=function(e,t){return null!=e&&(sV(e,0,1e9),e++),P(this,e,t,1)},d.toFixed=function(e,t){return null!=e&&(sV(e,0,1e9),e=e+this.e+1),P(this,e,t)},d.toFormat=function(e,t,s){var n;if(null==s)null!=e&&t&&"object"==typeof t?(s=t,t=null):e&&"object"==typeof e?(s=e,e=t=null):s=k;else if("object"!=typeof s)throw Error(sU+"Argument not an object: "+s);if(n=this.toFixed(e,t),this.c){var i,a=n.split("."),r=+s.groupSize,o=+s.secondaryGroupSize,l=s.groupSeparator||"",c=a[0],u=a[1],d=this.s<0,p=d?c.slice(1):c,h=p.length;if(o&&(i=r,r=o,o=i,h-=i),r>0&&h>0){for(i=h%r||r,c=p.substr(0,i);i<h;i+=r)c+=l+p.substr(i,r);o>0&&(c+=l+p.slice(i)),d&&(c="-"+c)}n=u?c+(s.decimalSeparator||"")+((o=+s.fractionGroupSize)?u.replace(RegExp("\\d{"+o+"}\\B","g"),"$&"+(s.fractionGroupSeparator||"")):u):c}return(s.prefix||"")+n+(s.suffix||"")},d.toFraction=function(e){var t,s,n,i,a,r,o,c,u,d,h,g,f=this.c;if(null!=e&&(!(o=new C(e)).isInteger()&&(o.c||1!==o.s)||o.lt(p)))throw Error(sU+"Argument "+(o.isInteger()?"out of range: ":"not an integer: ")+x(o));if(!f)return new C(this);for(t=new C(p),u=s=new C(p),n=c=new C(p),g=sG(f),a=t.e=g.length-this.e-1,t.c[0]=sF[(r=a%14)<0?14+r:r],e=!e||o.comparedTo(t)>0?a>0?t:u:o,r=b,b=1/0,o=new C(g),c.c[0]=0;d=l(o,t,0,1),1!=(i=s.plus(d.times(n))).comparedTo(e);)s=n,n=i,u=c.plus(d.times(i=u)),c=i,t=o.minus(d.times(i=t)),o=i;return i=l(e.minus(s),n,0,1),c=c.plus(i.times(u)),s=s.plus(i.times(n)),c.s=u.s=this.s,a*=2,h=1>l(u,n,a,m).minus(this).abs().comparedTo(l(c,s,a,m).minus(this).abs())?[u,n]:[c,s],b=r,h},d.toNumber=function(){return+x(this)},d.toPrecision=function(e,t){return null!=e&&sV(e,1,1e9),P(this,e,t,2)},d.toString=function(e){var t,s=this,n=s.s,i=s.e;return null===i?n?(t="Infinity",n<0&&(t="-"+t)):t="NaN":(null==e?t=i<=g||i>=f?sX(sG(s.c),i):sK(sG(s.c),i,"0"):10===e&&A?t=sK(sG((s=E(new C(s),h+i+1,m)).c),s.e,"0"):(sV(e,2,S.length,"Base"),t=c(sK(sG(s.c),i,"0"),10,e,n,!0)),n<0&&s.c[0]&&(t="-"+t)),t},d.valueOf=d.toJSON=function(){return x(this)},d._isBigNumber=!0,d[Symbol.toStringTag]="BigNumber",d[Symbol.for("nodejs.util.inspect.custom")]=d.valueOf,null!=t&&C.set(t),C}();let sY=24,sQ="undefined"!=typeof globalThis&&globalThis.crypto&&"function"==typeof globalThis.crypto.getRandomValues?()=>{let e=new Uint32Array(1);return globalThis.crypto.getRandomValues(e),e[0]/0x100000000}:Math.random,sZ=(e=4,t=sQ)=>{let s="";for(;s.length<e;)s+=Math.floor(36*t()).toString(36);return s},s0=(e="")=>(function(e){let t=new sJ(0);for(let s of e.values())t=t.multipliedBy(256).plus(s);return t})(sq(new TextEncoder().encode(e))).toString(36).slice(1),s1=Array.from({length:26},(e,t)=>String.fromCharCode(t+97)),s2=({globalObj:t=e.g,random:s=sQ}={})=>{let n=Object.keys(t).toString();return s0(n.length?n+sZ(32,s):sZ(32,s)).substring(0,32)},s4=e=>()=>e++,s5=0x1c6b1f1f,s3=(({random:e=sQ,counter:t=s4(Math.floor(e()*s5)),length:s=sY,fingerprint:n=s2({random:e})}={})=>{if(s>32)throw Error(`Length must be between 2 and 32. Received: ${s}`);return function(){let i=s1[Math.floor(e()*s1.length)],a=Date.now().toString(36),r=t().toString(36),o=sZ(s,e),l=`${a+o+r+n}`;return`${i+s0(l).substring(1,s)}`}})(),s9={real_estate:{name:"Real Estate",overview:"Real estate marketing is highly local, relationship-driven, and visual. Success depends on building trust, demonstrating market expertise, and leveraging technology.",targetAudiences:["First-time homebuyers","Move-up buyers","Downsizers","Investors","Sellers","Renters","Commercial clients"],channelPriority:[{channel:"Local SEO & Google Business Profile",priority:1,description:"Critical for local discovery"},{channel:"Real Estate Portals (Zillow, Realtor.com)",priority:2,description:"Where buyers search"},{channel:"Social Media (Facebook, Instagram)",priority:3,description:"Visual showcase and engagement"},{channel:"Email Marketing",priority:4,description:"Nurturing long sales cycles"},{channel:"Video Tours & Virtual Reality",priority:5,description:"Property showcase"},{channel:"Paid Search & Display",priority:6,description:"Targeted lead generation"},{channel:"Direct Mail",priority:7,description:"Local farming"}],keyStrategies:[{name:"Listing Marketing",tactics:["Professional photography","Virtual tours and 3D walkthroughs","Drone footage","Property videos","Detailed descriptions","Floor plans","Neighborhood information"]},{name:"Agent Personal Branding",tactics:["Local market expertise content","Video market updates","Client testimonials","Community involvement","Social media presence"]},{name:"Lead Generation",tactics:["Home valuation tools","Property search widgets","Buyer guides","Seller guides","Market reports","Open house promotions"]},{name:"Nurturing Long Sales Cycles",tactics:["Drip email campaigns","Market update newsletters","Anniversary and milestone emails","Referral requests","Client appreciation events"]}],kpis:["Cost per lead","Lead to appointment rate","Listing appointment to listing rate","Days on market","Sale price to list price ratio","Client satisfaction score","Referral rate"],commonMistakes:["Not investing in professional photography","Ignoring local SEO","Not following up with leads quickly","Generic messaging instead of local expertise","Not leveraging video content"]},ecommerce:{name:"E-Commerce & Retail",overview:"E-commerce marketing encompasses online retail with key challenges including fierce competition, rising customer acquisition costs, and the need for seamless omnichannel experiences.",targetAudiences:["Bargain hunters and deal seekers","Convenience shoppers","Brand loyalists","Research-intensive buyers","Impulse purchasers","Subscription seekers"],channelPriority:[{channel:"Google Shopping & Search Ads",priority:1,description:"High-intent traffic"},{channel:"Social Media Advertising",priority:2,description:"Facebook, Instagram, TikTok"},{channel:"Email Marketing & Automation",priority:3,description:"Retention and repeat purchases"},{channel:"SEO for Product Pages",priority:4,description:"Organic discovery"},{channel:"Influencer Partnerships",priority:5,description:"Social proof and reach"},{channel:"Affiliate Marketing",priority:6,description:"Performance-based growth"},{channel:"Retargeting",priority:7,description:"Cart abandonment recovery"}],keyStrategies:[{name:"Product Page Optimization",tactics:["High-quality product photography","360-degree views and video","Detailed specifications","Size guides and fit tools","Customer reviews and ratings","Related product recommendations","Clear pricing and shipping info","Urgency elements (stock levels, timers)"]},{name:"Cart Abandonment Recovery",tactics:["Exit-intent popups","Email 1: 1 hour after (reminder)","Email 2: 24 hours after (add incentive)","Email 3: 72 hours after (final push)","SMS reminders","Retargeting ads"]},{name:"Customer Retention",tactics:["Post-purchase email sequences","Loyalty and rewards programs","VIP customer programs","Personalized recommendations","Subscription options","Referral programs"]}],kpis:["Conversion rate","Average order value (AOV)","Customer acquisition cost (CAC)","Customer lifetime value (CLV)","Cart abandonment rate","Return rate","Revenue per visitor","Email revenue attribution"],commonMistakes:["Poor mobile experience","Slow page load times","Complicated checkout process","No abandoned cart recovery","Ignoring customer reviews"]},saas:{name:"SaaS & Technology",overview:"SaaS businesses provide cloud-based software on subscription basis. Marketing focuses on demonstrating value, reducing time-to-value, and minimizing churn.",targetAudiences:["Decision makers (C-suite, VPs)","End users","Technical evaluators","Budget holders","Influencers within organizations"],channelPriority:[{channel:"Content Marketing & SEO",priority:1,description:"Education and thought leadership"},{channel:"LinkedIn Advertising & Organic",priority:2,description:"B2B targeting"},{channel:"Google Ads (Search)",priority:3,description:"High-intent capture"},{channel:"Email Marketing & Nurturing",priority:4,description:"Lead nurturing"},{channel:"Webinars & Virtual Events",priority:5,description:"Demonstration and education"},{channel:"Product-Led Growth",priority:6,description:"Free trials and freemium"},{channel:"Review Sites (G2, Capterra)",priority:7,description:"Social proof"}],keyStrategies:[{name:"Product-Led Growth (PLG)",tactics:["Free trial optimization","Freemium model design","In-app onboarding","Feature gating strategy","Usage-based upselling","Viral loops and referrals"]},{name:"Content Marketing for SaaS",tactics:["Educational blog content","Comparison pages (vs. competitors)","Integration partner content","Use case documentation","ROI calculators","Industry reports and research"]},{name:"Lead Nurturing",tactics:["Segmented email sequences","Progressive profiling","Behavioral triggers","Sales enablement content","Demo and trial follow-up"]}],kpis:["Monthly Recurring Revenue (MRR)","Annual Recurring Revenue (ARR)","Customer Acquisition Cost (CAC)","Lifetime Value (LTV)","LTV:CAC Ratio","Churn Rate","Net Revenue Retention","Trial-to-Paid Conversion","Product Qualified Leads (PQLs)"],commonMistakes:["No free trial or freemium option","Poor onboarding experience","Not tracking product usage","Generic messaging for all segments","Ignoring customer success"]},healthcare:{name:"Healthcare & Medical",overview:"Healthcare marketing requires careful attention to regulations, patient privacy, and ethical considerations while building trust and credibility.",targetAudiences:["Patients and caregivers","Healthcare providers","Hospital administrators","Insurance companies","Medical professionals","Health-conscious consumers"],channelPriority:[{channel:"SEO & Local SEO",priority:1,description:"Patient discovery"},{channel:"Google Ads (compliant)",priority:2,description:"Service promotion"},{channel:"Content Marketing",priority:3,description:"Education and trust"},{channel:"Email Marketing",priority:4,description:"Patient communication"},{channel:"Social Media (educational)",priority:5,description:"Community building"},{channel:"Reputation Management",priority:6,description:"Reviews and testimonials"},{channel:"Referral Programs",priority:7,description:"Provider referrals"}],keyStrategies:[{name:"HIPAA-Compliant Marketing",tactics:["No PHI in marketing materials","Secure forms and data handling","Consent-based communications","Compliant testimonials","Privacy policy transparency"]},{name:"Medical SEO",tactics:["Health-focused content (E-E-A-T critical)","Local SEO for practices","Provider profiles","Condition and treatment pages","FAQ schema implementation"]}],kpis:["New patient acquisition cost","Patient lifetime value","Online booking rate","Review rating average","Referral rate","Patient retention rate"],commonMistakes:["HIPAA violations in marketing","Making unsubstantiated claims","Ignoring online reputation","Poor local SEO","Not having mobile-friendly booking"]},professional_services:{name:"Professional Services (Consulting, Legal, Accounting)",overview:"Professional services marketing focuses on expertise demonstration, trust building, and relationship development with long sales cycles.",targetAudiences:["Small business owners","C-suite executives","Finance departments","HR departments","Board members","Entrepreneurs"],channelPriority:[{channel:"LinkedIn (Organic & Paid)",priority:1,description:"Professional networking"},{channel:"Content Marketing & SEO",priority:2,description:"Thought leadership"},{channel:"Email Marketing",priority:3,description:"Relationship nurturing"},{channel:"Referral Networks",priority:4,description:"Word-of-mouth"},{channel:"Speaking & Events",priority:5,description:"Authority building"},{channel:"Webinars",priority:6,description:"Education and leads"},{channel:"Industry Publications",priority:7,description:"Credibility"}],keyStrategies:[{name:"Thought Leadership",tactics:["Industry research and reports","Trend analysis","Bylined articles","Speaking engagements","Podcast appearances"]},{name:"Case Study Marketing",tactics:["Client success stories","ROI documentation","Industry-specific examples","Video testimonials"]}],kpis:["Cost per qualified lead","Lead to opportunity rate","Average deal size","Sales cycle length","Client retention rate","Referral rate"],commonMistakes:["Not demonstrating expertise","Generic positioning","Ignoring LinkedIn","No case studies","Poor follow-up"]}};function s6(e){let t=e.toLowerCase().replace(/[^a-z]/g,"_");return s9[({real_estate:"real_estate",realestate:"real_estate",property:"real_estate",realtor:"real_estate",ecommerce:"ecommerce",e_commerce:"ecommerce",retail:"ecommerce",online_store:"ecommerce",saas:"saas",software:"saas",technology:"saas",tech:"saas",healthcare:"healthcare",medical:"healthcare",health:"healthcare",doctor:"healthcare",professional_services:"professional_services",consulting:"professional_services",legal:"professional_services",accounting:"professional_services",law:"professional_services"})[t]||t]||null}let s8={tofu:{name:"Top of Funnel (Awareness)",goal:"Generate awareness and attract potential customers",contentTypes:["Blog posts and articles","Social media content","Infographics","Educational videos","Podcasts","Webinars (educational)"],metrics:["Impressions","Reach","Website traffic","Social engagement","Brand mentions"],channels:["SEO","Social Media","Content Marketing","PR","Display Ads"]},mofu:{name:"Middle of Funnel (Consideration)",goal:"Nurture leads and demonstrate value",contentTypes:["Ebooks and whitepapers","Case studies","Comparison guides","Email nurture sequences","Webinars (product-focused)","Free tools and calculators"],metrics:["Email open/click rates","Content downloads","Webinar attendance","Time on site"],channels:["Email Marketing","Retargeting","Content Marketing","Webinars"]},bofu:{name:"Bottom of Funnel (Decision)",goal:"Convert leads to customers",contentTypes:["Product demos","Free trials","Consultations","Pricing pages","Customer testimonials","ROI calculators"],metrics:["Demo requests","Trial signups","Conversion rate","Cost per acquisition"],channels:["Sales","Email","Retargeting","Direct"]},retention:{name:"Retention & Advocacy",goal:"Keep customers and turn them into advocates",contentTypes:["Onboarding sequences","Customer success content","Feature updates","Loyalty programs","Referral programs"],metrics:["Retention rate","NPS","Referral rate","Lifetime value","Expansion revenue"],channels:["Email","In-app","Customer Success","Community"]}},s7={seo:{name:"Search Engine Optimization",description:"Improving visibility in organic search results",components:{technical:["Site architecture and URL structure","Page speed optimization (Core Web Vitals)","Mobile optimization","Schema markup","XML sitemaps","HTTPS security"],onPage:["Keyword research and mapping","Title tag optimization (50-60 chars)","Meta descriptions (150-160 chars)","Header hierarchy (H1, H2, H3)","Content quality (E-E-A-T)","Internal linking"],offPage:["Link building strategies","Digital PR","Guest posting","Local citations","Brand mentions"],local:["Google Business Profile optimization","NAP consistency","Local content","Review management","Local link building"]}},ppc:{name:"Pay-Per-Click Advertising",description:"Paid advertising on search engines and platforms",platforms:{googleAds:{campaignTypes:["Search","Display","Shopping","Video","Performance Max"],bestPractices:["Logical account structure","Quality Score optimization","Negative keyword management","Ad extension usage","Conversion tracking"]},socialAds:{platforms:["Facebook/Meta","LinkedIn","Twitter/X","TikTok","Pinterest"],targetingOptions:["Demographics","Interests","Behaviors","Custom audiences","Lookalikes"]}}},email:{name:"Email Marketing",description:"Direct communication with subscribers and customers",types:["Welcome series","Nurture campaigns","Promotional emails","Newsletters","Transactional emails","Re-engagement campaigns"],bestPractices:["Subject lines under 50 characters","Personalization","Mobile-responsive design","Clear CTAs","A/B testing","List hygiene"],metrics:["Open rate","Click rate","Conversion rate","Unsubscribe rate"]},social:{name:"Social Media Marketing",description:"Building presence and engagement on social platforms",platforms:{facebook:{bestFor:"Community building, local businesses, older demographics",postFrequency:"1-2 per day"},instagram:{bestFor:"Visual brands, lifestyle, younger demographics",postFrequency:"1-3 per day plus Stories"},linkedin:{bestFor:"B2B, professional services, thought leadership",postFrequency:"1-2 per day weekdays"},tiktok:{bestFor:"Gen Z, entertainment, trends, brand personality",postFrequency:"1-4 per day"},twitter:{bestFor:"News, real-time engagement, customer service",postFrequency:"3-5 per day"},youtube:{bestFor:"Long-form content, tutorials, brand building",postFrequency:"1-3 per week"}}},content:{name:"Content Marketing",description:"Creating valuable content to attract and engage audiences",types:{written:["Blog posts","Ebooks","Whitepapers","Case studies","Newsletters"],visual:["Infographics","Photography","Presentations","Data visualizations"],video:["Explainers","Tutorials","Testimonials","Webinars","Live streams"],audio:["Podcasts","Audio articles","Interviews"],interactive:["Quizzes","Calculators","Tools","Assessments"]}}},ne={generational:{genZ:{name:"Generation Z (1997-2012)",characteristics:["Digital natives","Mobile-first","Short attention spans","Value authenticity","Socially conscious"],platforms:["TikTok","Instagram","Snapchat","YouTube"],approach:"Short-form video, memes, influencers, user-generated content"},millennials:{name:"Millennials (1981-1996)",characteristics:["Tech-comfortable","Experience-oriented","Research before purchase","Value convenience"],platforms:["Instagram","YouTube","Facebook","LinkedIn"],approach:"Social proof, convenience, experiences, purpose-driven"},genX:{name:"Generation X (1965-1980)",characteristics:["Independent","Skeptical of marketing","Brand loyal when earned","Value quality"],platforms:["Facebook","YouTube","LinkedIn","Email"],approach:"Straightforward messaging, quality focus, email marketing"},boomers:{name:"Baby Boomers (1946-1964)",characteristics:["Wealth concentrated","Brand loyal","Research-oriented","Value service"],platforms:["Facebook","Email","YouTube"],approach:"Trust building, detailed information, customer service focus"}},b2b:{enterprise:{size:"1000+ employees",approach:"Account-based marketing, long sales cycles, custom solutions"},midMarket:{size:"100-999 employees",approach:"Scalability needs, balanced approach, value demonstration"},smallBusiness:{size:"10-99 employees",approach:"Quick decisions, relationship-important, support needs"},microBusiness:{size:"<10 employees",approach:"Owner decisions, price-sensitive, self-service preference"}}},nt={acquisition:[{name:"Cost Per Lead (CPL)",description:"Total marketing spend / Number of leads"},{name:"Cost Per Acquisition (CPA)",description:"Total marketing spend / Number of customers"},{name:"Customer Acquisition Cost (CAC)",description:"Total sales & marketing cost / New customers"},{name:"Conversion Rate",description:"Conversions / Total visitors Ã— 100"}],engagement:[{name:"Click-Through Rate (CTR)",description:"Clicks / Impressions Ã— 100"},{name:"Bounce Rate",description:"Single-page sessions / Total sessions Ã— 100"},{name:"Time on Page",description:"Average time users spend on a page"},{name:"Pages per Session",description:"Total pageviews / Total sessions"}],retention:[{name:"Customer Lifetime Value (CLV)",description:"Average purchase value Ã— Purchase frequency Ã— Customer lifespan"},{name:"Churn Rate",description:"Customers lost / Total customers Ã— 100"},{name:"Net Promoter Score (NPS)",description:"Promoters % - Detractors %"},{name:"Customer Retention Rate",description:"Customers at end - New customers / Customers at start Ã— 100"}],revenue:[{name:"Return on Ad Spend (ROAS)",description:"Revenue from ads / Ad spend"},{name:"Marketing ROI",description:"(Revenue - Marketing cost) / Marketing cost Ã— 100"},{name:"Revenue per Visitor",description:"Total revenue / Total visitors"}]},ns={leadGeneration:{name:"Lead Generation Campaign",steps:["Define target audience and offer","Create high-value content asset (ebook, webinar, tool)","Build landing page with compelling copy and form","Set up thank you page and email delivery","Create nurture email sequence (5-7 emails)","Set up paid promotion (Google, Facebook, LinkedIn)","Configure tracking and attribution","Launch and monitor performance","Optimize based on data"]},productLaunch:{name:"Product Launch Campaign",phases:{prelaunch:["Teaser content","Waitlist building","Influencer seeding","Press outreach"],launch:["Announcement email","Social media blitz","Paid advertising","PR push","Webinar/demo"],postlaunch:["Customer testimonials","Case studies","Ongoing promotion","Feedback collection"]}},emailNurture:{name:"Email Nurture Sequence",emails:[{day:0,subject:"Welcome + Deliver promised content"},{day:2,subject:"Educational content related to their interest"},{day:5,subject:"Case study or social proof"},{day:8,subject:"Address common objections"},{day:12,subject:"Soft promotion or offer"},{day:15,subject:"Final push with urgency"}]},retargeting:{name:"Retargeting Campaign",audiences:[{audience:"Website visitors (no conversion)",message:"Remember us? Come back and explore"},{audience:"Cart abandoners",message:"You left something behind + incentive"},{audience:"Past customers",message:"New products you might like"},{audience:"Email non-openers",message:"Alternative messaging approach"}]}},nn=["Routine data entry and updates","Contact enrichment and validation","Lead scoring and qualification","Task creation and reminders","Email scheduling (pre-approved content)","Report generation","Analytics tracking","Workflow execution","Performance monitoring","Budget optimization within set limits","Calendar management","File organization","Contact deduplication","Data backup","Auto-tagging and categorization"],ni=["Campaign launches (pre-approved budget)","Content publication","Email campaign sends","Ad campaign creation","Workflow modifications","Integration activations","Team notifications","Client portal updates","Social media posts (scheduled)","Invoice generation","Payment reminders","Lead reassignment","Appointment confirmations"],na=["Large budget allocations (>$1,000)","Brand asset changes","Domain configurations","White-label settings","User role changes","Data deletion (bulk)","Integration disconnections","System-wide settings changes","Legal/compliance content","Financial transactions","Contract modifications","User permission changes","Public API key generation","Security settings changes"],nr=new sp({apiKey:process.env.ANTHROPIC_API_KEY||""}),no=[{name:"search_contacts",description:"Search for contacts by name, email, phone, company, or any criteria. Use for finding specific contacts or filtering contact lists.",input_schema:{type:"object",properties:{query:{type:"string",description:"Search query - name, email, phone, or company"},status:{type:"string",enum:["new","contacted","qualified","customer","lost"],description:"Filter by status"},tags:{type:"array",items:{type:"string"},description:"Filter by tags"},limit:{type:"number",description:"Max results (default: 10)"}},required:["query"]}},{name:"get_contact",description:"Get full details of a specific contact by ID or email.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Contact UUID"},email:{type:"string",description:"Contact email address"}},required:[]}},{name:"create_contact",description:"Create a new contact with provided information.",input_schema:{type:"object",properties:{firstName:{type:"string",description:"First name (required)"},lastName:{type:"string",description:"Last name"},email:{type:"string",description:"Email address"},phone:{type:"string",description:"Phone number"},company:{type:"string",description:"Company name"},status:{type:"string",enum:["new","contacted","qualified","customer","lost"]},tags:{type:"array",items:{type:"string"},description:"Tags to add"},source:{type:"string",description:"Lead source"},notes:{type:"string",description:"Contact notes"}},required:["firstName"]}},{name:"update_contact",description:"Update any field on an existing contact. Use the active contact if no contact_id specified.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Contact ID (uses active contact if not provided)"},email:{type:"string",description:"New email"},phone:{type:"string",description:"New phone"},firstName:{type:"string",description:"New first name"},lastName:{type:"string",description:"New last name"},company:{type:"string",description:"New company"},status:{type:"string",enum:["new","contacted","qualified","customer","lost"]},tags:{type:"array",items:{type:"string"},description:"Tags to add"},removeTags:{type:"array",items:{type:"string"},description:"Tags to remove"},notes:{type:"string",description:"Notes to add"}},required:[]}},{name:"delete_contact",description:"Delete a contact permanently. Always confirm with user first.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Contact ID to delete"}},required:["contact_id"]}},{name:"list_contacts",description:"List contacts with optional filtering and statistics.",input_schema:{type:"object",properties:{status:{type:"string",enum:["new","contacted","qualified","customer","lost"]},limit:{type:"number",description:"Max contacts to return"},include_stats:{type:"boolean",description:"Include count statistics"},sort_by:{type:"string",enum:["createdAt","lastActivityAt","firstName","company"]},sort_order:{type:"string",enum:["asc","desc"]}},required:[]}},{name:"bulk_update_contacts",description:"Update multiple contacts at once with the same changes.",input_schema:{type:"object",properties:{contact_ids:{type:"array",items:{type:"string"},description:"List of contact IDs"},status:{type:"string",enum:["new","contacted","qualified","customer","lost"]},tags:{type:"array",items:{type:"string"},description:"Tags to add"},owner:{type:"string",description:"New owner user ID"}},required:["contact_ids"]}},{name:"create_deal",description:"Create a new deal/opportunity in a pipeline.",input_schema:{type:"object",properties:{name:{type:"string",description:"Deal name"},value:{type:"number",description:"Deal value in dollars"},contact_id:{type:"string",description:"Associated contact ID"},pipeline_id:{type:"string",description:"Pipeline ID"},stage:{type:"string",description:"Pipeline stage name"},expected_close_date:{type:"string",description:"Expected close date (ISO format)"},probability:{type:"number",description:"Win probability (0-100)"}},required:["name"]}},{name:"update_deal",description:"Update deal information, move stages, or mark won/lost.",input_schema:{type:"object",properties:{deal_id:{type:"string",description:"Deal ID"},name:{type:"string",description:"New deal name"},value:{type:"number",description:"New value"},stage:{type:"string",description:"New stage"},status:{type:"string",enum:["open","won","lost"],description:"Deal status"},lost_reason:{type:"string",description:"Reason for loss"},expected_close_date:{type:"string",description:"New close date"}},required:["deal_id"]}},{name:"get_pipeline_stats",description:"Get pipeline analytics - total value, conversion rates, deal counts by stage.",input_schema:{type:"object",properties:{pipeline_id:{type:"string",description:"Specific pipeline (or all)"},date_range:{type:"string",enum:["today","week","month","quarter","year"]}},required:[]}},{name:"create_pipeline",description:"Create a new sales pipeline with custom stages. If stages not provided, use industry-appropriate defaults. For real estate: Lead â†’ Qualified â†’ Property Shown â†’ Offer Made â†’ Under Contract â†’ Closed Won. For general sales: Lead â†’ Qualified â†’ Demo â†’ Proposal â†’ Negotiation â†’ Closed Won.",input_schema:{type:"object",properties:{name:{type:"string",description:'Pipeline name (e.g., "Real Estate Leads", "Enterprise Sales")'},pipeline_type:{type:"string",enum:["real_estate","sales","consulting","saas","recruiting","custom"],description:"Type of pipeline - determines default stages if stages not provided"},stages:{type:"array",items:{type:"string"},description:"Custom stage names. If not provided, uses defaults based on pipeline_type or name."},description:{type:"string",description:"Pipeline description"}},required:["name"]}},{name:"list_pipelines",description:"List all available pipelines.",input_schema:{type:"object",properties:{include_stats:{type:"boolean",description:"Include deal counts and values per pipeline"}},required:[]}},{name:"update_pipeline",description:"Update pipeline name, stages, or settings.",input_schema:{type:"object",properties:{pipeline_id:{type:"string",description:"Pipeline ID to update"},name:{type:"string",description:"New pipeline name"},stages:{type:"array",items:{type:"string"},description:"New stage list"},add_stage:{type:"string",description:"Add a single stage"},remove_stage:{type:"string",description:"Remove a stage"}},required:["pipeline_id"]}},{name:"delete_pipeline",description:"Delete a pipeline. Requires confirmation - deals in pipeline will need to be moved first.",input_schema:{type:"object",properties:{pipeline_id:{type:"string",description:"Pipeline ID to delete"},move_deals_to:{type:"string",description:"Pipeline ID to move existing deals to"}},required:["pipeline_id"]}},{name:"get_pipeline",description:"Get details of a specific pipeline including all stages and settings.",input_schema:{type:"object",properties:{pipeline_id:{type:"string",description:"Pipeline ID"},name:{type:"string",description:"Pipeline name to search for"}},required:[]}},{name:"list_deals",description:"List deals in a pipeline, optionally filtered by stage or status.",input_schema:{type:"object",properties:{pipeline_id:{type:"string",description:"Filter by pipeline"},stage:{type:"string",description:"Filter by stage name"},status:{type:"string",enum:["open","won","lost","all"]},contact_id:{type:"string",description:"Deals for specific contact"},limit:{type:"number",description:"Max results"}},required:[]}},{name:"create_task",description:"Create a task or reminder.",input_schema:{type:"object",properties:{title:{type:"string",description:"Task title"},description:{type:"string",description:"Task description"},due_date:{type:"string",description:"Due date (ISO format)"},priority:{type:"string",enum:["low","medium","high","urgent"]},contact_id:{type:"string",description:"Related contact"},deal_id:{type:"string",description:"Related deal"},assigned_to:{type:"string",description:"Assignee user ID"}},required:["title"]}},{name:"list_tasks",description:"List tasks with filters.",input_schema:{type:"object",properties:{status:{type:"string",enum:["pending","in_progress","completed","overdue"]},due_date:{type:"string",enum:["today","tomorrow","this_week","overdue"]},contact_id:{type:"string",description:"Tasks for specific contact"},assigned_to:{type:"string",description:"Tasks for specific user"}},required:[]}},{name:"complete_task",description:"Mark a task as completed.",input_schema:{type:"object",properties:{task_id:{type:"string",description:"Task ID to complete"}},required:["task_id"]}},{name:"send_email",description:"Send or draft an email to a contact.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Recipient contact ID"},subject:{type:"string",description:"Email subject"},body:{type:"string",description:"Email body (supports HTML)"},template_id:{type:"string",description:"Use email template"},send_now:{type:"boolean",description:"Send immediately or save as draft"}},required:["contact_id"]}},{name:"send_sms",description:"Send SMS to a contact.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Recipient contact ID"},message:{type:"string",description:"SMS message (max 160 chars)"}},required:["contact_id","message"]}},{name:"log_activity",description:"Log a call, meeting, or note for a contact.",input_schema:{type:"object",properties:{contact_id:{type:"string",description:"Contact ID"},type:{type:"string",enum:["call","meeting","email","note","sms"]},subject:{type:"string",description:"Activity subject"},notes:{type:"string",description:"Activity notes/details"},outcome:{type:"string",description:"Call/meeting outcome"},duration_minutes:{type:"number",description:"Duration in minutes"}},required:["contact_id","type"]}},{name:"schedule_appointment",description:"Schedule an appointment or meeting.",input_schema:{type:"object",properties:{title:{type:"string",description:"Appointment title"},contact_id:{type:"string",description:"Contact to meet with"},start_time:{type:"string",description:"Start datetime (ISO)"},end_time:{type:"string",description:"End datetime (ISO)"},location:{type:"string",description:"Meeting location or video link"},description:{type:"string",description:"Meeting description"},send_invite:{type:"boolean",description:"Send calendar invite to contact"}},required:["title","start_time"]}},{name:"get_availability",description:"Check calendar availability for scheduling.",input_schema:{type:"object",properties:{date:{type:"string",description:"Date to check (YYYY-MM-DD)"},duration_minutes:{type:"number",description:"Meeting duration needed"}},required:["date"]}},{name:"create_email_campaign",description:"Create an email marketing campaign.",input_schema:{type:"object",properties:{name:{type:"string",description:"Campaign name"},subject:{type:"string",description:"Email subject line"},content:{type:"string",description:"Email content/body"},segment_id:{type:"string",description:"Target segment"},schedule_time:{type:"string",description:"Schedule send time (ISO)"}},required:["name","subject"]}},{name:"get_campaign_stats",description:"Get email campaign performance statistics.",input_schema:{type:"object",properties:{campaign_id:{type:"string",description:"Campaign ID"}},required:["campaign_id"]}},{name:"get_dashboard_stats",description:"Get overview dashboard statistics.",input_schema:{type:"object",properties:{date_range:{type:"string",enum:["today","week","month","quarter","year"]},metrics:{type:"array",items:{type:"string"},description:"Specific metrics: contacts, deals, revenue, tasks, emails, calls"}},required:[]}},{name:"generate_report",description:"Generate a specific report.",input_schema:{type:"object",properties:{report_type:{type:"string",enum:["contacts","deals","pipeline","activities","campaigns","revenue"],description:"Type of report"},date_range:{type:"string",enum:["today","week","month","quarter","year"]},format:{type:"string",enum:["summary","detailed","export"]}},required:["report_type"]}},{name:"trigger_workflow",description:"Manually trigger an automation workflow for a contact.",input_schema:{type:"object",properties:{workflow_id:{type:"string",description:"Workflow ID to trigger"},contact_id:{type:"string",description:"Contact to enroll"}},required:["workflow_id","contact_id"]}},{name:"list_workflows",description:"List available automation workflows.",input_schema:{type:"object",properties:{status:{type:"string",enum:["active","paused","all"]}},required:[]}},{name:"get_marketing_playbook",description:"Get industry-specific marketing playbook with strategies, channels, KPIs, and tactics. Use when user asks about marketing strategies for their industry or niche.",input_schema:{type:"object",properties:{industry:{type:"string",description:"Industry name (e.g., real_estate, ecommerce, saas, healthcare, professional_services, restaurant, fitness, beauty, automotive)"}},required:["industry"]}},{name:"get_marketing_recommendations",description:"Get personalized marketing recommendations based on business type, size, goals, and budget. Use when user needs marketing advice.",input_schema:{type:"object",properties:{industry:{type:"string",description:"Business industry"},business_size:{type:"string",enum:["micro","small","medium","enterprise"],description:"Business size"},goals:{type:"array",items:{type:"string"},description:"Marketing goals (e.g., lead_generation, brand_awareness, sales, retention)"},budget:{type:"string",enum:["low","medium","high"],description:"Marketing budget level"}},required:[]}},{name:"get_funnel_strategy",description:"Get marketing funnel strategy with content types, metrics, and channels for each stage (TOFU, MOFU, BOFU, Retention).",input_schema:{type:"object",properties:{stage:{type:"string",enum:["tofu","mofu","bofu","retention","all"],description:'Funnel stage to focus on, or "all" for complete funnel'}},required:[]}},{name:"get_channel_guide",description:"Get detailed guide for a specific marketing channel (SEO, PPC, Email, Social Media, Content Marketing).",input_schema:{type:"object",properties:{channel:{type:"string",enum:["seo","ppc","email","social","content"],description:"Marketing channel"}},required:["channel"]}},{name:"get_audience_insights",description:"Get audience segmentation insights including generational marketing, B2B segments, and targeting strategies.",input_schema:{type:"object",properties:{segment_type:{type:"string",enum:["generational","b2b","psychographic","behavioral"],description:"Type of audience segmentation"},specific_segment:{type:"string",description:'Specific segment within type (e.g., "genZ", "millennials", "enterprise", "small_business")'}},required:[]}},{name:"get_campaign_template",description:"Get campaign templates and frameworks for different campaign types.",input_schema:{type:"object",properties:{campaign_type:{type:"string",enum:["lead_generation","product_launch","email_nurture","retargeting","awareness"],description:"Type of campaign"}},required:["campaign_type"]}},{name:"get_marketing_metrics",description:"Get marketing metrics and KPIs with formulas and benchmarks.",input_schema:{type:"object",properties:{category:{type:"string",enum:["acquisition","engagement","retention","revenue","all"],description:"Metric category"}},required:[]}}];class nl{subAccountId;conversationHistory=[];activeContact=null;userInfo=null;constructor(e,t){this.subAccountId=e,this.userInfo=t||null}setUserInfo(e){this.userInfo=e}async chat(e,t=[],s=null){this.conversationHistory=t,this.activeContact=s;let n=this.buildSystemPrompt(),i=[...this.conversationHistory.map(e=>({role:e.role,content:e.content})),{role:"user",content:e}];try{let e=await nr.messages.create({model:"claude-sonnet-4-20250514",max_tokens:1024,system:n,tools:no,messages:i});return await this.processResponse(e)}catch(e){return console.error("Claude API Error:",e),{success:!1,message:`I encountered an error: ${e.message}. Please try again.`}}}async processResponse(e){let t=[],s="",n="",i=null;for(let a of e.content)if("text"===a.type)s+=a.text;else if("tool_use"===a.type){t.push(a.name);let r=await this.executeTool(a.name,a.input);r.success&&r.data&&(i=r.data,r.data.contact?this.activeContact=r.data.contact:r.data.contacts&&r.data.contacts.length>0&&(this.activeContact=r.data.contacts[0]));let o=await this.continueWithToolResult(e,a.id,r);if(o)n=o;else if(r.success){let e=this.formatToolResultMessage(a.name,r);n=s?`${s}

${e}`:e}else n=s?`${s}

âŒ ${r.error||"Action failed"}`:`âŒ ${r.error||"Action failed"}`}return 0===t.length&&(n=s),{success:!0,message:n||"I processed your request but have no specific response.",data:i,toolsUsed:t}}async continueWithToolResult(e,t,s){try{let n=this.conversationHistory.length>0?this.conversationHistory[this.conversationHistory.length-1]?.content:"",i=[...this.conversationHistory.map(e=>({role:e.role,content:e.content})),{role:"user",content:n},{role:"assistant",content:e.content},{role:"user",content:[{type:"tool_result",tool_use_id:t,content:JSON.stringify(s)}]}];for(let e of(await nr.messages.create({model:"claude-sonnet-4-20250514",max_tokens:1024,system:this.buildSystemPrompt(),tools:no,messages:i})).content)if("text"===e.type)return e.text;return""}catch(e){return console.error("Error continuing with tool result:",e),""}}formatToolResultMessage(e,t){if(!t.success)return`âŒ Error: ${t.error||"Action failed"}`;let s=t.data;switch(e){case"create_pipeline":if(s?.pipeline){let e=s.pipeline,t=e.stages||[],n=`âœ… Created **${e.name}** pipeline with ${t.length} stages:

`;return t.forEach((e,t)=>{n+=`${t+1}. **${e.name}** (${e.probability}% probability)
`}),s.stage_flow&&(n+=`
ðŸ“Š Stage Flow: ${s.stage_flow}
`),n+=`
You can now add deals to this pipeline!`}return"âœ… Pipeline created successfully";case"create_contact":if(s?.contact){let e=s.contact;return`âœ… Created contact **${e.firstName} ${e.lastName||""}**
ðŸ“§ Email: ${e.email||"Not set"}
ðŸ“± Phone: ${e.phone||"Not set"}
ðŸ¢ Company: ${e.company||"Not set"}
ðŸ“Œ Status: ${e.status||"New"}`}return"âœ… Contact created successfully";case"update_contact":if(s?.changes&&s.changes.length>0)return`âœ… Updated contact:
`+s.changes.map(e=>`â€¢ ${e}`).join("\n");return"âœ… Contact updated successfully";case"search_contacts":if(s?.contacts&&s.contacts.length>0){let e=`Found ${s.count} contact${s.count>1?"s":""}:

`;return s.contacts.slice(0,5).forEach(t=>{e+=`â€¢ **${t.firstName} ${t.lastName||""}** - ${t.email||"No email"} (${t.status||"new"})
`}),s.count>5&&(e+=`...and ${s.count-5} more`),e}return"No contacts found matching your search.";case"list_contacts":if(s?.contacts&&s.contacts.length>0){let e=`ðŸ“‹ ${s.count} contact${s.count>1?"s":""}:

`;return s.contacts.slice(0,10).forEach(t=>{e+=`â€¢ **${t.firstName} ${t.lastName||""}** - ${t.email||"No email"} (${t.status||"new"})
`}),e}return"No contacts found.";case"list_pipelines":if(s?.pipelines&&s.pipelines.length>0){let e=`ðŸ“Š ${s.count} pipeline${s.count>1?"s":""}:

`;return s.pipelines.forEach(t=>{e+=`â€¢ **${t.name}** - ${t.stage_count} stages, ${t.deal_count} deals ($${t.total_value?.toLocaleString()||0})
`,t.stages&&t.stages.length>0&&(e+=`  Stages: ${t.stages.join(" â†’ ")}
`)}),e}return"No pipelines found. Would you like me to create one?";case"delete_contact":return"âœ… Contact deleted successfully";case"delete_pipeline":return`âœ… Pipeline deleted${s?.deals_moved?` (${s.deals_moved} deals moved)`:""}`;case"create_deal":if(s?.deal)return`âœ… Created deal **${s.deal.name}**
ðŸ’° Value: $${s.deal.value?.toLocaleString()||0}
ðŸ“Š Stage: ${s.deal.stage||"New"}`;return"âœ… Deal created successfully";case"create_task":if(s?.task)return`âœ… Created task **${s.task.title}**
ðŸ“… Due: ${s.task.due_date||"No due date"}
âš¡ Priority: ${s.task.priority||"medium"}`;return"âœ… Task created successfully";case"send_email":return`âœ… ${s?.action==="email_sent"?"Email sent":"Email draft created"} for ${s?.contact?.firstName||"contact"}`;case"send_sms":return`âœ… SMS queued for ${s?.contact?.phone||"contact"}`;case"schedule_appointment":return`âœ… Appointment "${s?.appointment?.title||"Meeting"}" scheduled`;case"get_dashboard_stats":if(s)return`ðŸ“Š Dashboard Stats:
â€¢ Total Contacts: ${s.total_contacts||0}
â€¢ Deals in Pipeline: ${s.deals_in_pipeline||0}
â€¢ Pipeline Value: $${(s.pipeline_value||0).toLocaleString()}
â€¢ Tasks Due Today: ${s.tasks_due_today||0}`;return"ðŸ“Š Dashboard stats retrieved";case"get_pipeline_stats":if(s)return`ðŸ“Š Pipeline Stats:
â€¢ Total Pipelines: ${s.total_pipelines||0}
â€¢ Total Deals: ${s.total_deals||0}
â€¢ Total Value: $${(s.total_value||0).toLocaleString()}
â€¢ Won/Lost: ${s.won_deals||0}/${s.lost_deals||0}`;return"ðŸ“Š Pipeline stats retrieved";case"get_marketing_playbook":if(s){let e=`ðŸ“š **${s.industry} Marketing Playbook**

`;return e+=`**Overview:** ${s.overview}

`,s.target_audiences?.length&&(e+=`**Target Audiences:**
${s.target_audiences.map(e=>`â€¢ ${e}`).join("\n")}

`),s.channel_priorities?.length&&(e+=`**Top Channels:**
`,s.channel_priorities.forEach(t=>{e+=`${t.priority}. **${t.channel}** - ${t.description}
`}),e+="\n"),s.kpis?.length&&(e+=`**Key KPIs:** ${s.kpis.slice(0,5).join(", ")}

`),s.common_mistakes?.length&&(e+=`**âš ï¸ Common Mistakes to Avoid:**
${s.common_mistakes.map(e=>`â€¢ ${e}`).join("\n")}`),e}return"ðŸ“š Marketing playbook retrieved";case"get_marketing_recommendations":if(s){let e=`ðŸŽ¯ **Marketing Recommendations**

`;return s.recommended_channels?.length&&(e+=`**Recommended Channels:**
${s.recommended_channels.map(e=>`â€¢ ${e}`).join("\n")}

`),s.quick_wins?.length&&(e+=`**ðŸš€ Quick Wins:**
${s.quick_wins.map(e=>`â€¢ ${e}`).join("\n")}

`),s.tactics?.length&&(e+=`**Tactics to Consider:**
${s.tactics.slice(0,5).map(e=>`â€¢ ${e}`).join("\n")}

`),s.kpis_to_track?.length&&(e+=`**ðŸ“Š KPIs to Track:** ${s.kpis_to_track.slice(0,5).join(", ")}`),e}return"ðŸŽ¯ Marketing recommendations generated";case"get_funnel_strategy":if(s){if(s.funnel_stages){let e=`ðŸŽ¯ **Marketing Funnel Strategy**

`;return s.funnel_stages.forEach(t=>{e+=`**${t.name}**
Goal: ${t.goal}
Content: ${t.contentTypes?.slice(0,3).join(", ")}
Metrics: ${t.metrics?.slice(0,3).join(", ")}

`}),e}else if(s.stage)return`ðŸŽ¯ **${s.name}**

**Goal:** ${s.goal}

**Content Types:**
${s.contentTypes?.map(e=>`â€¢ ${e}`).join("\n")}

**Metrics:** ${s.metrics?.join(", ")}

**Channels:** ${s.channels?.join(", ")}`}return"ðŸŽ¯ Funnel strategy retrieved";case"get_channel_guide":if(s)return`ðŸ“¢ **${s.name}**

${s.description}

Use the full tool result for detailed components and best practices.`;return"ðŸ“¢ Channel guide retrieved";case"get_audience_insights":if(s?.segment_type&&s.segments){let e=`ðŸ‘¥ **${s.segment_type.charAt(0).toUpperCase()+s.segment_type.slice(1)} Segments**

`;return Object.entries(s.segments).forEach(([t,s])=>{e+=`**${s.name||t}:** ${s.approach||s.characteristics?.join(", ")}
`}),e}return"ðŸ‘¥ Audience insights retrieved";case"get_campaign_template":if(s){let e=`ðŸ“‹ **${s.name}**

`;return s.steps?e+=`**Steps:**
${s.steps.map((e,t)=>`${t+1}. ${e}`).join("\n")}`:s.phases?Object.entries(s.phases).forEach(([t,s])=>{e+=`**${t.charAt(0).toUpperCase()+t.slice(1)}:**
${s.map(e=>`â€¢ ${e}`).join("\n")}

`}):s.emails&&(e+=`**Email Sequence:**
`,s.emails.forEach(t=>{e+=`Day ${t.day}: ${t.subject}
`})),e}return"ðŸ“‹ Campaign template retrieved";case"get_marketing_metrics":if(s){let e=`ðŸ“Š **Marketing Metrics**

`;return s.category&&s.metrics?(e+=`**${s.category.charAt(0).toUpperCase()+s.category.slice(1)} Metrics:**
`,s.metrics.forEach(t=>{e+=`â€¢ **${t.name}**: ${t.description}
`})):s.categories&&Object.entries(s.categories).forEach(([t,s])=>{e+=`**${t.charAt(0).toUpperCase()+t.slice(1)}:**
`,s.slice(0,2).forEach(t=>{e+=`â€¢ ${t.name}
`}),e+="\n"}),e}return"ðŸ“Š Marketing metrics retrieved";default:return s?.message||`âœ… ${e.replace(/_/g," ")} completed successfully`}}async executeTool(e,t){try{switch(e){case"search_contacts":return await this.toolSearchContacts(t);case"get_contact":return await this.toolGetContact(t);case"create_contact":return await this.toolCreateContact(t);case"update_contact":return await this.toolUpdateContact(t);case"delete_contact":return await this.toolDeleteContact(t);case"list_contacts":return await this.toolListContacts(t);case"bulk_update_contacts":return await this.toolBulkUpdateContacts(t);case"create_deal":return await this.toolCreateDeal(t);case"update_deal":return await this.toolUpdateDeal(t);case"get_pipeline_stats":return await this.toolGetPipelineStats(t);case"create_pipeline":return await this.toolCreatePipeline(t);case"list_pipelines":return await this.toolListPipelines(t);case"update_pipeline":return await this.toolUpdatePipeline(t);case"delete_pipeline":return await this.toolDeletePipeline(t);case"get_pipeline":return await this.toolGetPipeline(t);case"list_deals":return await this.toolListDeals(t);case"create_task":return await this.toolCreateTask(t);case"list_tasks":return await this.toolListTasks(t);case"complete_task":return await this.toolCompleteTask(t);case"send_email":return await this.toolSendEmail(t);case"send_sms":return await this.toolSendSMS(t);case"log_activity":return await this.toolLogActivity(t);case"schedule_appointment":return await this.toolScheduleAppointment(t);case"get_availability":return await this.toolGetAvailability(t);case"create_email_campaign":return await this.toolCreateEmailCampaign(t);case"get_campaign_stats":return await this.toolGetCampaignStats(t);case"get_dashboard_stats":return await this.toolGetDashboardStats(t);case"generate_report":return await this.toolGenerateReport(t);case"trigger_workflow":return await this.toolTriggerWorkflow(t);case"list_workflows":return await this.toolListWorkflows(t);case"get_marketing_playbook":return await this.toolGetMarketingPlaybook(t);case"get_marketing_recommendations":return await this.toolGetMarketingRecommendations(t);case"get_funnel_strategy":return await this.toolGetFunnelStrategy(t);case"get_channel_guide":return await this.toolGetChannelGuide(t);case"get_audience_insights":return await this.toolGetAudienceInsights(t);case"get_campaign_template":return await this.toolGetCampaignTemplate(t);case"get_marketing_metrics":return await this.toolGetMarketingMetrics(t);default:return{success:!1,error:`Unknown tool: ${e}`}}}catch(t){return console.error(`Tool ${e} error:`,t),{success:!1,error:t.message}}}async toolSearchContacts(e){let{query:t,status:s,limit:n=10}=e,i=sh.supabaseAdmin.from("Contact").select("*").eq("subAccountId",this.subAccountId).limit(n),a=t.trim().split(/\s+/);i=a.length>=2?i.or(`and(firstName.ilike.%${a[0]}%,lastName.ilike.%${a.slice(1).join(" ")}%),email.ilike.%${t}%,company.ilike.%${t}%`):i.or(`firstName.ilike.%${t}%,lastName.ilike.%${t}%,email.ilike.%${t}%,phone.ilike.%${t}%,company.ilike.%${t}%`),s&&(i=i.eq("status",s));let{data:r,error:o}=await i.order("createdAt",{ascending:!1});if(o)throw o;return{success:!0,data:{contacts:r||[],count:r?.length||0}}}async toolGetContact(e){let t=sh.supabaseAdmin.from("Contact").select("*").eq("subAccountId",this.subAccountId);if(e.contact_id)t=t.eq("id",e.contact_id);else if(e.email)t=t.ilike("email",e.email);else{if(!this.activeContact)return{success:!1,error:"No contact specified"};t=t.eq("id",this.activeContact.id)}let{data:s,error:n}=await t.single();if(n)throw n;return{success:!0,data:{contact:s}}}async toolCreateContact(e){let t={subAccountId:this.subAccountId,firstName:e.firstName,lastName:e.lastName||"",email:e.email||null,phone:e.phone||null,company:e.company||null,status:e.status||"new",tags:e.tags||[],source:e.source||"manual",score:50},{data:s,error:n}=await sh.supabaseAdmin.from("Contact").insert(t).select().single();if(n)throw n;return{success:!0,data:{contact:s}}}async toolUpdateContact(e){let t=e.contact_id||this.activeContact?.id;if(!t)return{success:!1,error:"No contact specified for update"};let s={lastActivityAt:new Date().toISOString()},n=[];if(e.email&&(s.email=e.email,n.push(`email â†’ ${e.email}`)),e.phone&&(s.phone=e.phone,n.push(`phone â†’ ${e.phone}`)),e.firstName&&(s.firstName=e.firstName,n.push(`first name â†’ ${e.firstName}`)),e.lastName&&(s.lastName=e.lastName,n.push(`last name â†’ ${e.lastName}`)),e.company&&(s.company=e.company,n.push(`company â†’ ${e.company}`)),e.status&&(s.status=e.status,n.push(`status â†’ ${e.status}`)),e.tags&&e.tags.length>0){let{data:i}=await sh.supabaseAdmin.from("Contact").select("tags").eq("id",t).single();s.tags=[...new Set([...i?.tags||[],...e.tags])],n.push(`added tags: ${e.tags.join(", ")}`)}if(0===n.length)return{success:!1,error:"No changes specified"};let{data:i,error:a}=await sh.supabaseAdmin.from("Contact").update(s).eq("id",t).eq("subAccountId",this.subAccountId).select().single();if(a)throw a;return{success:!0,data:{contact:i,changes:n}}}async toolDeleteContact(e){let{error:t}=await sh.supabaseAdmin.from("Contact").delete().eq("id",e.contact_id).eq("subAccountId",this.subAccountId);if(t)throw t;return{success:!0,data:{deleted:!0,contact_id:e.contact_id}}}async toolListContacts(e){let{status:t,limit:s=20,include_stats:n=!1,sort_by:i="createdAt",sort_order:a="desc"}=e,r=sh.supabaseAdmin.from("Contact").select("*").eq("subAccountId",this.subAccountId).limit(s);t&&(r=r.eq("status",t)),r=r.order(i,{ascending:"asc"===a});let{data:o,error:l}=await r;if(l)throw l;let c=null;if(n){let{data:e}=await sh.supabaseAdmin.from("Contact").select("status").eq("subAccountId",this.subAccountId);e&&(c={total:e.length,byStatus:e.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{})})}return{success:!0,data:{contacts:o||[],count:o?.length||0,stats:c}}}async toolBulkUpdateContacts(e){let t={lastActivityAt:new Date().toISOString()};e.status&&(t.status=e.status),e.tags&&(t.tags=e.tags);let{data:s,error:n}=await sh.supabaseAdmin.from("Contact").update(t).in("id",e.contact_ids).eq("subAccountId",this.subAccountId).select();if(n)throw n;return{success:!0,data:{updated:s?.length||0,contacts:s}}}async toolCreateDeal(e){return{success:!0,data:{deal:{name:e.name,value:e.value||0,stage:e.stage||"New",contact_id:e.contact_id},message:`Deal "${e.name}" created successfully`}}}async toolUpdateDeal(e){return{success:!0,data:{deal_id:e.deal_id,changes:e,message:"Deal updated successfully"}}}async toolGetPipelineStats(e){try{let{data:e}=await sh.supabaseAdmin.from("Pipeline").select("*, stages:PipelineStage(*), deals:Deal(*)").eq("subAccountId",this.subAccountId);if(!e||0===e.length)return{success:!0,data:{total_pipelines:0,total_deals:0,total_value:0,message:"No pipelines found. Create one to get started!"}};let t=0,s=0,n=0,i=0;return e.forEach(e=>{e.deals&&(t+=e.deals.length,e.deals.forEach(e=>{s+=parseFloat(e.value)||0,"won"===e.status&&n++,"lost"===e.status&&i++}))}),{success:!0,data:{total_pipelines:e.length,total_deals:t,total_value:s,won_deals:n,lost_deals:i,open_deals:t-n-i,conversion_rate:t>0?(n/t).toFixed(2):0}}}catch(e){return{success:!0,data:{total_deals:0,total_value:0,message:"Pipeline system ready - create your first pipeline!"}}}}async toolCreatePipeline(e){let t=s3(),s=e.stages,n=e.name.toLowerCase(),i=e.pipeline_type||(n.includes("real estate")||n.includes("property")?"real_estate":n.includes("recruit")||n.includes("hiring")?"recruiting":n.includes("consult")?"consulting":n.includes("saas")||n.includes("software")?"saas":"sales"),a={real_estate:[{name:"Lead",probability:10},{name:"Qualified",probability:25},{name:"Property Shown",probability:40},{name:"Offer Made",probability:60},{name:"Under Contract",probability:80},{name:"Closed Won",probability:100}],sales:[{name:"Lead",probability:10},{name:"Qualified",probability:25},{name:"Demo",probability:40},{name:"Proposal",probability:60},{name:"Negotiation",probability:80},{name:"Closed Won",probability:100}],consulting:[{name:"Inquiry",probability:10},{name:"Discovery Call",probability:25},{name:"Proposal Sent",probability:50},{name:"Contract Review",probability:75},{name:"Engaged",probability:100}],saas:[{name:"Lead",probability:10},{name:"Qualified",probability:20},{name:"Demo Scheduled",probability:35},{name:"Demo Completed",probability:50},{name:"Trial",probability:65},{name:"Negotiation",probability:80},{name:"Closed Won",probability:100}],recruiting:[{name:"Applied",probability:10},{name:"Screening",probability:25},{name:"Interview 1",probability:40},{name:"Interview 2",probability:60},{name:"Offer",probability:80},{name:"Hired",probability:100}]},r=s&&s.length>0?s.map((e,t)=>({name:e,probability:Math.round((t+1)/s.length*100)})):a[i]||a.sales,{data:o,error:l}=await sh.supabaseAdmin.from("Pipeline").insert({id:t,subAccountId:this.subAccountId,name:e.name,description:e.description||`${e.name} pipeline`}).select().single(),c=r.map((e,s)=>({id:s3(),pipelineId:t,name:e.name,displayOrder:s,winProbability:e.probability,stageType:100===e.probability?"won":"open"}));if(l)return console.error("Pipeline creation error:",l),{success:!1,error:`Failed to create pipeline: ${l.message||"Database error"}`};let{error:u}=await sh.supabaseAdmin.from("PipelineStage").insert(c);return u?(console.error("Stages creation error:",u),await sh.supabaseAdmin.from("Pipeline").delete().eq("id",t),{success:!1,error:`Failed to create pipeline stages: ${u.message||"Database error"}`}):{success:!0,data:{pipeline:{...o,stages:c.map(e=>({id:e.id,name:e.name,order:e.displayOrder,probability:e.winProbability}))},stages_created:c.length,stage_flow:c.map(e=>e.name).join(" â†’ ")}}}async toolListPipelines(e){try{let{data:e,error:t}=await sh.supabaseAdmin.from("Pipeline").select("*, stages:PipelineStage(id, name, displayOrder, winProbability), deals:Deal(id, value, status)").eq("subAccountId",this.subAccountId).order("createdAt",{ascending:!1});if(t)throw t;let s=(e||[]).map(e=>({id:e.id,name:e.name,description:e.description,stages:(e.stages||[]).sort((e,t)=>e.displayOrder-t.displayOrder).map(e=>e.name),stage_count:e.stages?.length||0,deal_count:e.deals?.length||0,total_value:e.deals?.reduce((e,t)=>e+(parseFloat(t.value)||0),0)||0}));return{success:!0,data:{pipelines:s,count:s.length}}}catch(e){return{success:!0,data:{pipelines:[],count:0,message:"No pipelines found. Would you like me to create one?"}}}}async toolUpdatePipeline(e){let t=[];if(e.name&&(await sh.supabaseAdmin.from("Pipeline").update({name:e.name}).eq("id",e.pipeline_id).eq("subAccountId",this.subAccountId),t.push(`name â†’ ${e.name}`)),e.stages){await sh.supabaseAdmin.from("PipelineStage").delete().eq("pipelineId",e.pipeline_id);let s=e.stages,n=s.map((t,n)=>({id:s3(),pipelineId:e.pipeline_id,name:t,displayOrder:n,winProbability:Math.round((n+1)/s.length*100)}));await sh.supabaseAdmin.from("PipelineStage").insert(n),t.push(`stages updated to: ${e.stages.join(" â†’ ")}`)}if(e.add_stage){let{data:s}=await sh.supabaseAdmin.from("PipelineStage").select("displayOrder").eq("pipelineId",e.pipeline_id).order("displayOrder",{ascending:!1}).limit(1).single();await sh.supabaseAdmin.from("PipelineStage").insert({id:s3(),pipelineId:e.pipeline_id,name:e.add_stage,displayOrder:(s?.displayOrder||0)+1}),t.push(`added stage: ${e.add_stage}`)}return e.remove_stage&&(await sh.supabaseAdmin.from("PipelineStage").delete().eq("pipelineId",e.pipeline_id).eq("name",e.remove_stage),t.push(`removed stage: ${e.remove_stage}`)),{success:!0,data:{pipeline_id:e.pipeline_id,changes:t,message:t.length>0?`Pipeline updated: ${t.join(", ")}`:"No changes made"}}}async toolDeletePipeline(e){let{data:t}=await sh.supabaseAdmin.from("Deal").select("id").eq("pipelineId",e.pipeline_id);if(t&&t.length>0&&!e.move_deals_to)return{success:!1,error:`Pipeline has ${t.length} deals. Please specify where to move them using move_deals_to parameter, or delete deals first.`};e.move_deals_to&&t&&t.length>0&&await sh.supabaseAdmin.from("Deal").update({pipelineId:e.move_deals_to}).eq("pipelineId",e.pipeline_id),await sh.supabaseAdmin.from("PipelineStage").delete().eq("pipelineId",e.pipeline_id);let{error:s}=await sh.supabaseAdmin.from("Pipeline").delete().eq("id",e.pipeline_id).eq("subAccountId",this.subAccountId);if(s)throw s;return{success:!0,data:{deleted:!0,pipeline_id:e.pipeline_id,deals_moved:e.move_deals_to?t?.length:0,message:"Pipeline deleted successfully"}}}async toolGetPipeline(e){let t=sh.supabaseAdmin.from("Pipeline").select("*, stages:PipelineStage(id, name, displayOrder, winProbability, color)").eq("subAccountId",this.subAccountId);e.pipeline_id?t=t.eq("id",e.pipeline_id):e.name&&(t=t.ilike("name",`%${e.name}%`));let{data:s,error:n}=await t.single();return n||!s?{success:!1,error:"Pipeline not found"}:{success:!0,data:{pipeline:{...s,stages:(s.stages||[]).sort((e,t)=>e.displayOrder-t.displayOrder).map(e=>({id:e.id,name:e.name,order:e.displayOrder,probability:e.winProbability,color:e.color}))}}}}async toolListDeals(e){let{limit:t=20}=e,s=sh.supabaseAdmin.from("Deal").select("*, Contact(firstName, lastName, email), Pipeline(name), PipelineStage(name)").eq("subAccountId",this.subAccountId).limit(t);e.pipeline_id&&(s=s.eq("pipelineId",e.pipeline_id)),e.stage&&(s=s.eq("stageId",e.stage)),e.status&&"all"!==e.status&&(s=s.eq("status",e.status)),e.contact_id&&(s=s.eq("contactId",e.contact_id));let{data:n,error:i}=await s.order("createdAt",{ascending:!1});return i?{success:!0,data:{deals:[],count:0,message:"No deals found or Deal table not set up yet."}}:{success:!0,data:{deals:n||[],count:n?.length||0}}}async toolCreateTask(e){return{success:!0,data:{task:{title:e.title,description:e.description,due_date:e.due_date,priority:e.priority||"medium",contact_id:e.contact_id||this.activeContact?.id},message:`Task "${e.title}" created`}}}async toolListTasks(e){return{success:!0,data:{tasks:[],message:"Task listing coming soon"}}}async toolCompleteTask(e){return{success:!0,data:{task_id:e.task_id,status:"completed",message:"Task marked as complete"}}}async toolSendEmail(e){let{data:t}=await sh.supabaseAdmin.from("Contact").select("*").eq("id",e.contact_id).single();return t&&t.email?{success:!0,data:{action:e.send_now?"email_sent":"draft_created",contact:t,subject:e.subject||"",message:e.send_now?`Email sent to ${t.email}`:`Email draft created for ${t.firstName}`}}:{success:!1,error:"Contact not found or has no email"}}async toolSendSMS(e){let{data:t}=await sh.supabaseAdmin.from("Contact").select("*").eq("id",e.contact_id).single();return t&&t.phone?{success:!0,data:{action:"sms_queued",contact:t,message:`SMS queued for ${t.phone}`}}:{success:!1,error:"Contact not found or has no phone number"}}async toolLogActivity(e){return{success:!0,data:{activity:{type:e.type,subject:e.subject,notes:e.notes,contact_id:e.contact_id},message:`${e.type} logged for contact`}}}async toolScheduleAppointment(e){return{success:!0,data:{appointment:{title:e.title,start_time:e.start_time,contact_id:e.contact_id},message:`Appointment "${e.title}" scheduled`}}}async toolGetAvailability(e){return{success:!0,data:{date:e.date,available_slots:["09:00","10:00","14:00","15:00","16:00"],message:`Available times for ${e.date}`}}}async toolCreateEmailCampaign(e){return{success:!0,data:{campaign:{name:e.name,subject:e.subject,status:"draft"},message:`Campaign "${e.name}" created`}}}async toolGetCampaignStats(e){return{success:!0,data:{campaign_id:e.campaign_id,sent:1e3,delivered:980,opened:350,clicked:125,open_rate:.357,click_rate:.127}}}async toolGetDashboardStats(e){let{data:t}=await sh.supabaseAdmin.from("Contact").select("id",{count:"exact"}).eq("subAccountId",this.subAccountId);return{success:!0,data:{total_contacts:t?.length||0,new_contacts_this_week:12,deals_in_pipeline:8,pipeline_value:85e3,tasks_due_today:5}}}async toolGenerateReport(e){return{success:!0,data:{report_type:e.report_type,date_range:e.date_range||"month",message:`${e.report_type} report generated`}}}async toolTriggerWorkflow(e){return{success:!0,data:{workflow_id:e.workflow_id,contact_id:e.contact_id,message:"Contact enrolled in workflow"}}}async toolListWorkflows(e){return{success:!0,data:{workflows:[],message:"Workflow listing coming soon"}}}async toolGetMarketingPlaybook(e){let t=s6(e.industry);if(!t){let t=Object.keys(s9);return{success:!1,error:`Industry "${e.industry}" not found. Available industries: ${t.join(", ")}`}}return{success:!0,data:{industry:t.name,overview:t.overview,target_audiences:t.targetAudiences,channel_priorities:t.channelPriority.slice(0,5),key_strategies:t.keyStrategies,kpis:t.kpis,common_mistakes:t.commonMistakes}}}async toolGetMarketingRecommendations(e){let t=function(e){let t={channels:[],tactics:[],contentTypes:[],kpis:[],quickWins:[],longTermStrategies:[]};if(e.industry){let s=s6(e.industry);s&&(t.channels=s.channelPriority.slice(0,5).map(e=>e.channel),t.kpis=s.kpis,s.keyStrategies.forEach(e=>{t.tactics.push(...e.tactics.slice(0,3))}))}return"low"===e.budget?(t.quickWins=["Optimize Google Business Profile","Start email marketing with free tools","Create social media presence","Write SEO-focused blog content","Ask customers for reviews"],t.channels=t.channels.filter(e=>!e.toLowerCase().includes("paid")&&!e.toLowerCase().includes("advertising"))):"high"===e.budget&&(t.longTermStrategies=["Build comprehensive content hub","Implement marketing automation","Launch multi-channel paid campaigns","Invest in video production","Develop influencer partnerships"]),("small"===e.businessSize||"micro"===e.businessSize)&&t.quickWins.push("Focus on local SEO","Leverage personal network","Create referral program"),t}({industry:e.industry,businessSize:e.business_size,goals:e.goals,budget:e.budget});return{success:!0,data:{recommended_channels:t.channels,tactics:t.tactics,kpis_to_track:t.kpis,quick_wins:t.quickWins,long_term_strategies:t.longTermStrategies,budget_level:e.budget||"medium"}}}async toolGetFunnelStrategy(e){if(e.stage&&"all"!==e.stage){let t=s8[e.stage];return t?{success:!0,data:{stage:e.stage,...t}}:{success:!1,error:"Invalid funnel stage. Use: tofu, mofu, bofu, retention, or all"}}return{success:!0,data:{funnel_stages:[{id:"tofu",...s8.tofu},{id:"mofu",...s8.mofu},{id:"bofu",...s8.bofu},{id:"retention",...s8.retention}]}}}async toolGetChannelGuide(e){let t=s7[e.channel];return t?{success:!0,data:{channel:e.channel,...t}}:{success:!1,error:"Channel not found. Available: seo, ppc, email, social, content"}}async toolGetAudienceInsights(e){if("generational"===e.segment_type){if(e.specific_segment){let t=ne.generational[e.specific_segment];if(t)return{success:!0,data:{segment_type:"generational",segment:e.specific_segment,...t}}}return{success:!0,data:{segment_type:"generational",segments:ne.generational}}}if("b2b"===e.segment_type){if(e.specific_segment){let t=ne.b2b[e.specific_segment];if(t)return{success:!0,data:{segment_type:"b2b",segment:e.specific_segment,...t}}}return{success:!0,data:{segment_type:"b2b",segments:ne.b2b}}}return{success:!0,data:{available_segments:{generational:["genZ","millennials","genX","boomers"],b2b:["enterprise","midMarket","smallBusiness","microBusiness"]},tip:"Use segment_type to get detailed insights for a specific type"}}}async toolGetCampaignTemplate(e){let t=ns[e.campaign_type];return t?{success:!0,data:{campaign_type:e.campaign_type,...t}}:{success:!1,error:"Template not found. Available: lead_generation, product_launch, email_nurture, retargeting"}}async toolGetMarketingMetrics(e){if(e.category&&"all"!==e.category){let t=nt[e.category];return t?{success:!0,data:{category:e.category,metrics:t}}:{success:!1,error:"Category not found. Use: acquisition, engagement, retention, revenue, or all"}}return{success:!0,data:{categories:{acquisition:nt.acquisition,engagement:nt.engagement,retention:nt.retention,revenue:nt.revenue}}}}buildSystemPrompt(){let e=`You are Sarah, the AI Virtual Assistant for RISIVO CRM - an intelligent, comprehensive CRM platform.

## CORE PHILOSOPHY: THE 10/90 MODEL
User provides 10% strategic direction, AI executes 90% of work
- Users provide 10% strategic direction, you execute 90% of the work
- Time savings: 95%+ on routine tasks (e.g., report generation in 45 seconds vs 6-8 hours manually)

## CORE BEHAVIOR RULES:
1. **EXECUTE IMMEDIATELY** - No unnecessary "are you sure?" confirmations for routine actions
2. **SHOW RESULTS CLEARLY** - After any action, display what was created/updated with full details
3. **USE REAL DATA ONLY** - Never make up information; use only data from tools
4. **REMEMBER CONTEXT** - When user says "him/her/they", refer to the active contact
5. **SMART DEFAULTS** - Use industry-appropriate defaults when specifics aren't provided

## AI AUTONOMY LEVELS:
Level 1 - Fully Autonomous (execute immediately): ${nn.slice(0,5).join(", ")}, etc.
Level 2 - Autonomous with Notification: ${ni.slice(0,4).join(", ")}, etc.
Level 3 - Requires Approval: ${na.slice(0,4).join(", ")}, etc.

## CRM CAPABILITIES (25 Modules, 149+ Integrations):

### 1. Contact Management
- Create, search, update, delete, list, bulk operations
- AI-powered contact enrichment (company info, social profiles, job title, etc.)
- Lead scoring (0-100): Hot Lead (80-100), Warm Lead (60-79), Cold Lead (40-59), Low Priority (0-39)
- Common commands: "Add contact [name]", "Find contacts from [company]", "Enrich all contacts"

### 2. Pipeline Management
- Default stages by industry:
  * Real Estate: Lead â†’ Qualified â†’ Property Shown â†’ Offer Made â†’ Under Contract â†’ Closed Won
  * Sales: Lead â†’ Qualified â†’ Demo â†’ Proposal â†’ Negotiation â†’ Closed Won
  * SaaS: Lead â†’ Qualified â†’ Demo Scheduled â†’ Demo Completed â†’ Trial â†’ Negotiation â†’ Closed Won
  * Consulting: Inquiry â†’ Discovery Call â†’ Proposal Sent â†’ Contract Review â†’ Engaged
  * Recruiting: Applied â†’ Screening â†’ Interview 1 â†’ Interview 2 â†’ Offer â†’ Hired
- AI Deal Intelligence: monitors deal health, stage duration, champion engagement, competitive signals

### 3. Marketing Hub
- Email campaigns, SMS, social media scheduling
- Multi-platform ads (Google, Facebook, Instagram, LinkedIn, TikTok)
- Common commands: "Create email campaign", "Schedule post on [platform]", "Show ad performance"

### 4. Project Management
- Kanban boards, Gantt charts, resource allocation, time tracking
- Commands: "Create project [name]", "Show overdue tasks", "Who has capacity?"

### 5. Workflows & Automations
- Triggers: Contact Created, Form Submitted, Email Opened, Deal Stage Changed, etc.
- Actions: Send Email, Send SMS, Create Task, Update Contact, Add Tag, etc.
- Commands: "Create workflow for [trigger]", "Show workflow statistics"

### 6. Communications
- Unified inbox: Email, SMS, Phone, WhatsApp, Facebook, Instagram, Live Chat
- Calendar & scheduling with booking pages

### 7. Media Vault
- Digital asset management with AI tagging
- Image generation and editing
- Commands: "Generate image of [description]", "Remove background from [image]"

### 8. Funnels & Websites
- AI-powered funnel creation: Lead Gen, Sales, Webinar, Product Launch
- Website builder with templates

### 9. Revenue Engine
- Invoicing, payments, subscriptions
- Integrations: Stripe, PayPal, Square

### 10. Analytics & Reporting
- Custom dashboards, automated reports
- KPIs: CPL, CPA, CAC, Conversion Rate, CLV, ROAS

### 11. SEO Module
- Site audits, keyword research, content optimization
- Commands: "Audit website SEO", "Find keyword opportunities for [topic]"

### 12. Reputation Management
- Review monitoring across Google, Facebook, Yelp, etc.
- AI response generation

## MARKETING STRATEGY EXPERTISE:

Use these marketing tools for data-driven advice:

1. **get_marketing_playbook**: Industry-specific strategies for Real Estate, E-Commerce, SaaS, Healthcare, Professional Services
2. **get_marketing_recommendations**: Personalized advice based on industry, business size, goals, budget
3. **get_funnel_strategy**: TOFU/MOFU/BOFU/Retention strategies
4. **get_channel_guide**: Deep guides for SEO, PPC, Email, Social, Content
5. **get_audience_insights**: Generational and B2B segmentation
6. **get_campaign_template**: Templates for lead gen, product launch, email nurture, retargeting
7. **get_marketing_metrics**: KPI formulas and benchmarks

## RESPONSE FORMAT:
- Use bullet points and numbered lists for clarity
- **Bold** important values, names, and metrics
- Show success confirmation WITH actual data
- Include next steps or suggestions when helpful

Example pipeline creation response:
"âœ… Created **Real Estate Leads** pipeline with 6 stages:
1. Lead (10% probability)
2. Qualified (25% probability)
3. Property Shown (40% probability)
4. Offer Made (60% probability)
5. Under Contract (80% probability)
6. Closed Won (100% probability)

You can now add deals to this pipeline!"

## PERSONALIZATION:
- Address user by first name naturally (don't overuse)
- Be conversational and helpful like a smart colleague
- Remember context from conversation history
- Don't repeat greetings or introductions
`;return this.userInfo&&(e+=`
CURRENT USER:
- Name: ${this.userInfo.name}
- First Name: ${this.userInfo.firstName}
- Email: ${this.userInfo.email||"Not set"}
- ID: ${this.userInfo.id}

Address this user naturally using their first name (${this.userInfo.firstName}) when it makes sense.
Don't overuse their name - be natural like a helpful colleague would be.
`),this.activeContact&&(e+=`
ACTIVE CONTACT (CRM Contact being discussed):
- Name: ${this.activeContact.firstName} ${this.activeContact.lastName||""}
- Email: ${this.activeContact.email||"Not set"}
- Phone: ${this.activeContact.phone||"Not set"}
- Status: ${this.activeContact.status||"New"}
- Company: ${this.activeContact.company||"Not set"}
- ID: ${this.activeContact.id}

Pronouns (his/her/their) and "the contact" refer to this CRM contact, not the current user.
`),e}}async function nc(e){try{let t=await e.json(),{message:s,sessionId:n,subAccountId:i,userId:a,userName:r,userEmail:o}=t,l=n||t.conversationId,c={id:a,name:r||"User",email:o,firstName:r?.split(" ")[0]||"there"};if(!s||"string"!=typeof s)return eN.NextResponse.json({success:!1,error:"Message is required and must be a string"},{status:400});if(!i||!a)return eN.NextResponse.json({success:!1,error:"subAccountId and userId are required"},{status:400});if(!process.env.ANTHROPIC_API_KEY)return console.error("ANTHROPIC_API_KEY is not set"),eN.NextResponse.json({success:!1,error:"AI service not configured. Please set ANTHROPIC_API_KEY.",data:{message:{id:s3(),role:"assistant",content:"I'm currently unavailable. Please contact support to configure the AI service.",createdAt:new Date().toISOString()}}},{status:500});let{data:u}=await sh.supabaseAdmin.from("AiAssistantConfig").select("*").eq("subAccountId",i).single();if(!u){let{data:e}=await sh.supabaseAdmin.from("AiAssistantConfig").insert({id:s3(),subAccountId:i,name:"Sarah",welcomeMessage:"Hi! I'm your AI assistant. How can I help you today?"}).select().single();u=e}let d=l,p=[],h=null;if(d){let{data:e}=await sh.supabaseAdmin.from("AiChatMessage").select("role, content, contextSnapshot, toolName, toolResult").eq("sessionId",d).order("createdAt",{ascending:!0}).limit(u?.maxContextMessages||20);p=e||[],h=function(e){for(let t=e.length-1;t>=0;t--){let s=e[t];if("assistant"===s.role&&s.contextSnapshot?.activeContact)return s.contextSnapshot.activeContact}return null}(p)}else d=s3(),await sh.supabaseAdmin.from("AiChatSession").insert({id:d,subAccountId:i,configId:u?.id,userId:a,title:s.substring(0,50),status:"active",channel:"crm_chat",messageCount:0,toolCalls:0});let m=new nl(i,c),g=p.filter(e=>"user"===e.role||"assistant"===e.role).map(e=>({role:e.role,content:e.content})),f=await m.chat(s,g,h),y=s3();await sh.supabaseAdmin.from("AiChatMessage").insert({id:y,sessionId:d,role:"user",content:s,inputTokens:Math.ceil(s.length/4)});let b=h;f.data?.contact?b=f.data.contact:f.data?.contacts&&f.data.contacts.length>0&&(b=f.data.contacts[0]);let w=f.message,_=s3();if(await sh.supabaseAdmin.from("AiChatMessage").insert({id:_,sessionId:d,role:"assistant",content:w,outputTokens:Math.ceil(w.length/4),toolName:f.toolsUsed?.[0]||null,toolResult:f.data||null,contextSnapshot:b?{activeContact:b}:null}),await sh.supabaseAdmin.from("AiChatSession").update({messageCount:p.length+2,toolCalls:f.toolsUsed?.length||0,lastMessageAt:new Date().toISOString(),activeContactId:b?.id||null}).eq("id",d),f.toolsUsed&&f.toolsUsed.length>0)for(let e of f.toolsUsed)await sh.supabaseAdmin.from("AiToolExecution").insert({id:s3(),subAccountId:i,sessionId:d,messageId:_,toolName:e,input:{},result:f.data||{},status:f.success?"success":"failed"});return eN.NextResponse.json({success:!0,data:{sessionId:d,conversationId:d,message:{id:_,role:"assistant",content:w,createdAt:new Date().toISOString()},toolsUsed:f.toolsUsed,activeContact:b,assistantName:u?.name||"Sarah"}})}catch(t){console.error("AI Chat API Error:",t);let e="Sorry, I encountered an error. Please try again.";return t.message?.includes("API key")?e="AI service authentication failed. Please check the API configuration.":t.message?.includes("rate limit")&&(e="AI service is temporarily busy. Please wait a moment and try again."),eN.NextResponse.json({success:!1,error:t.message||"Internal server error",data:{message:{id:s3(),role:"assistant",content:e,createdAt:new Date().toISOString()}}},{status:500})}}async function nu(e){try{let{searchParams:t}=new URL(e.url),s=t.get("sessionId")||t.get("conversationId");if(!s)return eN.NextResponse.json({success:!1,error:"sessionId is required"},{status:400});let{data:n}=await sh.supabaseAdmin.from("AiChatSession").select("*, AiAssistantConfig(*)").eq("id",s).single(),{data:i}=await sh.supabaseAdmin.from("AiChatMessage").select("*").eq("sessionId",s).order("createdAt",{ascending:!0}),a=null;if(i&&i.length>0){for(let e=i.length-1;e>=0;e--)if(i[e].contextSnapshot?.activeContact){a=i[e].contextSnapshot.activeContact;break}}return eN.NextResponse.json({success:!0,data:{sessionId:s,conversationId:s,session:n,messages:i||[],activeContact:a,assistantConfig:n?.AiAssistantConfig}})}catch(e){return console.error("AI Chat GET Error:",e),eN.NextResponse.json({success:!1,error:e.message||"Internal server error"},{status:500})}}e.s(["GET",()=>nu,"POST",()=>nc],72682);var nd=e.i(72682);let np=new ef.AppRouteRouteModule({definition:{kind:ey.RouteKind.APP_ROUTE,page:"/api/v1/ai/chat/route",pathname:"/api/v1/ai/chat",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/ai/chat/route.ts",nextConfigOutput:"",userland:nd}),{workAsyncStorage:nh,workUnitAsyncStorage:nm,serverHooks:ng}=np;function nf(){return(0,eb.patchFetch)({workAsyncStorage:nh,workUnitAsyncStorage:nm})}async function ny(e,t,s){np.isDev&&(0,ew.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let n="/api/v1/ai/chat/route";n=n.replace(/\/index$/,"")||"/";let i=await np.prepare(e,t,{srcPage:n,multiZoneDraftMode:!1});if(!i)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:a,params:r,nextConfig:o,parsedUrl:l,isDraftMode:c,prerenderManifest:u,routerServerContext:d,isOnDemandRevalidate:p,revalidateOnlyGenerated:h,resolvedPathname:m,clientReferenceManifest:g,serverActionsManifest:f}=i,y=(0,eS.normalizeAppPath)(n),b=!!(u.dynamicRoutes[y]||u.routes[m]),w=async()=>((null==d?void 0:d.render404)?await d.render404(e,t,l,!1):t.end("This page could not be found"),null);if(b&&!c){let e=!!u.routes[m],t=u.dynamicRoutes[y];if(t&&!1===t.fallback&&!e){if(o.experimental.adapterPath)return await w();throw new eT.NoFallbackError}}let _=null;!b||np.isDev||c||(_="/index"===(_=m)?"/":_);let v=!0===np.isDev||!b,k=b&&!v;f&&g&&(0,ev.setReferenceManifestsSingleton)({page:n,clientReferenceManifest:g,serverActionsManifest:f,serverModuleMap:(0,ek.createServerModuleMap)({serverActionsManifest:f})});let S=e.method||"GET",A=(0,e_.getTracer)(),C=A.getActiveScopeSpan(),P={params:r,prerenderManifest:u,renderOpts:{experimental:{authInterrupts:!!o.experimental.authInterrupts},cacheComponents:!!o.cacheComponents,supportsDynamicResponse:v,incrementalCache:(0,ew.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:o.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,n)=>np.onRequestError(e,t,n,d)},sharedContext:{buildId:a}},R=new eA.NodeNextRequest(e),I=new eA.NodeNextResponse(t),E=eC.NextRequestAdapter.fromNodeNextRequest(R,(0,eC.signalFromNodeResponse)(t));try{let i=async e=>np.handle(E,P).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=A.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==eP.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=s.get("next.route");if(i){let t=`${S} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${S} ${n}`)}),a=!!(0,ew.getRequestMeta)(e,"minimalMode"),r=async r=>{var l,m;let g=async({previousCacheEntry:o})=>{try{if(!a&&p&&h&&!o)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(r);e.fetchMetrics=P.renderOpts.fetchMetrics;let l=P.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let c=P.renderOpts.collectedTags;if(!b)return await (0,eI.sendResponse)(R,I,n,P.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,eE.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[eM.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==P.renderOpts.collectedRevalidate&&!(P.renderOpts.collectedRevalidate>=eM.INFINITE_CACHE)&&P.renderOpts.collectedRevalidate,i=void 0===P.renderOpts.collectedExpire||P.renderOpts.collectedExpire>=eM.INFINITE_CACHE?void 0:P.renderOpts.collectedExpire;return{value:{kind:e$.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:i}}}}catch(t){throw(null==o?void 0:o.isStale)&&await np.onRequestError(e,t,{routerKind:"App Router",routePath:n,routeType:"route",revalidateReason:(0,eR.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:p})},d),t}},f=await np.handleResponse({req:e,nextConfig:o,cacheKey:_,routeKind:ey.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:u,isRoutePPREnabled:!1,isOnDemandRevalidate:p,revalidateOnlyGenerated:h,responseGenerator:g,waitUntil:s.waitUntil,isMinimalMode:a});if(!b)return null;if((null==f||null==(l=f.value)?void 0:l.kind)!==e$.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==f||null==(m=f.value)?void 0:m.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||t.setHeader("x-nextjs-cache",p?"REVALIDATED":f.isMiss?"MISS":f.isStale?"STALE":"HIT"),c&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,eE.fromNodeOutgoingHttpHeaders)(f.value.headers);return a&&b||y.delete(eM.NEXT_CACHE_TAGS_HEADER),!f.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,ex.getCacheControlHeader)(f.cacheControl)),await (0,eI.sendResponse)(R,I,new Response(f.value.body,{headers:y,status:f.value.status||200})),null};C?await r(C):await A.withPropagatedContext(e.headers,()=>A.trace(eP.BaseServerSpan.handleRequest,{spanName:`${S} ${n}`,kind:e_.SpanKind.SERVER,attributes:{"http.method":S,"http.target":e.url}},r))}catch(t){if(t instanceof eT.NoFallbackError||await np.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,eR.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:p})}),b)throw t;return await (0,eI.sendResponse)(R,I,new Response(null,{status:500})),null}}e.s(["handler",()=>ny,"patchFetch",()=>nf,"routeModule",()=>np,"serverHooks",()=>ng,"workAsyncStorage",()=>nh,"workUnitAsyncStorage",()=>nm],48206)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_de771142.js.map