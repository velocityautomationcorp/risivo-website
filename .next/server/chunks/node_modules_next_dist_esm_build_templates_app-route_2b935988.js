module.exports=[19911,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),s=e.i(59756),a=e.i(61916),o=e.i(14444),i=e.i(37092),u=e.i(69741),c=e.i(16795),l=e.i(87718),d=e.i(95169),p=e.i(47587),h=e.i(66012),m=e.i(70101),b=e.i(26937),f=e.i(10372),w=e.i(93695);e.i(52474);var g=e.i(220),R=e.i(89171),A=e.i(89660),y=e.i(20606);async function v(e){try{let{searchParams:t}=new URL(e.url),r=t.get("action"),n=t.get("subAccountId");if("search"===r){let e=t.get("country")||"US",r=t.get("type")||"local",n=t.get("areaCode")||void 0,s=t.get("locality")||void 0,a=t.get("region")||void 0,o=t.get("contains")||void 0,i=parseInt(t.get("limit")||"20"),{data:u}=await A.supabaseAdmin.from("AgencyTwilioConfig").select("*").is("agencyId",null).single();if(!u)return R.NextResponse.json({success:!1,error:"Twilio configuration not found"},{status:400});await y.twilioService.initialize(u);let c=(await y.twilioService.searchAvailableNumbers(e,r,{areaCode:n,locality:s,region:a,contains:o,limit:i})).map(e=>{let t=u.usageMarkupPercent||5;return{...e,monthlyPriceWithMarkup:e.monthlyPrice*(1+t/100),setupPriceWithMarkup:e.setupPrice*(1+t/100)}});return R.NextResponse.json({success:!0,data:c})}if(!n)return R.NextResponse.json({success:!1,error:"Sub-account ID is required for listing"},{status:400});let{data:s,error:a}=await A.supabaseAdmin.from("PhoneNumber").select("*").eq("subAccountId",n).order("isPrimary",{ascending:!1}).order("createdAt",{ascending:!1});if(a)throw a;return R.NextResponse.json({success:!0,data:s})}catch(e){return console.error("Error in phone numbers GET:",e),R.NextResponse.json({success:!1,error:"Failed to get phone numbers"},{status:500})}}async function N(e){try{let t=await e.json();if(!t.subAccountId)return R.NextResponse.json({success:!1,error:"Sub-account ID is required"},{status:400});if(!t.phoneNumber&&!t.type)return R.NextResponse.json({success:!1,error:"Phone number or type is required"},{status:400});let{data:r,error:n}=await A.supabaseAdmin.from("TwilioSubaccount").select("*").eq("subAccountId",t.subAccountId).single();if(n||!r)return R.NextResponse.json({success:!1,error:"Twilio subaccount not found. Please provision telephony first."},{status:400});if("active"!==r.status)return R.NextResponse.json({success:!1,error:`Cannot purchase number - subaccount is ${r.status}`},{status:400});let{data:s}=await A.supabaseAdmin.from("AgencyTwilioConfig").select("*").is("agencyId",null).single();if(!s)return R.NextResponse.json({success:!1,error:"Twilio configuration not found"},{status:400});await y.twilioService.initialize(s);let a=s.webhookBaseUrl||process.env.NEXT_PUBLIC_APP_URL||"",{count:o}=await A.supabaseAdmin.from("PhoneNumber").select("id",{count:"exact",head:!0}).eq("subAccountId",t.subAccountId).eq("status","active"),i=0===(o||0),u=await y.twilioService.purchaseNumberForSubaccount(r.twilioAccountSid,r.twilioAuthToken,{subAccountId:t.subAccountId,agencyId:t.agencyId||r.agencyId||"",type:t.type||"local",country:t.country||"US",areaCode:t.areaCode,locality:t.locality,contains:t.contains,friendlyName:t.friendlyName,assignedFor:t.assignedFor||"all",initiatedByUserId:t.initiatedByUserId||t.userId||"system",initiatedByUserName:t.initiatedByUserName},a);if(!u.success||!u.phoneNumber)return R.NextResponse.json({success:!1,error:u.error||"Failed to purchase phone number"},{status:500});let c={...u.phoneNumber,twilioSubaccountId:r.id,isPrimary:i,isDefault:i},{data:l,error:d}=await A.supabaseAdmin.from("PhoneNumber").insert(c).select().single();if(d)throw d;return R.NextResponse.json({success:!0,data:l},{status:201})}catch(e){return console.error("Error purchasing phone number:",e),R.NextResponse.json({success:!1,error:"Failed to purchase phone number"},{status:500})}}async function S(e){try{let t=await e.json();if(!t.id&&!t.phoneNumberId)return R.NextResponse.json({success:!1,error:"Phone number ID is required"},{status:400});let r=t.id||t.phoneNumberId,{data:n,error:s}=await A.supabaseAdmin.from("PhoneNumber").select("*").eq("id",r).single();if(s||!n)return R.NextResponse.json({success:!1,error:"Phone number not found"},{status:404});let a={updatedAt:new Date().toISOString()};["friendlyName","isPrimary","isDefault","assignedFor","voiceUrl","voiceMethod","voiceFallbackUrl","smsUrl","smsMethod","smsFallbackUrl","voiceApplicationSid","smsApplicationSid","messagingServiceSid"].forEach(e=>{void 0!==t[e]&&(a[e]=t[e])}),!0===t.isPrimary&&await A.supabaseAdmin.from("PhoneNumber").update({isPrimary:!1,updatedAt:new Date().toISOString()}).eq("subAccountId",n.subAccountId).neq("id",r),!0===t.isDefault&&await A.supabaseAdmin.from("PhoneNumber").update({isDefault:!1,updatedAt:new Date().toISOString()}).eq("subAccountId",n.subAccountId).neq("id",r);let{data:o,error:i}=await A.supabaseAdmin.from("PhoneNumber").update(a).eq("id",r).select().single();if(i)throw i;if(t.voiceUrl||t.smsUrl){let{data:e}=await A.supabaseAdmin.from("TwilioSubaccount").select("twilioAccountSid, twilioAuthToken").eq("id",n.twilioSubaccountId).single();if(e&&n.phoneNumberSid)try{y.twilioService.getSubaccountClient(e.twilioAccountSid,e.twilioAuthToken)}catch(e){console.error("Failed to update number in Twilio:",e)}}return R.NextResponse.json({success:!0,data:o})}catch(e){return console.error("Error updating phone number:",e),R.NextResponse.json({success:!1,error:"Failed to update phone number"},{status:500})}}async function I(e){try{let{searchParams:t}=new URL(e.url),r=t.get("id"),n=t.get("subAccountId");if(!r)return R.NextResponse.json({success:!1,error:"Phone number ID is required"},{status:400});let{data:s,error:a}=await A.supabaseAdmin.from("PhoneNumber").select("*, TwilioSubaccount:twilioSubaccountId(*)").eq("id",r).single();if(a||!s)return R.NextResponse.json({success:!1,error:"Phone number not found"},{status:404});if(n&&s.subAccountId!==n)return R.NextResponse.json({success:!1,error:"Unauthorized"},{status:403});if(s.phoneNumberSid&&s.TwilioSubaccount){let{data:e}=await A.supabaseAdmin.from("AgencyTwilioConfig").select("*").is("agencyId",null).single();if(e){await y.twilioService.initialize(e);try{await y.twilioService.releaseNumber(s.TwilioSubaccount.twilioAccountSid,s.TwilioSubaccount.twilioAuthToken,s.phoneNumberSid)}catch(e){console.error("Failed to release number from Twilio:",e)}}}let{error:o}=await A.supabaseAdmin.from("PhoneNumber").update({status:"released",releasedAt:new Date().toISOString(),releaseReason:"Released by user",isPrimary:!1,isDefault:!1,updatedAt:new Date().toISOString()}).eq("id",r);if(o)throw o;if(s.isPrimary){let{data:e}=await A.supabaseAdmin.from("PhoneNumber").select("id").eq("subAccountId",s.subAccountId).eq("status","active").limit(1).single();e&&await A.supabaseAdmin.from("PhoneNumber").update({isPrimary:!0,isDefault:!0,updatedAt:new Date().toISOString()}).eq("id",e.id)}return R.NextResponse.json({success:!0})}catch(e){return console.error("Error releasing phone number:",e),R.NextResponse.json({success:!1,error:"Failed to release phone number"},{status:500})}}e.s(["DELETE",()=>I,"GET",()=>v,"POST",()=>N,"PUT",()=>S],66949);var P=e.i(66949);let x=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/telephony/phone-numbers/route",pathname:"/api/v1/telephony/phone-numbers",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/telephony/phone-numbers/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:E,workUnitAsyncStorage:T,serverHooks:C}=x;function q(){return(0,n.patchFetch)({workAsyncStorage:E,workUnitAsyncStorage:T})}async function U(e,t,n){x.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/v1/telephony/phone-numbers/route";R=R.replace(/\/index$/,"")||"/";let A=await x.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:y,params:v,nextConfig:N,parsedUrl:S,isDraftMode:I,prerenderManifest:P,routerServerContext:E,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,resolvedPathname:q,clientReferenceManifest:U,serverActionsManifest:j}=A,D=(0,u.normalizeAppPath)(R),O=!!(P.dynamicRoutes[D]||P.routes[q]),k=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,S,!1):t.end("This page could not be found"),null);if(O&&!I){let e=!!P.routes[q],t=P.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await k();throw new w.NoFallbackError}}let _=null;!O||x.isDev||I||(_="/index"===(_=q)?"/":_);let F=!0===x.isDev||!O,M=O&&!F;j&&U&&(0,o.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:U,serverActionsManifest:j,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:j})});let H=e.method||"GET",B=(0,a.getTracer)(),L=B.getActiveScopeSpan(),$={params:v,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>x.onRequestError(e,t,n,E)},sharedContext:{buildId:y}},K=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),G=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let o=async e=>x.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=B.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),i=!!(0,s.getRequestMeta)(e,"minimalMode"),u=async s=>{var a,u;let c=async({previousCacheEntry:r})=>{try{if(!i&&T&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await o(s);e.fetchMetrics=$.renderOpts.fetchMetrics;let u=$.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let c=$.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(K,z,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(a.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,n=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})},E),t}},l=await x.handleResponse({req:e,nextConfig:N,cacheKey:_,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:C,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:i});if(!O)return null;if((null==l||null==(a=l.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",T?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&O||d.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,b.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(K,z,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};L?await u(L):await B.withPropagatedContext(e.headers,()=>B.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:T})}),O)throw t;return await (0,h.sendResponse)(K,z,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>q,"routeModule",()=>x,"serverHooks",()=>C,"workAsyncStorage",()=>E,"workUnitAsyncStorage",()=>T],19911)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2b935988.js.map