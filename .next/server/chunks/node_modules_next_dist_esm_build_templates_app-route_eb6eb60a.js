module.exports=[79411,e=>{"use strict";var t=e.i(47909),n=e.i(74017),a=e.i(96250),r=e.i(59756),s=e.i(61916),i=e.i(14444),o=e.i(37092),c=e.i(69741),d=e.i(16795),l=e.i(87718),u=e.i(95169),p=e.i(47587),m=e.i(66012),_=e.i(70101),g=e.i(26937),f=e.i(10372),h=e.i(93695);e.i(52474);var v=e.i(220),R=e.i(89171),w=e.i(89660),y=e.i(75949);async function E(e){try{let t=w.supabaseAdmin,{searchParams:n}=new URL(e.url),a=n.get("subAccountId"),r=n.get("id"),s=n.get("calendarId"),i=n.get("contactId"),o=n.get("assignedTo"),c=n.get("startDate"),d=n.get("endDate"),l=n.get("status"),u=parseInt(n.get("page")||"1"),p=Math.min(parseInt(n.get("limit")||"20"),100),m=n.get("sort")||"start_time_asc";if(!a)return R.NextResponse.json({success:!1,error:"subAccountId is required"},{status:400});if(r){let{data:e,error:n}=await t.from("appointments").select(`
          *,
          calendars (*),
          appointment_types (*),
          contacts:contact_id (id, first_name, last_name, email, phone)
        `).eq("id",r).single();if(n||!e||e.calendars?.sub_account_id!==a)return R.NextResponse.json({success:!1,error:"Appointment not found"},{status:404});return R.NextResponse.json({success:!0,data:I(e)})}let _=t.from("appointments").select(`
        *,
        calendars!inner (id, name, sub_account_id),
        appointment_types (id, name)
      `,{count:"exact"}).eq("calendars.sub_account_id",a);s&&(_=_.eq("calendar_id",s)),i&&(_=_.eq("contact_id",i)),o&&(_=_.eq("assigned_to",o)),c&&(_=_.gte("start_time",new Date(c).toISOString())),d&&(_=_.lte("start_time",new Date(new Date(d).setHours(23,59,59,999)).toISOString())),_=l?_.eq("status",l):_.neq("status","cancelled"),_="start_time_desc"===m?_.order("start_time",{ascending:!1}):_.order("start_time",{ascending:!0});let g=(u-1)*p;_=_.range(g,g+p-1);let{data:f,error:h,count:v}=await _;if(h)return console.error("Error fetching appointments:",h),R.NextResponse.json({success:!1,error:"Failed to fetch appointments"},{status:500});let y=(f||[]).map(I);return R.NextResponse.json({success:!0,data:y,pagination:{page:u,limit:p,total:v||0,totalPages:Math.ceil((v||0)/p)}})}catch(e){return console.error("Error in GET /api/v1/appointments:",e),R.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function S(e){try{var t,n,a,r;let s,i,o,c,d,l,u,p=w.supabaseAdmin,{calendarId:m,appointmentTypeId:_,startTime:g,timezone:f,contact:h,additionalGuests:v,customAnswers:E,notes:S,sendConfirmation:x=!0}=await e.json();if(!m||!g||!f||!h?.name||!h?.email)return R.NextResponse.json({success:!1,error:"calendarId, startTime, timezone, and contact (name, email) are required"},{status:400});let{data:T,error:I}=await p.from("calendars").select("*").eq("id",m).eq("status","active").single();if(I||!T)return R.NextResponse.json({success:!1,error:"Calendar not found or inactive"},{status:404});let b=T.duration_minutes,q=null;if(_){let{data:e}=await p.from("appointment_types").select("*").eq("id",_).eq("calendar_id",m).eq("is_active",!0).single();e&&(q=e,b=e.duration_minutes)}let C=new Date(g),O=new Date(C.getTime()+60*b*1e3),{data:P}=await p.from("appointments").select("id").eq("calendar_id",m).in("status",["scheduled","confirmed"]).or(`start_time.lte.${O.toISOString()},end_time.gte.${C.toISOString()}`);if(P&&P.length>0)return R.NextResponse.json({success:!1,error:"Selected time slot is no longer available"},{status:409});let k=N(),D=N(),j=N(),U=null;"round_robin"===T.calendar_type&&(U=await A(p,m));let $=null,{data:M}=await p.from("contacts").select("id").eq("sub_account_id",T.sub_account_id).eq("email",h.email).single();if(M)$=M.id;else{let e=h.name.split(" "),t=e[0]||"",n=e.slice(1).join(" ")||"",{data:a}=await p.from("contacts").insert({id:(0,y.v4)(),sub_account_id:T.sub_account_id,first_name:t,last_name:n,email:h.email,phone:h.phone,status:"active",language:"en"}).select("id").single();$=a?.id}let H=(0,y.v4)(),{data:L,error:F}=await p.from("appointments").insert({id:H,calendar_id:m,appointment_type_id:_,start_time:C.toISOString(),end_time:O.toISOString(),timezone:f,duration_minutes:b,assigned_to:U,contact_id:$,contact_name:h.name,contact_email:h.email,contact_phone:h.phone,additional_guests:v,status:T.auto_confirm?"confirmed":"scheduled",confirmation_status:T.auto_confirm?"confirmed":"pending",payment_status:q?.require_payment?"pending":"not_required",custom_questions_answers:E,notes:S,is_recurring:!1,reschedule_count:0,confirmation_token:k,cancellation_token:D,reschedule_token:j}).select().single();if(F)return console.error("Error creating appointment:",F),R.NextResponse.json({success:!1,error:"Failed to create appointment"},{status:500});let K=process.env.NEXT_PUBLIC_APP_URL||"",B={id:H,calendarId:m,startTime:L.start_time,endTime:L.end_time,timezone:f,status:L.status,confirmationToken:k,cancelUrl:`${K}/cancel/${D}`,rescheduleUrl:`${K}/reschedule/${j}`,meetingLink:L.meeting_link,calendarInvite:{google:(t=L,n=T,s=new Date(t.start_time),i=new Date(t.end_time),o=e=>e.toISOString().replace(/[-:]/g,"").replace(/\.\d{3}/,""),c=new URLSearchParams({action:"TEMPLATE",text:`${n.name} - Appointment`,dates:`${o(s)}/${o(i)}`,details:t.notes||"",location:t.meeting_location||t.meeting_link||""}),`https://calendar.google.com/calendar/render?${c.toString()}`),outlook:(a=L,r=T,d=new Date(a.start_time),l=new Date(a.end_time),u=new URLSearchParams({subject:`${r.name} - Appointment`,startdt:d.toISOString(),enddt:l.toISOString(),body:a.notes||"",location:a.meeting_location||a.meeting_link||""}),`https://outlook.office.com/calendar/0/deeplink/compose?${u.toString()}`),icsUrl:`${K}/api/v1/appointments/${H}/ics`}};return R.NextResponse.json({success:!0,data:B},{status:201})}catch(e){return console.error("Error in POST /api/v1/appointments:",e),R.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function x(e){try{let t=w.supabaseAdmin,{id:n,status:a,confirmationStatus:r,meetingLocationType:s,meetingLocation:i,meetingLink:o,meetingPassword:c,notes:d,internalNotes:l,assignedTo:u,paymentStatus:p,paymentAmount:m,paymentTransactionId:_}=await e.json();if(!n)return R.NextResponse.json({success:!1,error:"id is required"},{status:400});let g={updated_at:new Date().toISOString()};void 0!==a&&(g.status=a),void 0!==r&&(g.confirmation_status=r),void 0!==s&&(g.meeting_location_type=s),void 0!==i&&(g.meeting_location=i),void 0!==o&&(g.meeting_link=o),void 0!==c&&(g.meeting_password=c),void 0!==d&&(g.notes=d),void 0!==l&&(g.internal_notes=l),void 0!==u&&(g.assigned_to=u),void 0!==p&&(g.payment_status=p),void 0!==m&&(g.payment_amount=m),void 0!==_&&(g.payment_transaction_id=_),"cancelled"===a&&(g.cancelled_at=new Date().toISOString());let{data:f,error:h}=await t.from("appointments").update(g).eq("id",n).select().single();if(h||!f)return console.error("Error updating appointment:",h),R.NextResponse.json({success:!1,error:"Failed to update appointment"},{status:500});return R.NextResponse.json({success:!0,data:I(f)})}catch(e){return console.error("Error in PUT /api/v1/appointments:",e),R.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function T(e){try{let t=w.supabaseAdmin,{searchParams:n}=new URL(e.url),a=n.get("id"),r=n.get("reason");if(n.get("notifyContact"),!a)return R.NextResponse.json({success:!1,error:"id is required"},{status:400});let{data:s,error:i}=await t.from("appointments").update({status:"cancelled",cancellation_reason:r,cancelled_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",a).select().single();if(i||!s)return console.error("Error cancelling appointment:",i),R.NextResponse.json({success:!1,error:"Failed to cancel appointment"},{status:500});return R.NextResponse.json({success:!0,data:{id:s.id,status:"cancelled",cancelledAt:s.cancelled_at}})}catch(e){return console.error("Error in DELETE /api/v1/appointments:",e),R.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}function I(e){return{id:e.id,calendarId:e.calendar_id,appointmentTypeId:e.appointment_type_id,startTime:e.start_time,endTime:e.end_time,timezone:e.timezone,durationMinutes:e.duration_minutes,assignedTo:e.assigned_to,contactId:e.contact_id,contactName:e.contact_name,contactEmail:e.contact_email,contactPhone:e.contact_phone,additionalGuests:e.additional_guests,status:e.status,confirmationStatus:e.confirmation_status,meetingLocationType:e.meeting_location_type,meetingLocation:e.meeting_location,meetingLink:e.meeting_link,meetingPassword:e.meeting_password,customQuestionsAnswers:e.custom_questions_answers,notes:e.notes,internalNotes:e.internal_notes,cancellationReason:e.cancellation_reason,cancelledAt:e.cancelled_at,cancelledBy:e.cancelled_by,rescheduledFrom:e.rescheduled_from,rescheduleCount:e.reschedule_count,paymentStatus:e.payment_status,paymentAmount:e.payment_amount,paymentCurrency:e.payment_currency,paymentTransactionId:e.payment_transaction_id,isRecurring:e.is_recurring,recurrencePattern:e.recurrence_pattern,parentSeriesId:e.parent_series_id,remindersSent:e.reminders_sent,confirmationToken:e.confirmation_token,cancellationToken:e.cancellation_token,rescheduleToken:e.reschedule_token,createdAt:e.created_at,updatedAt:e.updated_at,calendar:e.calendars?{id:e.calendars.id,name:e.calendars.name}:void 0,appointmentType:e.appointment_types?{id:e.appointment_types.id,name:e.appointment_types.name}:void 0,contact:e.contacts?{id:e.contacts.id,firstName:e.contacts.first_name,lastName:e.contacts.last_name,email:e.contacts.email,phone:e.contacts.phone}:void 0}}function N(){return(0,y.v4)().replace(/-/g,"").substring(0,24)}async function A(e,t){let{data:n}=await e.from("calendar_members").select("user_id, priority_order, weight").eq("calendar_id",t).eq("is_active",!0).order("priority_order",{ascending:!0});if(!n||0===n.length)return null;let{data:a}=await e.from("round_robin_assignments").select("last_assigned_user_id, assignment_counts").eq("calendar_id",t).single();if(!a)return n[0].user_id;let r=(n.findIndex(e=>e.user_id===a.last_assigned_user_id)+1)%n.length,s=n[r].user_id,i=a.assignment_counts||{};return i[s]=(i[s]||0)+1,await e.from("round_robin_assignments").upsert({calendar_id:t,last_assigned_user_id:s,last_assigned_at:new Date().toISOString(),assignment_counts:i,updated_at:new Date().toISOString()}),s}e.s(["DELETE",()=>T,"GET",()=>E,"POST",()=>S,"PUT",()=>x],30120);var b=e.i(30120);let q=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/v1/appointments/route",pathname:"/api/v1/appointments",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/appointments/route.ts",nextConfigOutput:"",userland:b}),{workAsyncStorage:C,workUnitAsyncStorage:O,serverHooks:P}=q;function k(){return(0,a.patchFetch)({workAsyncStorage:C,workUnitAsyncStorage:O})}async function D(e,t,a){q.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/v1/appointments/route";R=R.replace(/\/index$/,"")||"/";let w=await q.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:E,nextConfig:S,parsedUrl:x,isDraftMode:T,prerenderManifest:I,routerServerContext:N,isOnDemandRevalidate:A,revalidateOnlyGenerated:b,resolvedPathname:C,clientReferenceManifest:O,serverActionsManifest:P}=w,k=(0,c.normalizeAppPath)(R),D=!!(I.dynamicRoutes[k]||I.routes[C]),j=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,x,!1):t.end("This page could not be found"),null);if(D&&!T){let e=!!I.routes[C],t=I.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await j();throw new h.NoFallbackError}}let U=null;!D||q.isDev||T||(U="/index"===(U=C)?"/":U);let $=!0===q.isDev||!D,M=D&&!$;P&&O&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:P,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:P})});let H=e.method||"GET",L=(0,s.getTracer)(),F=L.getActiveScopeSpan(),K={params:E,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a)=>q.onRequestError(e,t,a,N)},sharedContext:{buildId:y}},B=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),z=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let i=async e=>q.handle(z,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=L.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),c=async r=>{var s,c;let d=async({previousCacheEntry:n})=>{try{if(!o&&A&&b&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(r);e.fetchMetrics=K.renderOpts.fetchMetrics;let c=K.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let d=K.renderOpts.collectedTags;if(!D)return await (0,m.sendResponse)(B,G,s,K.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(s.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,a=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},N),t}},l=await q.handleResponse({req:e,nextConfig:S,cacheKey:U,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:b,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!D)return null;if((null==l||null==(s=l.value)?void 0:s.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(c=l.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",A?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&D||u.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(l.cacheControl)),await (0,m.sendResponse)(B,G,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};F?await c(F):await L.withPropagatedContext(e.headers,()=>L.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},c))}catch(t){if(t instanceof h.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})}),D)throw t;return await (0,m.sendResponse)(B,G,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>k,"routeModule",()=>q,"serverHooks",()=>P,"workAsyncStorage",()=>C,"workUnitAsyncStorage",()=>O],79411)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_eb6eb60a.js.map