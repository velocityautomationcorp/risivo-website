module.exports=[22130,e=>{"use strict";var t=e.i(47909),s=e.i(74017),n=e.i(96250),a=e.i(59756),o=e.i(61916),r=e.i(14444),i=e.i(37092),u=e.i(69741),c=e.i(16795),l=e.i(87718),d=e.i(95169),p=e.i(47587),w=e.i(66012),b=e.i(70101),h=e.i(26937),f=e.i(10372),R=e.i(93695);e.i(52474);var m=e.i(220),g=e.i(89171),A=e.i(89660),S=e.i(20606);async function v(e){try{let{searchParams:t}=new URL(e.url),s=t.get("subAccountId"),n=t.get("id");if(n){let{data:e,error:t}=await A.supabaseAdmin.from("TwilioSubaccount").select("*").eq("id",n).single();if(t)throw t;let s={...e,twilioAuthToken:e.twilioAuthToken?"••••••••":null};return g.NextResponse.json({success:!0,data:s})}if(s){let{data:e,error:t}=await A.supabaseAdmin.from("TwilioSubaccount").select("*").eq("subAccountId",s).single();if(t&&"PGRST116"!==t.code)throw t;if(!e)return g.NextResponse.json({success:!0,data:null});let n={...e,twilioAuthToken:e.twilioAuthToken?"••••••••":null};return g.NextResponse.json({success:!0,data:n})}let{data:a,error:o}=await A.supabaseAdmin.from("TwilioSubaccount").select("*").order("createdAt",{ascending:!1});if(o)throw o;let r=a.map(e=>({...e,twilioAuthToken:e.twilioAuthToken?"••••••••":null}));return g.NextResponse.json({success:!0,data:r})}catch(e){return console.error("Error fetching Twilio subaccount:",e),g.NextResponse.json({success:!1,error:"Failed to fetch subaccount"},{status:500})}}async function T(e){try{let t=await e.json();if(!t.subAccountId)return g.NextResponse.json({success:!1,error:"Sub-account ID is required"},{status:400});let{data:s}=await A.supabaseAdmin.from("TwilioSubaccount").select("id").eq("subAccountId",t.subAccountId).single();if(s)return g.NextResponse.json({success:!1,error:"Twilio subaccount already exists for this sub-account"},{status:409});let{data:n,error:a}=await A.supabaseAdmin.from("AgencyTwilioConfig").select("*").is("agencyId",null).single();if(a||!n)return g.NextResponse.json({success:!1,error:"Agency Twilio configuration not found. Please configure master Twilio account first."},{status:400});await S.twilioService.initialize(n);let{data:o}=await A.supabaseAdmin.from("SubAccount").select("name").eq("id",t.subAccountId).single(),r=t.friendlyName||o?.name||`RISIVO Sub-Account ${t.subAccountId.slice(0,8)}`,i=n.webhookBaseUrl||process.env.NEXT_PUBLIC_APP_URL||"",u=await S.twilioService.provisionSubaccount({subAccountId:t.subAccountId,agencyId:t.agencyId||"",friendlyName:r,autoProvisionPhoneNumber:t.autoProvisionPhoneNumber??n.autoProvisionPhoneNumber,phoneNumberType:t.phoneNumberType||n.defaultPhoneNumberType,areaCode:t.areaCode||n.defaultPhoneNumberAreaCode},i);if(!u.success||!u.subaccount)return g.NextResponse.json({success:!1,error:u.error||"Failed to provision Twilio subaccount"},{status:500});let c=new Date,l=new Date(c.getFullYear(),c.getMonth(),1),d=new Date(c.getFullYear(),c.getMonth()+1,0),p={...u.subaccount,agencyConfigId:n.id,currentPeriodStart:l.toISOString(),currentPeriodEnd:d.toISOString()},{data:w,error:b}=await A.supabaseAdmin.from("TwilioSubaccount").insert(p).select().single();if(b)throw b;let h=null;if(u.phoneNumber){let e={...u.phoneNumber,twilioSubaccountId:w.id},{data:t,error:s}=await A.supabaseAdmin.from("PhoneNumber").insert(e).select().single();s?console.error("Error saving phone number:",s):h=t}let f={...w,twilioAuthToken:"••••••••"};return g.NextResponse.json({success:!0,data:{subaccount:f,phoneNumber:h}},{status:201})}catch(e){return console.error("Error provisioning Twilio subaccount:",e),g.NextResponse.json({success:!1,error:"Failed to provision subaccount"},{status:500})}}async function N(e){try{let t=await e.json();if(!t.id&&!t.subAccountId)return g.NextResponse.json({success:!1,error:"Subaccount ID or sub-account ID is required"},{status:400});let s=A.supabaseAdmin.from("TwilioSubaccount").select("*");t.id?s.eq("id",t.id):s.eq("subAccountId",t.subAccountId);let{data:n,error:a}=await s.single();if(a||!n)return g.NextResponse.json({success:!1,error:"Subaccount not found"},{status:404});if(t.status&&t.status!==n.status){let{data:e}=await A.supabaseAdmin.from("AgencyTwilioConfig").select("*").is("agencyId",null).single();if(e&&n.twilioAccountSid){if(await S.twilioService.initialize(e),"suspended"===t.status){let e=await S.twilioService.suspendSubaccount(n.twilioAccountSid,t.suspensionReason||"Suspended by admin");if(!e.success)return g.NextResponse.json({success:!1,error:e.error},{status:500})}else if("active"===t.status&&"suspended"===n.status){let e=await S.twilioService.reactivateSubaccount(n.twilioAccountSid);if(!e.success)return g.NextResponse.json({success:!1,error:e.error},{status:500})}}}let o={updatedAt:new Date().toISOString()};["friendlyName","status","suspensionReason","usageMarkupOverride","dailySmsLimit","dailyCallLimit","canSendSms","canMakeCalls","brandRegistrationId","brandRegistrationStatus","a2pComplianceStatus"].forEach(e=>{void 0!==t[e]&&(o[e]=t[e])}),"suspended"===t.status&&"suspended"!==n.status?o.suspendedAt=new Date().toISOString():"active"===t.status&&"suspended"===n.status&&(o.suspendedAt=null,o.suspensionReason=null);let{data:r,error:i}=await A.supabaseAdmin.from("TwilioSubaccount").update(o).eq("id",n.id).select().single();if(i)throw i;let u={...r,twilioAuthToken:"••••••••"};return g.NextResponse.json({success:!0,data:u})}catch(e){return console.error("Error updating Twilio subaccount:",e),g.NextResponse.json({success:!1,error:"Failed to update subaccount"},{status:500})}}async function y(e){try{let{searchParams:t}=new URL(e.url),s=t.get("id"),n=t.get("subAccountId");if(!s&&!n)return g.NextResponse.json({success:!1,error:"Subaccount ID or sub-account ID is required"},{status:400});let a=A.supabaseAdmin.from("TwilioSubaccount").select("*");s?a.eq("id",s):a.eq("subAccountId",n);let{data:o,error:r}=await a.single();if(r||!o)return g.NextResponse.json({success:!1,error:"Subaccount not found"},{status:404});let{error:i}=await A.supabaseAdmin.from("TwilioSubaccount").update({status:"closed",canSendSms:!1,canMakeCalls:!1,updatedAt:new Date().toISOString()}).eq("id",o.id);if(i)throw i;return await A.supabaseAdmin.from("PhoneNumber").update({status:"released",releasedAt:new Date().toISOString(),releaseReason:"Subaccount closed",updatedAt:new Date().toISOString()}).eq("twilioSubaccountId",o.id),g.NextResponse.json({success:!0})}catch(e){return console.error("Error closing Twilio subaccount:",e),g.NextResponse.json({success:!1,error:"Failed to close subaccount"},{status:500})}}e.s(["DELETE",()=>y,"GET",()=>v,"POST",()=>T,"PUT",()=>N],8531);var x=e.i(8531);let E=new t.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/v1/telephony/subaccounts/route",pathname:"/api/v1/telephony/subaccounts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/telephony/subaccounts/route.ts",nextConfigOutput:"",userland:x}),{workAsyncStorage:I,workUnitAsyncStorage:C,serverHooks:P}=E;function O(){return(0,n.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:C})}async function j(e,t,n){E.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/v1/telephony/subaccounts/route";g=g.replace(/\/index$/,"")||"/";let A=await E.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:S,params:v,nextConfig:T,parsedUrl:N,isDraftMode:y,prerenderManifest:x,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,resolvedPathname:O,clientReferenceManifest:j,serverActionsManifest:q}=A,D=(0,u.normalizeAppPath)(g),k=!!(x.dynamicRoutes[D]||x.routes[O]),_=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,N,!1):t.end("This page could not be found"),null);if(k&&!y){let e=!!x.routes[O],t=x.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await _();throw new R.NoFallbackError}}let U=null;!k||E.isDev||y||(U="/index"===(U=O)?"/":U);let M=!0===E.isDev||!k,H=k&&!M;q&&j&&(0,r.setReferenceManifestsSingleton)({page:g,clientReferenceManifest:j,serverActionsManifest:q,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:q})});let F=e.method||"GET",L=(0,o.getTracer)(),$=L.getActiveScopeSpan(),K={params:v,prerenderManifest:x,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,s,n)=>E.onRequestError(e,t,n,I)},sharedContext:{buildId:S}},B=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),V=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let r=async e=>E.handle(V,K).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let s=L.getRootSpanAttributes();if(!s)return;if(s.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${s.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=s.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${g}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var o,u;let c=async({previousCacheEntry:s})=>{try{if(!i&&C&&P&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await r(a);e.fetchMetrics=K.renderOpts.fetchMetrics;let u=K.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let c=K.renderOpts.collectedTags;if(!k)return await (0,w.sendResponse)(B,G,o,K.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,b.toNodeOutgoingHttpHeaders)(o.headers);c&&(t[f.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let s=void 0!==K.renderOpts.collectedRevalidate&&!(K.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&K.renderOpts.collectedRevalidate,n=void 0===K.renderOpts.collectedExpire||K.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:K.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:s,expire:n}}}}catch(t){throw(null==s?void 0:s.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})},I),t}},l=await E.handleResponse({req:e,nextConfig:T,cacheKey:U,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:x,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:P,responseGenerator:c,waitUntil:n.waitUntil,isMinimalMode:i});if(!k)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,b.fromNodeOutgoingHttpHeaders)(l.value.headers);return i&&k||d.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(l.cacheControl)),await (0,w.sendResponse)(B,G,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};$?await u($):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${g}`,kind:o.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof R.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:C})}),k)throw t;return await (0,w.sendResponse)(B,G,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>O,"routeModule",()=>E,"serverHooks",()=>P,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>C],22130)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_3fa3267d.js.map