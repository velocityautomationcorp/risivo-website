{"version":3,"sources":["../../../lib/telephony/twilio-service.ts"],"sourcesContent":["// ============================================\n// RISIVO CRM - Twilio Service\n// Server-side Twilio API integration\n// ============================================\n\nimport {\n  AgencyTwilioConfig,\n  TwilioSubaccount,\n  PhoneNumber,\n  AvailablePhoneNumber,\n  PhoneNumberType,\n  TelephonyUsage,\n  UsageType,\n  ProvisionPhoneNumberRequest,\n  ProvisionPhoneNumberResponse,\n  ProvisionSubaccountRequest,\n  ProvisionSubaccountResponse,\n} from './types'\n\n// ==========================================\n// TWILIO API CLIENT\n// ==========================================\n\ninterface TwilioCredentials {\n  accountSid: string\n  authToken: string\n}\n\nclass TwilioApiClient {\n  private accountSid: string\n  private authToken: string\n  private baseUrl = 'https://api.twilio.com/2010-04-01'\n  \n  constructor(credentials: TwilioCredentials) {\n    this.accountSid = credentials.accountSid\n    this.authToken = credentials.authToken\n  }\n  \n  private getAuthHeader(): string {\n    const credentials = Buffer.from(`${this.accountSid}:${this.authToken}`).toString('base64')\n    return `Basic ${credentials}`\n  }\n  \n  private async request<T>(\n    method: string,\n    path: string,\n    body?: Record<string, unknown>,\n    useFormData = true\n  ): Promise<T> {\n    const url = `${this.baseUrl}${path}`\n    \n    const headers: Record<string, string> = {\n      'Authorization': this.getAuthHeader(),\n    }\n    \n    let requestBody: string | undefined\n    \n    if (body && useFormData) {\n      headers['Content-Type'] = 'application/x-www-form-urlencoded'\n      requestBody = new URLSearchParams(\n        Object.entries(body).reduce((acc, [key, value]) => {\n          if (value !== undefined && value !== null) {\n            acc[key] = String(value)\n          }\n          return acc\n        }, {} as Record<string, string>)\n      ).toString()\n    } else if (body) {\n      headers['Content-Type'] = 'application/json'\n      requestBody = JSON.stringify(body)\n    }\n    \n    const response = await fetch(url, {\n      method,\n      headers,\n      body: requestBody,\n    })\n    \n    if (!response.ok) {\n      const error = await response.json()\n      throw new TwilioApiError(\n        error.message || 'Twilio API error',\n        error.code,\n        response.status\n      )\n    }\n    \n    return response.json()\n  }\n  \n  // ==========================================\n  // ACCOUNT MANAGEMENT\n  // ==========================================\n  \n  /**\n   * Create a Twilio subaccount\n   */\n  async createSubaccount(friendlyName: string): Promise<TwilioSubaccountResponse> {\n    return this.request<TwilioSubaccountResponse>(\n      'POST',\n      `/Accounts.json`,\n      { FriendlyName: friendlyName }\n    )\n  }\n  \n  /**\n   * Get subaccount details\n   */\n  async getSubaccount(accountSid: string): Promise<TwilioSubaccountResponse> {\n    return this.request<TwilioSubaccountResponse>(\n      'GET',\n      `/Accounts/${accountSid}.json`\n    )\n  }\n  \n  /**\n   * Update subaccount status (suspend/activate/close)\n   */\n  async updateSubaccountStatus(\n    accountSid: string, \n    status: 'active' | 'suspended' | 'closed'\n  ): Promise<TwilioSubaccountResponse> {\n    return this.request<TwilioSubaccountResponse>(\n      'POST',\n      `/Accounts/${accountSid}.json`,\n      { Status: status }\n    )\n  }\n  \n  // ==========================================\n  // PHONE NUMBER MANAGEMENT\n  // ==========================================\n  \n  /**\n   * Search available phone numbers\n   */\n  async searchAvailableNumbers(\n    country: string,\n    type: PhoneNumberType,\n    options: {\n      areaCode?: string\n      contains?: string\n      locality?: string\n      region?: string\n      limit?: number\n    } = {}\n  ): Promise<TwilioAvailableNumbersResponse> {\n    const params = new URLSearchParams()\n    \n    if (options.areaCode) params.append('AreaCode', options.areaCode)\n    if (options.contains) params.append('Contains', options.contains)\n    if (options.locality) params.append('InLocality', options.locality)\n    if (options.region) params.append('InRegion', options.region)\n    params.append('PageSize', String(options.limit || 20))\n    \n    const endpoint = type === 'toll_free' ? 'TollFree' : 'Local'\n    \n    return this.request<TwilioAvailableNumbersResponse>(\n      'GET',\n      `/Accounts/${this.accountSid}/AvailablePhoneNumbers/${country}/${endpoint}.json?${params.toString()}`,\n      undefined,\n      false\n    )\n  }\n  \n  /**\n   * Purchase a phone number\n   */\n  async purchaseNumber(\n    phoneNumber: string,\n    options: {\n      friendlyName?: string\n      voiceUrl?: string\n      voiceMethod?: string\n      smsUrl?: string\n      smsMethod?: string\n      statusCallbackUrl?: string\n    } = {}\n  ): Promise<TwilioIncomingPhoneNumberResponse> {\n    return this.request<TwilioIncomingPhoneNumberResponse>(\n      'POST',\n      `/Accounts/${this.accountSid}/IncomingPhoneNumbers.json`,\n      {\n        PhoneNumber: phoneNumber,\n        FriendlyName: options.friendlyName,\n        VoiceUrl: options.voiceUrl,\n        VoiceMethod: options.voiceMethod || 'POST',\n        SmsUrl: options.smsUrl,\n        SmsMethod: options.smsMethod || 'POST',\n        StatusCallback: options.statusCallbackUrl,\n      }\n    )\n  }\n  \n  /**\n   * Update phone number configuration\n   */\n  async updateNumber(\n    phoneNumberSid: string,\n    options: {\n      friendlyName?: string\n      voiceUrl?: string\n      voiceMethod?: string\n      smsUrl?: string\n      smsMethod?: string\n      statusCallbackUrl?: string\n      voiceApplicationSid?: string\n      smsApplicationSid?: string\n    }\n  ): Promise<TwilioIncomingPhoneNumberResponse> {\n    return this.request<TwilioIncomingPhoneNumberResponse>(\n      'POST',\n      `/Accounts/${this.accountSid}/IncomingPhoneNumbers/${phoneNumberSid}.json`,\n      {\n        FriendlyName: options.friendlyName,\n        VoiceUrl: options.voiceUrl,\n        VoiceMethod: options.voiceMethod,\n        SmsUrl: options.smsUrl,\n        SmsMethod: options.smsMethod,\n        StatusCallback: options.statusCallbackUrl,\n        VoiceApplicationSid: options.voiceApplicationSid,\n        SmsApplicationSid: options.smsApplicationSid,\n      }\n    )\n  }\n  \n  /**\n   * Release a phone number\n   */\n  async releaseNumber(phoneNumberSid: string): Promise<void> {\n    await this.request<void>(\n      'DELETE',\n      `/Accounts/${this.accountSid}/IncomingPhoneNumbers/${phoneNumberSid}.json`\n    )\n  }\n  \n  /**\n   * List phone numbers for account\n   */\n  async listNumbers(options: {\n    pageSize?: number\n    page?: number\n  } = {}): Promise<TwilioIncomingPhoneNumberListResponse> {\n    const params = new URLSearchParams()\n    params.append('PageSize', String(options.pageSize || 50))\n    if (options.page) params.append('Page', String(options.page))\n    \n    return this.request<TwilioIncomingPhoneNumberListResponse>(\n      'GET',\n      `/Accounts/${this.accountSid}/IncomingPhoneNumbers.json?${params.toString()}`,\n      undefined,\n      false\n    )\n  }\n  \n  // ==========================================\n  // CALLS\n  // ==========================================\n  \n  /**\n   * Initiate an outbound call\n   */\n  async makeCall(\n    to: string,\n    from: string,\n    options: {\n      url?: string\n      twiml?: string\n      statusCallback?: string\n      statusCallbackMethod?: string\n      statusCallbackEvent?: string[]\n      record?: boolean\n      recordingStatusCallback?: string\n      machineDetection?: 'Enable' | 'DetectMessageEnd'\n      machineDetectionTimeout?: number\n      timeout?: number\n    }\n  ): Promise<TwilioCallResponse> {\n    const body: Record<string, unknown> = {\n      To: to,\n      From: from,\n    }\n    \n    if (options.url) body.Url = options.url\n    if (options.twiml) body.Twiml = options.twiml\n    if (options.statusCallback) body.StatusCallback = options.statusCallback\n    if (options.statusCallbackMethod) body.StatusCallbackMethod = options.statusCallbackMethod\n    if (options.statusCallbackEvent) {\n      options.statusCallbackEvent.forEach((event, i) => {\n        body[`StatusCallbackEvent[${i}]`] = event\n      })\n    }\n    if (options.record !== undefined) body.Record = options.record\n    if (options.recordingStatusCallback) body.RecordingStatusCallback = options.recordingStatusCallback\n    if (options.machineDetection) body.MachineDetection = options.machineDetection\n    if (options.machineDetectionTimeout) body.MachineDetectionTimeout = options.machineDetectionTimeout\n    if (options.timeout) body.Timeout = options.timeout\n    \n    return this.request<TwilioCallResponse>(\n      'POST',\n      `/Accounts/${this.accountSid}/Calls.json`,\n      body\n    )\n  }\n  \n  /**\n   * Get call details\n   */\n  async getCall(callSid: string): Promise<TwilioCallResponse> {\n    return this.request<TwilioCallResponse>(\n      'GET',\n      `/Accounts/${this.accountSid}/Calls/${callSid}.json`\n    )\n  }\n  \n  /**\n   * Update/modify a call in progress\n   */\n  async updateCall(\n    callSid: string,\n    options: {\n      url?: string\n      twiml?: string\n      status?: 'canceled' | 'completed'\n    }\n  ): Promise<TwilioCallResponse> {\n    return this.request<TwilioCallResponse>(\n      'POST',\n      `/Accounts/${this.accountSid}/Calls/${callSid}.json`,\n      {\n        Url: options.url,\n        Twiml: options.twiml,\n        Status: options.status,\n      }\n    )\n  }\n  \n  // ==========================================\n  // MESSAGING\n  // ==========================================\n  \n  /**\n   * Send an SMS/MMS message\n   */\n  async sendMessage(\n    to: string,\n    from: string,\n    body: string,\n    options: {\n      mediaUrl?: string[]\n      statusCallback?: string\n      messagingServiceSid?: string\n    } = {}\n  ): Promise<TwilioMessageResponse> {\n    const requestBody: Record<string, unknown> = {\n      To: to,\n      From: from,\n      Body: body,\n    }\n    \n    if (options.mediaUrl) {\n      options.mediaUrl.forEach((url, i) => {\n        requestBody[`MediaUrl[${i}]`] = url\n      })\n    }\n    if (options.statusCallback) requestBody.StatusCallback = options.statusCallback\n    if (options.messagingServiceSid) requestBody.MessagingServiceSid = options.messagingServiceSid\n    \n    return this.request<TwilioMessageResponse>(\n      'POST',\n      `/Accounts/${this.accountSid}/Messages.json`,\n      requestBody\n    )\n  }\n  \n  // ==========================================\n  // USAGE RECORDS\n  // ==========================================\n  \n  /**\n   * Get usage records for billing\n   */\n  async getUsageRecords(options: {\n    category?: string\n    startDate?: string\n    endDate?: string\n  } = {}): Promise<TwilioUsageRecordsResponse> {\n    const params = new URLSearchParams()\n    if (options.category) params.append('Category', options.category)\n    if (options.startDate) params.append('StartDate', options.startDate)\n    if (options.endDate) params.append('EndDate', options.endDate)\n    \n    return this.request<TwilioUsageRecordsResponse>(\n      'GET',\n      `/Accounts/${this.accountSid}/Usage/Records.json?${params.toString()}`,\n      undefined,\n      false\n    )\n  }\n  \n  // ==========================================\n  // ACCOUNT VALIDATION\n  // ==========================================\n  \n  /**\n   * Validate credentials by fetching account info\n   */\n  async validateCredentials(): Promise<{ valid: boolean; error?: string }> {\n    try {\n      await this.request<TwilioSubaccountResponse>(\n        'GET',\n        `/Accounts/${this.accountSid}.json`\n      )\n      return { valid: true }\n    } catch (error) {\n      if (error instanceof TwilioApiError) {\n        return { valid: false, error: error.message }\n      }\n      return { valid: false, error: 'Unknown error' }\n    }\n  }\n}\n\n// ==========================================\n// TWILIO API ERROR\n// ==========================================\n\nclass TwilioApiError extends Error {\n  code: number\n  status: number\n  \n  constructor(message: string, code: number, status: number) {\n    super(message)\n    this.name = 'TwilioApiError'\n    this.code = code\n    this.status = status\n  }\n}\n\n// ==========================================\n// TWILIO API RESPONSE TYPES\n// ==========================================\n\ninterface TwilioSubaccountResponse {\n  sid: string\n  friendly_name: string\n  status: 'active' | 'suspended' | 'closed'\n  auth_token: string\n  date_created: string\n  date_updated: string\n  type: 'Full' | 'Trial'\n  owner_account_sid: string\n}\n\ninterface TwilioAvailableNumbersResponse {\n  available_phone_numbers: Array<{\n    phone_number: string\n    friendly_name: string\n    locality: string\n    region: string\n    postal_code: string\n    iso_country: string\n    capabilities: {\n      voice: boolean\n      sms: boolean\n      mms: boolean\n      fax: boolean\n    }\n    beta: boolean\n  }>\n  uri: string\n}\n\ninterface TwilioIncomingPhoneNumberResponse {\n  sid: string\n  account_sid: string\n  phone_number: string\n  friendly_name: string\n  capabilities: {\n    voice: boolean\n    sms: boolean\n    mms: boolean\n    fax: boolean\n  }\n  voice_url: string\n  voice_method: string\n  voice_fallback_url: string\n  sms_url: string\n  sms_method: string\n  sms_fallback_url: string\n  status_callback: string\n  status_callback_method: string\n  date_created: string\n  date_updated: string\n}\n\ninterface TwilioIncomingPhoneNumberListResponse {\n  incoming_phone_numbers: TwilioIncomingPhoneNumberResponse[]\n  first_page_uri: string\n  next_page_uri?: string\n  previous_page_uri?: string\n  page: number\n  page_size: number\n}\n\ninterface TwilioCallResponse {\n  sid: string\n  account_sid: string\n  to: string\n  from: string\n  status: 'queued' | 'ringing' | 'in-progress' | 'completed' | 'busy' | 'no-answer' | 'canceled' | 'failed'\n  direction: 'inbound' | 'outbound-api' | 'outbound-dial'\n  duration?: string\n  price?: string\n  price_unit?: string\n  answered_by?: 'human' | 'machine_start' | 'machine_end_beep' | 'machine_end_silence' | 'machine_end_other' | 'fax' | 'unknown'\n  date_created: string\n  date_updated: string\n  start_time?: string\n  end_time?: string\n}\n\ninterface TwilioMessageResponse {\n  sid: string\n  account_sid: string\n  to: string\n  from: string\n  body: string\n  status: 'queued' | 'sending' | 'sent' | 'delivered' | 'undelivered' | 'failed'\n  direction: 'inbound' | 'outbound-api' | 'outbound-call' | 'outbound-reply'\n  num_segments: string\n  price?: string\n  price_unit?: string\n  date_created: string\n  date_updated: string\n  date_sent?: string\n  error_code?: string\n  error_message?: string\n}\n\ninterface TwilioUsageRecordsResponse {\n  usage_records: Array<{\n    category: string\n    description: string\n    account_sid: string\n    start_date: string\n    end_date: string\n    count: string\n    count_unit: string\n    usage: string\n    usage_unit: string\n    price: string\n    price_unit: string\n  }>\n  first_page_uri: string\n  next_page_uri?: string\n  previous_page_uri?: string\n  page: number\n  page_size: number\n}\n\n// ==========================================\n// TWILIO SERVICE (HIGH-LEVEL OPERATIONS)\n// ==========================================\n\nexport class TwilioService {\n  private masterClient: TwilioApiClient | null = null\n  private config: AgencyTwilioConfig | null = null\n  \n  /**\n   * Initialize the service with agency config\n   */\n  async initialize(config: AgencyTwilioConfig): Promise<void> {\n    this.config = config\n    this.masterClient = new TwilioApiClient({\n      accountSid: config.accountSid,\n      authToken: config.authToken,\n    })\n  }\n  \n  /**\n   * Get a client for a specific subaccount\n   */\n  getSubaccountClient(twilioAccountSid: string, twilioAuthToken: string): TwilioApiClient {\n    return new TwilioApiClient({\n      accountSid: twilioAccountSid,\n      authToken: twilioAuthToken,\n    })\n  }\n  \n  /**\n   * Validate master account credentials\n   */\n  async validateMasterCredentials(accountSid: string, authToken: string): Promise<{ valid: boolean; error?: string }> {\n    const client = new TwilioApiClient({ accountSid, authToken })\n    return client.validateCredentials()\n  }\n  \n  // ==========================================\n  // SUBACCOUNT PROVISIONING\n  // ==========================================\n  \n  /**\n   * Provision a new Twilio subaccount for a CRM sub-account\n   */\n  async provisionSubaccount(\n    request: ProvisionSubaccountRequest,\n    webhookBaseUrl: string\n  ): Promise<ProvisionSubaccountResponse> {\n    if (!this.masterClient) {\n      return { success: false, error: 'Twilio service not initialized' }\n    }\n    \n    try {\n      // Create Twilio subaccount\n      const twilioSubaccount = await this.masterClient.createSubaccount(\n        request.friendlyName\n      )\n      \n      // Build subaccount record\n      const subaccount: Partial<TwilioSubaccount> = {\n        subAccountId: request.subAccountId,\n        twilioAccountSid: twilioSubaccount.sid,\n        twilioAuthToken: twilioSubaccount.auth_token,\n        friendlyName: twilioSubaccount.friendly_name,\n        status: 'active',\n        provisionedAt: new Date().toISOString(),\n        canMakeCalls: true,\n        canSendSms: false, // Requires 10DLC registration\n      }\n      \n      let phoneNumber: PhoneNumber | undefined\n      \n      // Auto-provision phone number if requested\n      if (request.autoProvisionPhoneNumber && this.config?.autoProvisionPhoneNumber) {\n        try {\n          const phoneResult = await this.purchaseNumberForSubaccount(\n            twilioSubaccount.sid,\n            twilioSubaccount.auth_token,\n            {\n              subAccountId: request.subAccountId,\n              agencyId: request.agencyId || '',\n              type: request.phoneNumberType || this.config.defaultPhoneNumberType,\n              country: this.config.defaultPhoneNumberCountry,\n              areaCode: request.areaCode || this.config.defaultPhoneNumberAreaCode || undefined,\n              initiatedByUserId: 'system',\n            },\n            webhookBaseUrl\n          )\n          \n          if (phoneResult.success && phoneResult.phoneNumber) {\n            phoneNumber = phoneResult.phoneNumber\n          }\n        } catch (error) {\n          console.error('Failed to auto-provision phone number:', error)\n          // Don't fail the whole operation, just log the error\n        }\n      }\n      \n      return {\n        success: true,\n        subaccount: subaccount as TwilioSubaccount,\n        phoneNumber,\n      }\n    } catch (error) {\n      console.error('Failed to provision subaccount:', error)\n      if (error instanceof TwilioApiError) {\n        return { success: false, error: error.message }\n      }\n      return { success: false, error: 'Failed to provision subaccount' }\n    }\n  }\n  \n  /**\n   * Suspend a Twilio subaccount\n   */\n  async suspendSubaccount(\n    twilioAccountSid: string,\n    reason: string\n  ): Promise<{ success: boolean; error?: string }> {\n    if (!this.masterClient) {\n      return { success: false, error: 'Twilio service not initialized' }\n    }\n    \n    try {\n      await this.masterClient.updateSubaccountStatus(twilioAccountSid, 'suspended')\n      return { success: true }\n    } catch (error) {\n      console.error('Failed to suspend subaccount:', error)\n      if (error instanceof TwilioApiError) {\n        return { success: false, error: error.message }\n      }\n      return { success: false, error: 'Failed to suspend subaccount' }\n    }\n  }\n  \n  /**\n   * Reactivate a suspended Twilio subaccount\n   */\n  async reactivateSubaccount(\n    twilioAccountSid: string\n  ): Promise<{ success: boolean; error?: string }> {\n    if (!this.masterClient) {\n      return { success: false, error: 'Twilio service not initialized' }\n    }\n    \n    try {\n      await this.masterClient.updateSubaccountStatus(twilioAccountSid, 'active')\n      return { success: true }\n    } catch (error) {\n      console.error('Failed to reactivate subaccount:', error)\n      if (error instanceof TwilioApiError) {\n        return { success: false, error: error.message }\n      }\n      return { success: false, error: 'Failed to reactivate subaccount' }\n    }\n  }\n  \n  // ==========================================\n  // PHONE NUMBER MANAGEMENT\n  // ==========================================\n  \n  /**\n   * Search for available phone numbers\n   */\n  async searchAvailableNumbers(\n    country: string,\n    type: PhoneNumberType,\n    options: {\n      areaCode?: string\n      contains?: string\n      locality?: string\n      region?: string\n      limit?: number\n    } = {}\n  ): Promise<AvailablePhoneNumber[]> {\n    if (!this.masterClient) {\n      throw new Error('Twilio service not initialized')\n    }\n    \n    const response = await this.masterClient.searchAvailableNumbers(\n      country,\n      type,\n      options\n    )\n    \n    return response.available_phone_numbers.map(num => ({\n      phoneNumber: num.phone_number,\n      friendlyName: num.friendly_name,\n      locality: num.locality,\n      region: num.region,\n      postalCode: num.postal_code,\n      country: num.iso_country,\n      areaCode: num.phone_number.slice(2, 5), // Extract area code from E.164\n      capabilities: {\n        voice: num.capabilities.voice,\n        sms: num.capabilities.sms,\n        mms: num.capabilities.mms,\n        fax: num.capabilities.fax,\n      },\n      monthlyPrice: type === 'toll_free' ? 2.00 : 1.00, // Approximate Twilio pricing\n      setupPrice: 0,\n    }))\n  }\n  \n  /**\n   * Purchase a phone number for a subaccount\n   */\n  async purchaseNumberForSubaccount(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    request: ProvisionPhoneNumberRequest,\n    webhookBaseUrl: string\n  ): Promise<ProvisionPhoneNumberResponse> {\n    const subaccountClient = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    \n    try {\n      // First, search for an available number\n      const availableNumbers = await this.searchAvailableNumbers(\n        request.country || 'US',\n        request.type,\n        {\n          areaCode: request.areaCode,\n          locality: request.locality,\n          contains: request.contains,\n          limit: 1,\n        }\n      )\n      \n      if (availableNumbers.length === 0) {\n        return {\n          success: false,\n          error: 'No phone numbers available matching your criteria',\n        }\n      }\n      \n      const selectedNumber = availableNumbers[0]\n      \n      // Purchase the number under the subaccount\n      const purchasedNumber = await subaccountClient.purchaseNumber(\n        selectedNumber.phoneNumber,\n        {\n          friendlyName: request.friendlyName || `RISIVO - ${request.subAccountId}`,\n          voiceUrl: `${webhookBaseUrl}/api/v1/webhooks/twilio/voice`,\n          smsUrl: `${webhookBaseUrl}/api/v1/webhooks/twilio/sms`,\n          statusCallbackUrl: `${webhookBaseUrl}/api/v1/webhooks/twilio/status`,\n        }\n      )\n      \n      // Calculate price with markup\n      const markup = this.config?.usageMarkupPercent || 5\n      const monthlyFee = selectedNumber.monthlyPrice\n      const monthlyFeeWithMarkup = monthlyFee * (1 + markup / 100)\n      \n      const phoneNumber: PhoneNumber = {\n        id: '', // Will be set by database\n        subAccountId: request.subAccountId,\n        twilioSubaccountId: twilioAccountSid,\n        phoneNumber: purchasedNumber.phone_number,\n        phoneNumberSid: purchasedNumber.sid,\n        friendlyName: purchasedNumber.friendly_name,\n        type: request.type,\n        country: selectedNumber.country,\n        region: selectedNumber.region,\n        locality: selectedNumber.locality,\n        areaCode: selectedNumber.areaCode,\n        isoCountry: selectedNumber.country,\n        voiceEnabled: purchasedNumber.capabilities.voice,\n        smsEnabled: purchasedNumber.capabilities.sms,\n        mmsEnabled: purchasedNumber.capabilities.mms,\n        faxEnabled: purchasedNumber.capabilities.fax,\n        isPrimary: true, // First number is primary\n        isDefault: true,\n        voiceUrl: purchasedNumber.voice_url,\n        voiceMethod: purchasedNumber.voice_method,\n        smsUrl: purchasedNumber.sms_url,\n        smsMethod: purchasedNumber.sms_method,\n        statusCallbackUrl: purchasedNumber.status_callback,\n        assignedFor: request.assignedFor || 'all',\n        monthlyFee,\n        monthlyFeeWithMarkup,\n        purchasedAt: new Date().toISOString(),\n        purchasePrice: selectedNumber.setupPrice,\n        paymentStatus: 'completed',\n        status: 'active',\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      }\n      \n      return { success: true, phoneNumber }\n    } catch (error) {\n      console.error('Failed to purchase phone number:', error)\n      if (error instanceof TwilioApiError) {\n        return { success: false, error: error.message }\n      }\n      return { success: false, error: 'Failed to purchase phone number' }\n    }\n  }\n  \n  /**\n   * Release a phone number\n   */\n  async releaseNumber(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    phoneNumberSid: string\n  ): Promise<{ success: boolean; error?: string }> {\n    const subaccountClient = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    \n    try {\n      await subaccountClient.releaseNumber(phoneNumberSid)\n      return { success: true }\n    } catch (error) {\n      console.error('Failed to release phone number:', error)\n      if (error instanceof TwilioApiError) {\n        return { success: false, error: error.message }\n      }\n      return { success: false, error: 'Failed to release phone number' }\n    }\n  }\n  \n  // ==========================================\n  // CALL OPERATIONS\n  // ==========================================\n  \n  /**\n   * Initiate an outbound call\n   */\n  async makeCall(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    to: string,\n    from: string,\n    webhookBaseUrl: string,\n    options: {\n      twiml?: string\n      url?: string\n      record?: boolean\n      machineDetection?: boolean\n      timeout?: number\n    } = {}\n  ): Promise<TwilioCallResponse> {\n    const client = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    \n    return client.makeCall(to, from, {\n      url: options.url || `${webhookBaseUrl}/api/v1/webhooks/twilio/voice/connect`,\n      twiml: options.twiml,\n      statusCallback: `${webhookBaseUrl}/api/v1/webhooks/twilio/call-status`,\n      statusCallbackMethod: 'POST',\n      statusCallbackEvent: ['initiated', 'ringing', 'answered', 'completed'],\n      record: options.record ?? true,\n      recordingStatusCallback: `${webhookBaseUrl}/api/v1/webhooks/twilio/recording-status`,\n      machineDetection: options.machineDetection ? 'DetectMessageEnd' : undefined,\n      machineDetectionTimeout: options.machineDetection ? 5 : undefined,\n      timeout: options.timeout || 30,\n    })\n  }\n  \n  /**\n   * End/cancel a call\n   */\n  async endCall(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    callSid: string\n  ): Promise<TwilioCallResponse> {\n    const client = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    return client.updateCall(callSid, { status: 'completed' })\n  }\n  \n  /**\n   * Get call details\n   */\n  async getCallDetails(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    callSid: string\n  ): Promise<TwilioCallResponse> {\n    const client = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    return client.getCall(callSid)\n  }\n  \n  // ==========================================\n  // MESSAGING OPERATIONS\n  // ==========================================\n  \n  /**\n   * Send an SMS message\n   */\n  async sendSms(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    to: string,\n    from: string,\n    body: string,\n    webhookBaseUrl: string,\n    options: {\n      mediaUrl?: string[]\n      messagingServiceSid?: string\n    } = {}\n  ): Promise<TwilioMessageResponse> {\n    const client = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    \n    return client.sendMessage(to, from, body, {\n      mediaUrl: options.mediaUrl,\n      statusCallback: `${webhookBaseUrl}/api/v1/webhooks/twilio/message-status`,\n      messagingServiceSid: options.messagingServiceSid,\n    })\n  }\n  \n  // ==========================================\n  // USAGE TRACKING\n  // ==========================================\n  \n  /**\n   * Get usage records for a subaccount\n   */\n  async getUsageRecords(\n    twilioAccountSid: string,\n    twilioAuthToken: string,\n    options: {\n      category?: string\n      startDate?: string\n      endDate?: string\n    } = {}\n  ): Promise<TwilioUsageRecordsResponse> {\n    const client = this.getSubaccountClient(twilioAccountSid, twilioAuthToken)\n    return client.getUsageRecords(options)\n  }\n  \n  /**\n   * Calculate cost with markup\n   */\n  calculateCostWithMarkup(\n    baseCost: number,\n    markupPercent?: number\n  ): { baseCost: number; markup: number; total: number } {\n    const percent = markupPercent ?? this.config?.usageMarkupPercent ?? 5\n    const markup = baseCost * (percent / 100)\n    return {\n      baseCost,\n      markup,\n      total: baseCost + markup,\n    }\n  }\n}\n\n// Export singleton instance\nexport const twilioService = new TwilioService()\n\n// Export types\nexport { TwilioApiClient, TwilioApiError }\nexport type {\n  TwilioSubaccountResponse,\n  TwilioCallResponse,\n  TwilioMessageResponse,\n  TwilioIncomingPhoneNumberResponse,\n  TwilioUsageRecordsResponse,\n}\n"],"names":[],"mappings":"k/BA4BA,OAAM,EACI,UAAkB,CAClB,SAAiB,CACjB,QAAU,mCAAmC,AAErD,aAAY,CAA8B,CAAE,CAC1C,IAAI,CAAC,UAAU,CAAG,EAAY,UAAU,CACxC,IAAI,CAAC,SAAS,CAAG,EAAY,SAAS,AACxC,CAEQ,eAAwB,CAC9B,IAAM,EAAc,OAAO,IAAI,CAAC,CAAA,EAAG,IAAI,CAAC,UAAU,CAAC,CAAC,EAAE,IAAI,CAAC,SAAS,CAAA,CAAE,EAAE,QAAQ,CAAC,UACjF,MAAO,CAAC,MAAM,EAAE,EAAA,CAAa,AAC/B,CAEA,MAAc,QACZ,CAAc,CACd,CAAY,CACZ,CAA8B,CAC9B,GAAc,CAAI,CACN,CACZ,IAMI,EANE,EAAM,CAAA,EAAG,IAAI,CAAC,OAAO,CAAA,EAAG,EAAA,CAAM,CAE9B,EAAkC,CACtC,cAAiB,IAAI,CAAC,aAAa,EACrC,EAII,GAAQ,GACV,CAAO,CAAC,QADe,OACA,CAAG,oCAC1B,EAAc,IAAI,gBAChB,OAAO,OAAO,CAAC,GAAM,MAAM,CAAC,CAAC,EAAK,CAAC,EAAK,EAAM,UACxC,IACF,CAAG,CAAC,EAAI,CAAG,CADC,MACM,EAAA,EAEb,GACN,AAJ0B,CAIzB,IACJ,KALuC,GAK/B,GALqC,CAMtC,IACT,CAAO,CADQ,AACP,eAAe,CAAG,mBAC1B,EAAc,KAAK,SAAS,CAAC,IAG/B,IAAM,EAAW,MAAM,MAAM,EAAK,QAChC,UACA,EACA,KAAM,CACR,GAEA,GAAI,CAAC,EAAS,EAAE,CAAE,CAChB,IAAM,EAAQ,MAAM,EAAS,IAAI,EACjC,OAAM,IAAI,EACR,EAAM,OAAO,EAAI,mBACjB,EAAM,IAAI,CACV,EAAS,MAAM,CAEnB,CAEA,OAAO,EAAS,IAAI,EACtB,CASA,MAAM,iBAAiB,CAAoB,CAAqC,CAC9E,OAAO,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,cAAc,CAAC,CAChB,CAAE,aAAc,CAAa,EAEjC,CAKA,MAAM,cAAc,CAAkB,CAAqC,CACzE,OAAO,IAAI,CAAC,OAAO,CACjB,MACA,CAAC,UAAU,EAAE,EAAW,KAAK,CAAC,CAElC,CAKA,MAAM,uBACJ,CAAkB,CAClB,CAAyC,CACN,CACnC,OAAO,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,EAAW,KAAK,CAAC,CAC9B,CAAE,OAAQ,CAAO,EAErB,CASA,MAAM,uBACJ,CAAe,CACf,CAAqB,CACrB,EAMI,CAAC,CAAC,CACmC,CACzC,IAAM,EAAS,IAAI,uBAEf,EAAQ,QAAQ,EAAE,EAAO,MAAM,CAAC,WAAY,EAAQ,QAAQ,EAC5D,EAAQ,QAAQ,EAAE,EAAO,MAAM,CAAC,WAAY,EAAQ,QAAQ,EAC5D,EAAQ,QAAQ,EAAE,EAAO,MAAM,CAAC,aAAc,EAAQ,QAAQ,EAC9D,EAAQ,MAAM,EAAE,EAAO,MAAM,CAAC,WAAY,EAAQ,MAAM,EAC5D,EAAO,MAAM,CAAC,WAAY,OAAO,EAAQ,KAAK,EAAI,KAI3C,IAAI,CAAC,OAAO,CACjB,MACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,uBAAuB,EAAE,EAAQ,CAAC,EAAE,AAJzC,cAAT,EAAuB,WAAa,QAIuB,MAAM,EAAE,EAAO,QAAQ,GAAA,CAAI,MACrG,EACA,GAEJ,CAKA,MAAM,eACJ,CAAmB,CACnB,EAOI,CAAC,CAAC,CACsC,CAC5C,OAAO,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,0BAA0B,CAAC,CACxD,CACE,YAAa,EACb,aAAc,EAAQ,YAAY,CAClC,SAAU,EAAQ,QAAQ,CAC1B,YAAa,EAAQ,WAAW,EAAI,OACpC,OAAQ,EAAQ,MAAM,CACtB,UAAW,EAAQ,SAAS,EAAI,OAChC,eAAgB,EAAQ,iBAAiB,AAC3C,EAEJ,CAKA,MAAM,aACJ,CAAsB,CACtB,CASC,CAC2C,CAC5C,OAAO,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,sBAAsB,EAAE,EAAe,KAAK,CAAC,CAC1E,CACE,aAAc,EAAQ,YAAY,CAClC,SAAU,EAAQ,QAAQ,CAC1B,YAAa,EAAQ,WAAW,CAChC,OAAQ,EAAQ,MAAM,CACtB,UAAW,EAAQ,SAAS,CAC5B,eAAgB,EAAQ,iBAAiB,CACzC,oBAAqB,EAAQ,mBAAmB,CAChD,kBAAmB,EAAQ,iBAAiB,AAC9C,EAEJ,CAKA,MAAM,cAAc,CAAsB,CAAiB,CACzD,MAAM,IAAI,CAAC,OAAO,CAChB,SACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,sBAAsB,EAAE,EAAe,KAAK,CAAC,CAE9E,CAKA,MAAM,YAAY,EAGd,CAAC,CAAC,CAAkD,CACtD,IAAM,EAAS,IAAI,gBAInB,OAHA,EAAO,MAAM,CAAC,WAAY,OAAO,EAAQ,QAAQ,EAAI,KACjD,EAAQ,IAAI,EAAE,EAAO,MAAM,CAAC,OAAQ,OAAO,EAAQ,IAAI,GAEpD,IAAI,CAAC,OAAO,CACjB,MACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,2BAA2B,EAAE,EAAO,QAAQ,GAAA,CAAI,MAC7E,GACA,EAEJ,CASA,MAAM,SACJ,CAAU,CACV,CAAY,CACZ,CAWC,CAC4B,CAC7B,IAAM,EAAgC,CACpC,GAAI,EACJ,KAAM,CACR,EAiBA,OAfI,EAAQ,GAAG,EAAE,GAAK,GAAG,CAAG,EAAQ,GAAA,AAAG,EACnC,EAAQ,KAAK,GAAE,EAAK,KAAK,CAAG,EAAQ,KAAA,AAAK,EACzC,EAAQ,cAAc,GAAE,EAAK,cAAc,CAAG,EAAQ,cAAc,AAAd,EACtD,EAAQ,oBAAoB,GAAE,EAAK,oBAAoB,CAAG,EAAQ,oBAAA,AAAoB,EACtF,EAAQ,mBAAmB,EAAE,AAC/B,EAAQ,mBAAmB,CAAC,OAAO,CAAC,CAAC,EAAO,KAC1C,CAAI,CAAC,CAAC,oBAAoB,EAAE,EAAE,CAAC,CAAC,CAAC,CAAG,CACtC,QAEqB,IAAnB,EAAQ,MAAM,GAAgB,EAAK,MAAM,CAAG,EAAQ,MAAA,AAAM,EAC1D,EAAQ,uBAAuB,GAAE,EAAK,uBAAuB,CAAG,EAAQ,uBAAA,AAAuB,EAC/F,EAAQ,gBAAgB,EAAE,GAAK,gBAAgB,CAAG,EAAQ,gBAAA,AAAgB,EAC1E,EAAQ,uBAAuB,GAAE,EAAK,uBAAuB,CAAG,EAAQ,uBAAA,AAAuB,EAC/F,EAAQ,OAAO,GAAE,EAAK,OAAO,CAAG,EAAQ,OAAA,AAAO,EAE5C,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CACzC,EAEJ,CAKA,MAAM,QAAQ,CAAe,CAA+B,CAC1D,OAAO,IAAI,CAAC,OAAO,CACjB,MACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,EAAQ,KAAK,CAAC,CAExD,CAKA,MAAM,WACJ,CAAe,CACf,CAIC,CAC4B,CAC7B,OAAO,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,EAAQ,KAAK,CAAC,CACpD,CACE,IAAK,EAAQ,GAAG,CAChB,MAAO,EAAQ,KAAK,CACpB,OAAQ,EAAQ,MAAM,AACxB,EAEJ,CASA,MAAM,YACJ,CAAU,CACV,CAAY,CACZ,CAAY,CACZ,EAII,CAAC,CAAC,CAC0B,CAChC,IAAM,EAAuC,CAC3C,GAAI,EACJ,KAAM,EACN,KAAM,CACR,EAUA,OARI,EAAQ,QAAQ,EAAE,AACpB,EAAQ,QAAQ,CAAC,OAAO,CAAC,CAAC,EAAK,KAC7B,CAAW,CAAC,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC,CAAC,CAAG,CAClC,GAEE,EAAQ,cAAc,EAAE,GAAY,cAAc,CAAG,EAAQ,cAAA,AAAc,EAC3E,EAAQ,mBAAmB,GAAE,EAAY,mBAAmB,CAAG,EAAQ,mBAAA,AAAmB,EAEvF,IAAI,CAAC,OAAO,CACjB,OACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,cAAc,CAAC,CAC5C,EAEJ,CASA,MAAM,gBAAgB,EAIlB,CAAC,CAAC,CAAuC,CAC3C,IAAM,EAAS,IAAI,gBAKnB,OAJI,EAAQ,QAAQ,EAAE,EAAO,MAAM,CAAC,WAAY,EAAQ,QAAQ,EAC5D,EAAQ,SAAS,EAAE,EAAO,MAAM,CAAC,YAAa,EAAQ,SAAS,EAC/D,EAAQ,OAAO,EAAE,EAAO,MAAM,CAAC,UAAW,EAAQ,OAAO,EAEtD,IAAI,CAAC,OAAO,CACjB,MACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,oBAAoB,EAAE,EAAO,QAAQ,GAAA,CAAI,MACtE,GACA,EAEJ,CASA,MAAM,qBAAmE,CACvE,GAAI,CAKF,OAJA,MAAM,IAAI,CAAC,OAAO,CAChB,MACA,CAAC,UAAU,EAAE,IAAI,CAAC,UAAU,CAAC,KAAK,CAAC,EAE9B,CAAE,OAAO,CAAK,CACvB,CAAE,MAAO,EAAO,CACd,GAAI,aAAiB,EACnB,MAAO,CAAE,MAAO,CADmB,EACZ,MAAO,EAAM,OAAO,AAAC,EAE9C,MAAO,CAAE,OAAO,EAAO,MAAO,eAAgB,CAChD,CACF,CACF,CAMA,MAAM,UAAuB,MAC3B,IAAY,AACZ,OAAc,AAEd,aAAY,CAAe,CAAE,CAAY,CAAE,CAAc,CAAE,CACzD,KAAK,CAAC,GACN,IAAI,CAAC,IAAI,CAAG,iBACZ,IAAI,CAAC,IAAI,CAAG,EACZ,IAAI,CAAC,MAAM,CAAG,CAChB,CACF,CA2jBO,IAAM,EAAgB,IA3btB,AA2b0B,MA3bpB,AACH,aAAuC,IAAI,CAC3C,OAAoC,IAK5C,AALgD,OAK1C,WAAW,CAA0B,CAAiB,CAC1D,IAAI,CAAC,MAAM,CAAG,EACd,IAAI,CAAC,YAAY,CAAG,IAAI,EAAgB,CACtC,WAAY,EAAO,UAAU,CAC7B,UAAW,EAAO,SAAS,AAC7B,EACF,CAKA,oBAAoB,CAAwB,CAAE,CAAuB,CAAmB,CACtF,OAAO,IAAI,EAAgB,CACzB,WAAY,EACZ,UAAW,CACb,EACF,CAKA,MAAM,0BAA0B,CAAkB,CAAE,CAAiB,CAA+C,CAElH,OADe,AACR,IADY,EAAgB,YAAE,YAAY,CAAU,GAC7C,mBAAmB,EACnC,CASA,MAAM,oBACJ,CAAmC,CACnC,CAAsB,CACgB,CACtC,GAAI,CAAC,IAAI,CAAC,YAAY,CACpB,CADsB,KACf,CAAE,SAAS,EAAO,MAAO,gCAAiC,EAGnE,GAAI,CAEF,IAgBI,EAhBE,EAAmB,MAAM,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAC/D,EAAQ,YAAY,EAIhB,EAAwC,CAC5C,aAAc,EAAQ,YAAY,CAClC,iBAAkB,EAAiB,GAAG,CACtC,gBAAiB,EAAiB,UAAU,CAC5C,aAAc,EAAiB,aAAa,CAC5C,OAAQ,SACR,cAAe,IAAI,OAAO,WAAW,GACrC,cAAc,EACd,YAAY,CACd,EAKA,GAAI,EAAQ,wBAAwB,EAAI,IAAI,CAAC,MAAM,EAAE,yBACnD,CAD6E,EACzE,CACF,IAAM,EAAc,MAAM,IAAI,CAAC,2BAA2B,CACxD,EAAiB,GAAG,CACpB,EAAiB,UAAU,CAC3B,CACE,aAAc,EAAQ,YAAY,CAClC,SAAU,EAAQ,QAAQ,EAAI,GAC9B,KAAM,EAAQ,eAAe,EAAI,IAAI,CAAC,MAAM,CAAC,sBAAsB,CACnE,QAAS,IAAI,CAAC,MAAM,CAAC,yBAAyB,CAC9C,SAAU,EAAQ,QAAQ,EAAI,IAAI,CAAC,MAAM,CAAC,0BAA0B,OAAI,EACxE,kBAAmB,QACrB,EACA,GAGE,EAAY,OAAO,EAAI,EAAY,WAAW,EAAE,CAClD,EAAc,EAAY,WAAA,AAAW,CAEzC,CAAE,MAAO,EAAO,CACd,QAAQ,KAAK,CAAC,yCAA0C,EAE1D,CAGF,MAAO,CACL,SAAS,EACT,WAAY,cACZ,CACF,CACF,CAAE,MAAO,EAAO,CAEd,GADA,QAAQ,KAAK,CAAC,kCAAmC,GAC7C,aAAiB,EACnB,MAAO,CAAE,OAD0B,EACjB,EAAO,MAAO,EAAM,OAAO,AAAC,EAEhD,MAAO,CAAE,SAAS,EAAO,MAAO,gCAAiC,CACnE,CACF,CAKA,MAAM,kBACJ,CAAwB,CACxB,CAAc,CACiC,CAC/C,GAAI,CAAC,IAAI,CAAC,YAAY,CACpB,CADsB,KACf,CAAE,SAAS,EAAO,MAAO,gCAAiC,EAGnE,GAAI,CAEF,OADA,MAAM,IAAI,CAAC,YAAY,CAAC,sBAAsB,CAAC,EAAkB,aAC1D,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CAEd,GADA,QAAQ,KAAK,CAAC,gCAAiC,GAC3C,aAAiB,EACnB,MAAO,CAAE,OAD0B,EACjB,EAAO,MAAO,EAAM,OAAO,AAAC,EAEhD,MAAO,CAAE,QAAS,GAAO,MAAO,8BAA+B,CACjE,CACF,CAKA,MAAM,qBACJ,CAAwB,CACuB,CAC/C,GAAI,CAAC,IAAI,CAAC,YAAY,CACpB,CADsB,KACf,CAAE,SAAS,EAAO,MAAO,gCAAiC,EAGnE,GAAI,CAEF,OADA,MAAM,IAAI,CAAC,YAAY,CAAC,sBAAsB,CAAC,EAAkB,UAC1D,CAAE,QAAS,EAAK,CACzB,CAAE,MAAO,EAAO,CAEd,GADA,QAAQ,KAAK,CAAC,mCAAoC,GAC9C,aAAiB,EACnB,MAAO,CAAE,OAD0B,CACjB,GAAO,MAAO,EAAM,OAAO,AAAC,EAEhD,MAAO,CAAE,SAAS,EAAO,MAAO,iCAAkC,CACpE,CACF,CASA,MAAM,uBACJ,CAAe,CACf,CAAqB,CACrB,EAMI,CAAC,CAAC,CAC2B,CACjC,GAAI,CAAC,IAAI,CAAC,YAAY,CACpB,CADsB,KAChB,AAAI,MAAM,kCASlB,MAAO,CANU,MAAM,IAAI,CAAC,YAAY,CAAC,sBAAsB,CAC7D,EACA,EACA,EAAA,EAGc,uBAAuB,CAAC,GAAG,CAAC,IAAQ,CAClD,CADiD,WACpC,EAAI,YAAY,CAC7B,aAAc,EAAI,aAAa,CAC/B,SAAU,EAAI,QAAQ,CACtB,OAAQ,EAAI,MAAM,CAClB,WAAY,EAAI,WAAW,CAC3B,QAAS,EAAI,WAAW,CACxB,SAAU,EAAI,YAAY,CAAC,KAAK,CAAC,EAAG,GACpC,aAAc,CACZ,MAAO,EAAI,YAAY,CAAC,KAAK,CAC7B,IAAK,EAAI,YAAY,CAAC,GAAG,CACzB,IAAK,EAAI,YAAY,CAAC,GAAG,CACzB,IAAK,EAAI,YAAY,CAAC,GAAG,AAC3B,EACA,aAAuB,cAAT,EAAuB,EAAO,EAC5C,WAAY,EACd,CAAC,CACH,CAKA,MAAM,4BACJ,CAAwB,CACxB,CAAuB,CACvB,CAAoC,CACpC,CAAsB,CACiB,CACvC,IAAM,EAAmB,IAAI,CAAC,mBAAmB,CAAC,EAAkB,GAEpE,GAAI,CAEF,IAAM,EAAmB,MAAM,IAAI,CAAC,sBAAsB,CACxD,EAAQ,OAAO,EAAI,KACnB,EAAQ,IAAI,CACZ,CACE,SAAU,EAAQ,QAAQ,CAC1B,SAAU,EAAQ,QAAQ,CAC1B,SAAU,EAAQ,QAAQ,CAC1B,MAAO,CACT,GAGF,GAAI,AAA4B,GAAG,GAAd,MAAM,CACzB,MAAO,CACL,SAAS,EACT,MAAO,mDACT,EAGF,IAAM,EAAiB,CAAgB,CAAC,EAAE,CAGpC,EAAkB,MAAM,EAAiB,cAAc,CAC3D,EAAe,WAAW,CAC1B,CACE,aAAc,EAAQ,YAAY,EAAI,CAAC,SAAS,EAAE,EAAQ,YAAY,CAAA,CAAE,CACxE,SAAU,CAAA,EAAG,EAAe,6BAA6B,CAAC,CAC1D,OAAQ,CAAA,EAAG,EAAe,2BAA2B,CAAC,CACtD,kBAAmB,CAAA,EAAG,EAAe,8BAA8B,CAAC,AACtE,GAII,EAAS,IAAI,CAAC,MAAM,EAAE,oBAAsB,EAC5C,EAAa,EAAe,YAAY,CAGxC,EAA2B,CAC/B,GAAI,GACJ,aAAc,EAAQ,YAAY,CAClC,mBAAoB,EACpB,YAAa,EAAgB,YAAY,CACzC,eAAgB,EAAgB,GAAG,CACnC,aAAc,EAAgB,aAAa,CAC3C,KAAM,EAAQ,IAAI,CAClB,QAAS,EAAe,OAAO,CAC/B,OAAQ,EAAe,MAAM,CAC7B,SAAU,EAAe,QAAQ,CACjC,SAAU,EAAe,QAAQ,CACjC,WAAY,EAAe,OAAO,CAClC,aAAc,EAAgB,YAAY,CAAC,KAAK,CAChD,WAAY,EAAgB,YAAY,CAAC,GAAG,CAC5C,WAAY,EAAgB,YAAY,CAAC,GAAG,CAC5C,WAAY,EAAgB,YAAY,CAAC,GAAG,CAC5C,UAAW,GACX,WAAW,EACX,SAAU,EAAgB,SAAS,CACnC,YAAa,EAAgB,YAAY,CACzC,OAAQ,EAAgB,OAAO,CAC/B,UAAW,EAAgB,UAAU,CACrC,kBAAmB,EAAgB,eAAe,CAClD,YAAa,EAAQ,WAAW,EAAI,iBACpC,EACA,qBA5B2B,GAAc,EAAI,EAAS,GAAA,CAAG,CA6BzD,CA7BwC,WA6B3B,IAAI,OAAO,WAAW,GACnC,cAAe,EAAe,UAAU,CACxC,cAAe,YACf,OAAQ,SACR,UAAW,IAAI,OAAO,WAAW,GACjC,UAAW,IAAI,OAAO,WAAW,EACnC,EAEA,MAAO,CAAE,SAAS,EAAM,aAAY,CACtC,CAAE,MAAO,EAAO,CAEd,GADA,QAAQ,KAAK,CAAC,mCAAoC,GAC9C,aAAiB,EACnB,MAAO,CAAE,OAD0B,EACjB,EAAO,MAAO,EAAM,OAAQ,AAAD,EAE/C,MAAO,CAAE,SAAS,EAAO,MAAO,iCAAkC,CACpE,CACF,CAKA,MAAM,cACJ,CAAwB,CACxB,CAAuB,CACvB,CAAsB,CACyB,CAC/C,IAAM,EAAmB,IAAI,CAAC,mBAAmB,CAAC,EAAkB,GAEpE,GAAI,CAEF,OADA,MAAM,EAAiB,aAAa,CAAC,GAC9B,CAAE,SAAS,CAAK,CACzB,CAAE,MAAO,EAAO,CAEd,GADA,QAAQ,KAAK,CAAC,kCAAmC,GAC7C,aAAiB,EACnB,MAAO,CAAE,OAD0B,EACjB,EAAO,MAAO,EAAM,OAAO,AAAC,EAEhD,MAAO,CAAE,SAAS,EAAO,MAAO,gCAAiC,CACnE,CACF,CASA,MAAM,SACJ,CAAwB,CACxB,CAAuB,CACvB,CAAU,CACV,CAAY,CACZ,CAAsB,CACtB,EAMI,CAAC,CAAC,CACuB,CAG7B,OAFe,AAER,IAFY,CAAC,mBAAmB,CAAC,EAAkB,GAE5C,QAAQ,CAAC,EAAI,EAAM,CAC/B,IAAK,EAAQ,GAAG,EAAI,CAAA,EAAG,EAAe,qCAAqC,CAAC,CAC5E,MAAO,EAAQ,KAAK,CACpB,eAAgB,CAAA,EAAG,EAAe,mCAAmC,CAAC,CACtE,qBAAsB,OACtB,oBAAqB,CAAC,YAAa,UAAW,WAAY,YAAY,CACtE,OAAQ,EAAQ,MAAM,EAAI,GAC1B,wBAAyB,CAAA,EAAG,EAAe,wCAAwC,CAAC,CACpF,iBAAkB,EAAQ,gBAAgB,CAAG,wBAAqB,EAClE,wBAAyB,EAAQ,gBAAgB,CAAG,OAAI,EACxD,QAAS,EAAQ,OAAO,EAAI,EAC9B,EACF,CAKA,MAAM,QACJ,CAAwB,CACxB,CAAuB,CACvB,CAAe,CACc,CAE7B,OAAO,AADQ,IAAI,CAAC,mBAAmB,CAAC,EAAkB,GAC5C,UAAU,CAAC,EAAS,CAAE,OAAQ,WAAY,EAC1D,CAKA,MAAM,eACJ,CAAwB,CACxB,CAAuB,CACvB,CAAe,CACc,CAE7B,OADe,AACR,IADY,CAAC,mBAAmB,CAAC,EAAkB,GAC5C,OAAO,CAAC,EACxB,CASA,MAAM,QACJ,CAAwB,CACxB,CAAuB,CACvB,CAAU,CACV,CAAY,CACZ,CAAY,CACZ,CAAsB,CACtB,EAGI,CAAC,CAAC,CAC0B,CAGhC,OAAO,AAFQ,IAAI,CAAC,mBAAmB,CAAC,EAAkB,GAE5C,WAAW,CAAC,EAAI,EAAM,EAAM,CACxC,SAAU,EAAQ,QAAQ,CAC1B,eAAgB,CAAA,EAAG,EAAe,sCAAsC,CAAC,CACzE,oBAAqB,EAAQ,mBAAmB,AAClD,EACF,CASA,MAAM,gBACJ,CAAwB,CACxB,CAAuB,CACvB,EAII,CAAC,CAAC,CAC+B,CAErC,OADe,AACR,IADY,CAAC,mBAAmB,CAAC,EAAkB,GAC5C,eAAe,CAAC,EAChC,CAKA,wBACE,CAAgB,CAChB,CAAsB,CAC+B,CAErD,IAAM,GADU,GAAiB,IAAI,CAAC,MAAM,EAAE,qBAAsB,EAC/B,GAAG,CAAzB,EACf,MAAO,GADmB,CAAC,MAEzB,EACA,SACA,MAAO,EAAW,CACpB,CACF,CACF"}