module.exports=[8135,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),o=e.i(59756),n=e.i(61916),i=e.i(14444),s=e.i(37092),c=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),w=e.i(66012),f=e.i(70101),g=e.i(26937),h=e.i(10372),_=e.i(93695);e.i(52474);var m=e.i(220),k=e.i(89171),y=e.i(89660),b=e.i(75949);class x{supabase;constructor(e){this.supabase=e}async executeWorkflow(e){let t=Date.now();try{let{data:r,error:a}=await this.supabase.from("workflow_executions").select(`
          *,
          workflows (
            *,
            workflow_actions (*)
          ),
          contacts (*)
        `).eq("id",e).single();if(a||!r)return void await this.logError(e,"unknown","Execution not found",{executionId:e});await this.updateExecutionStatus(e,"running",{started_at:new Date().toISOString()}),await this.log(e,r.workflow_id,"info","Workflow execution started",{workflowName:r.workflows?.name});let o={executionId:e,workflowId:r.workflow_id,workflow:r.workflows,contactId:r.contact_id,companyId:r.company_id,triggerData:r.trigger_data||{},variables:r.context_data||{},contact:r.contacts||void 0},n=(r.workflows?.workflow_actions||[]).sort((e,t)=>e.execution_order-t.execution_order);if(0===n.length){await this.log(e,r.workflow_id,"warning","No actions in workflow"),await this.updateExecutionStatus(e,"completed",{completed_at:new Date().toISOString()});return}let i=r.current_action_index||0,s=!1;for(;i<n.length&&!s;){let t=n[i];if(await this.supabase.from("workflow_executions").update({current_action_index:i}).eq("id",e),t.conditions&&t.conditions.length>0&&!await this.evaluateConditions(t.conditions,o)){await this.recordActionResult(e,t.id,t.action_type,"skipped",{reason:"Conditions not met"}),i++;continue}if(t.delay_minutes>0){let a=new Date(Date.now()+60*t.delay_minutes*1e3);await this.scheduleAction(e,t.id,a),await this.updateExecutionStatus(e,"paused",{current_action_index:i}),await this.log(e,r.workflow_id,"info",`Action scheduled for ${a.toISOString()}`,{actionId:t.id});return}let a=await this.executeAction(t,o);if(await this.recordActionResult(e,t.id,t.action_type,a.success?"success":"failed",a.output,a.error),!a.success)if(!t.continue_on_error)return void await this.updateExecutionStatus(e,"failed",{error_message:a.error,error_action_id:t.id,completed_at:new Date().toISOString()});else await this.log(e,r.workflow_id,"warning",`Action failed but continuing: ${a.error}`,{actionId:t.id});if(a.output&&(o.variables={...o.variables,...a.output},await this.supabase.from("workflow_executions").update({context_data:o.variables}).eq("id",e)),a.skipRemainingActions)s=!0;else if(a.nextActionId){let e=n.findIndex(e=>e.id===a.nextActionId);if(-1!==e){i=e;continue}}i++}let c=Date.now()-t;await this.updateExecutionStatus(e,"completed",{completed_at:new Date().toISOString()}),await this.log(e,r.workflow_id,"info",`Workflow completed in ${c}ms`,{totalActions:n.length})}catch(t){console.error("Workflow execution error:",t),await this.updateExecutionStatus(e,"failed",{error_message:t instanceof Error?t.message:"Unknown error",completed_at:new Date().toISOString()})}}async executeAction(t,r){let a=Date.now();try{await this.log(r.executionId,r.workflowId,"info",`Executing action: ${t.name} (${t.action_type})`,{actionId:t.id});let{ActionExecutors:o}=await e.A(47861),n=o[t.action_type];if(!n)return{success:!1,error:`Unknown action type: ${t.action_type}`};let i=this.substituteVariables(t.config,r),s=await n(i,r,this.supabase),c=Date.now()-a;return await this.log(r.executionId,r.workflowId,s.success?"info":"error",`Action ${t.name} ${s.success?"completed":"failed"} in ${c}ms`,{actionId:t.id,result:s}),s}catch(e){return{success:!1,error:e instanceof Error?e.message:"Action execution failed"}}}substituteVariables(e,t){if("string"==typeof e)return this.substituteString(e,t);if(Array.isArray(e))return e.map(e=>this.substituteVariables(e,t));if("object"==typeof e&&null!==e){let r={};for(let[a,o]of Object.entries(e))r[a]=this.substituteVariables(o,t);return r}return e}substituteString(e,t){return e.replace(/\{\{([^}]+)\}\}/g,(e,r)=>{let a=this.getValueByPath(r.trim(),t);return void 0!==a?String(a):e})}getValueByPath(e,t){let r,a=e.split("."),o=a[0],n=a.slice(1);switch(o){case"contact":r=t.contact;break;case"company":r=t.company;break;case"trigger":r=t.triggerData;break;case"variables":r=t.variables;break;default:r=t.variables[o]}for(let e of n){if(null==r)return;r=r[e]}return r}async evaluateConditions(e,t){if(0===e.length)return!0;let r=this.evaluateSingleCondition(e[0],t);for(let a=1;a<e.length;a++){let o=e[a],n=this.evaluateSingleCondition(o,t);r="OR"===o.logicOperator?r||n:r&&n}return r}evaluateSingleCondition(e,t){let r=this.getValueByPath(e.field,t),a=e.value;switch(e.operator){case"equals":return r==a;case"not_equals":return r!=a;case"contains":return String(r).includes(String(a));case"not_contains":return!String(r).includes(String(a));case"greater_than":return Number(r)>Number(a);case"less_than":return Number(r)<Number(a);case"is_empty":return null==r||""===r;case"is_not_empty":return null!=r&&""!==r;case"in":return Array.isArray(a)&&a.includes(r);case"not_in":return!Array.isArray(a)||!a.includes(r);default:return!1}}async updateExecutionStatus(e,t,r={}){await this.supabase.from("workflow_executions").update({status:t,updated_at:new Date().toISOString(),...r}).eq("id",e)}async recordActionResult(e,t,r,a,o,n){await this.supabase.from("action_execution_results").insert({id:(0,b.v4)(),workflow_execution_id:e,action_id:t,action_type:r,status:a,started_at:new Date().toISOString(),completed_at:new Date().toISOString(),output:o||{},error_message:n})}async scheduleAction(e,t,r){await this.supabase.from("scheduled_actions").insert({id:(0,b.v4)(),workflow_execution_id:e,action_id:t,scheduled_for:r.toISOString(),status:"pending"})}async log(e,t,r,a,o){try{await this.supabase.from("workflow_logs").insert({id:(0,b.v4)(),workflow_execution_id:e,workflow_id:t,level:r,message:a,metadata:o||{}})}catch(e){console.error("Failed to write workflow log:",e)}}async logError(e,t,r,a){await this.log(e,t,"error",r,a)}}async function v(e){let t=new x(y.supabaseAdmin);await t.executeWorkflow(e)}async function S(e){let t=y.supabaseAdmin,r=[],a=[];try{let{data:o,error:n}=await t.from("workflows").select(`
        *,
        workflow_actions (*)
      `).eq("sub_account_id",e.subAccountId).eq("trigger_type",e.type).eq("status","active");if(n)return console.error("Error fetching workflows for trigger:",n),{success:!1,triggeredWorkflows:[],errors:[n.message]};if(!o||0===o.length)return{success:!0,triggeredWorkflows:[]};for(let n of o)try{if(!await I(n.trigger_filters||[],e,n.trigger_config)||e.contactId&&!await E(t,n,e.contactId))continue;let o=(0,b.v4)(),{error:i}=await t.from("workflow_executions").insert({id:o,workflow_id:n.id,contact_id:e.contactId,company_id:e.companyId,status:"pending",trigger_type:e.type,trigger_data:{...e.data,triggered_at:e.timestamp||new Date().toISOString()},triggered_at:e.timestamp||new Date().toISOString(),context_data:{}});if(i){a.push(`Failed to create execution for workflow ${n.id}: ${i.message}`);continue}await t.from("workflow_logs").insert({id:(0,b.v4)(),workflow_execution_id:o,workflow_id:n.id,level:"info",message:`Workflow triggered by ${e.type}`,metadata:{triggerType:e.type,contactId:e.contactId,triggerData:e.data}}),r.push(o),v(o).catch(e=>{console.error(`Error executing workflow ${o}:`,e)})}catch(e){a.push(`Error processing workflow ${n.id}: ${e}`)}return{success:0===a.length,triggeredWorkflows:r,errors:a.length>0?a:void 0}}catch(e){return console.error("Trigger handler error:",e),{success:!1,triggeredWorkflows:[],errors:[e instanceof Error?e.message:"Unknown error"]}}}async function I(e,t,r){if(0===e.length){var a=t,o=r;switch(a.type){case"contact_tag":if(o.tagIds&&o.tagIds.length>0){let e=a.data.tagId;if(!o.tagIds.includes(e))return!1}if(o.tagOperation&&"any"!==o.tagOperation&&o.tagOperation!==a.data.operation)return!1;break;case"appointment_status":if(o.appointmentStatuses&&o.appointmentStatuses.length>0&&!o.appointmentStatuses.includes(a.data.status)||o.calendarIds&&o.calendarIds.length>0&&!o.calendarIds.includes(a.data.calendarId))return!1;break;case"call_status":if(o.callStatuses&&o.callStatuses.length>0&&!o.callStatuses.includes(a.data.status))return!1;break;case"email_events":if(o.emailEvents&&o.emailEvents.length>0&&!o.emailEvents.includes(a.data.eventType))return!1;break;case"opportunity_status_change":if(o.opportunityStatuses&&o.opportunityStatuses.length>0&&!o.opportunityStatuses.includes(a.data.newStatus)||o.pipelineId&&o.pipelineId!==a.data.pipelineId)return!1;break;case"pipeline_stage_changed":if(o.pipelineId&&o.pipelineId!==a.data.pipelineId||o.stageId&&o.stageId!==a.data.newStageId)return!1;break;case"form_submitted":if(o.formId&&o.formId!==a.data.formId)return!1;break;case"trigger_links_clicked":if(o.linkId&&o.linkId!==a.data.linkId)return!1}return!0}let n=R(e[0],t);for(let r=1;r<e.length;r++){let a=e[r],o=R(a,t);n="OR"===a.logicOperator?n||o:n&&o}return n}function R(e,t){var r;let a=(r=t.data,e.field.split(".").reduce((e,t)=>e?.[t],r)),o=e.value;switch(e.operator){case"equals":return a==o;case"not_equals":return a!=o;case"contains":return String(a).toLowerCase().includes(String(o).toLowerCase());case"not_contains":return!String(a).toLowerCase().includes(String(o).toLowerCase());case"greater_than":return Number(a)>Number(o);case"less_than":return Number(a)<Number(o);case"is_empty":return null==a||""===a;case"is_not_empty":return null!=a&&""!==a;default:return!0}}async function E(e,t,r){if(!t.allow_multiple_executions){let{count:a}=await e.from("workflow_executions").select("*",{count:"exact",head:!0}).eq("workflow_id",t.id).eq("contact_id",r).neq("status","cancelled");if(a&&a>0)return!1}if(t.max_executions_per_contact){let{count:a}=await e.from("workflow_executions").select("*",{count:"exact",head:!0}).eq("workflow_id",t.id).eq("contact_id",r).neq("status","cancelled");if(a&&a>=t.max_executions_per_contact)return!1}return!0}async function A(e,t,r,a){return S({type:"inbound_webhook",subAccountId:e,contactId:a,data:{webhookPath:t,payload:r}})}async function C(e,t,r){let a=y.supabaseAdmin,{data:o,error:n}=await a.from("webhook_endpoints").select("*").eq("endpoint_path",e).eq("is_active",!0).single();if(n||!o)return{success:!1,message:"Webhook endpoint not found"};if(o.secret_key){let e=r["x-webhook-secret"]||r.authorization;if(e!==o.secret_key&&e!==`Bearer ${o.secret_key}`)return{success:!1,message:"Invalid webhook secret"}}if(o.expected_headers&&Object.keys(o.expected_headers).length>0){for(let[e,t]of Object.entries(o.expected_headers))if(r[e.toLowerCase()]!==t)return{success:!1,message:`Missing or invalid header: ${e}`}}await a.from("webhook_endpoints").update({total_requests:o.total_requests+1,last_request_at:new Date().toISOString()}).eq("id",o.id);let i=await A(o.sub_account_id,e,t,t.contactId||t.contact_id);return{success:i.success,message:i.success?"Webhook processed successfully":"Failed to process webhook",workflowsTriggered:i.triggeredWorkflows.length}}async function O(e,{params:t}){try{let r,{path:a}=await t,o=a.join("/");try{r=await e.json()}catch{r={}}let n={};e.headers.forEach((e,t)=>{n[t.toLowerCase()]=e});let i=await C(o,r,n);if(!i.success)return k.NextResponse.json({success:!1,error:i.message},{status:i.message.includes("not found")?404:401});return k.NextResponse.json({success:!0,message:i.message,workflowsTriggered:i.workflowsTriggered})}catch(e){return console.error("Error processing webhook:",e),k.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}async function N(e,{params:t}){try{let{path:r}=await t,a=r.join("/"),{searchParams:o}=new URL(e.url),n={};o.forEach((e,t)=>{n[t]=e});let i={};e.headers.forEach((e,t)=>{i[t.toLowerCase()]=e});let s=await C(a,n,i);if(!s.success)return k.NextResponse.json({success:!1,error:s.message},{status:s.message.includes("not found")?404:401});return k.NextResponse.json({success:!0,message:s.message,workflowsTriggered:s.workflowsTriggered})}catch(e){return console.error("Error processing webhook:",e),k.NextResponse.json({success:!1,error:"Internal server error"},{status:500})}}e.s(["GET",()=>N,"POST",()=>O],75090);var q=e.i(75090);let T=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/v1/webhooks/[...path]/route",pathname:"/api/v1/webhooks/[...path]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/v1/webhooks/[...path]/route.ts",nextConfigOutput:"",userland:q}),{workAsyncStorage:D,workUnitAsyncStorage:P,serverHooks:$}=T;function j(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:P})}async function U(e,t,a){T.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let k="/api/v1/webhooks/[...path]/route";k=k.replace(/\/index$/,"")||"/";let y=await T.prepare(e,t,{srcPage:k,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:b,params:x,nextConfig:v,parsedUrl:S,isDraftMode:I,prerenderManifest:R,routerServerContext:E,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,resolvedPathname:O,clientReferenceManifest:N,serverActionsManifest:q}=y,D=(0,c.normalizeAppPath)(k),P=!!(R.dynamicRoutes[D]||R.routes[O]),$=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,S,!1):t.end("This page could not be found"),null);if(P&&!I){let e=!!R.routes[O],t=R.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await $();throw new _.NoFallbackError}}let j=null;!P||T.isDev||I||(j="/index"===(j=O)?"/":j);let U=!0===T.isDev||!P,H=P&&!U;q&&N&&(0,i.setReferenceManifestsSingleton)({page:k,clientReferenceManifest:N,serverActionsManifest:q,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:q})});let M=e.method||"GET",W=(0,n.getTracer)(),L=W.getActiveScopeSpan(),F={params:x,prerenderManifest:R,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>T.onRequestError(e,t,a,E)},sharedContext:{buildId:b}},V=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest(V,(0,u.signalFromNodeResponse)(t));try{let i=async e=>T.handle(K,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=W.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${M} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${k}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),c=async o=>{var n,c;let l=async({previousCacheEntry:r})=>{try{if(!s&&A&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(o);e.fetchMetrics=F.renderOpts.fetchMetrics;let c=F.renderOpts.pendingWaitUntil;c&&a.waitUntil&&(a.waitUntil(c),c=void 0);let l=F.renderOpts.collectedTags;if(!P)return await (0,w.sendResponse)(V,B,n,F.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,a=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await T.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})},E),t}},u=await T.handleResponse({req:e,nextConfig:v,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:R,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:C,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!P)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(c=u.value)?void 0:c.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,f.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&P||d.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,w.sendResponse)(V,B,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};L?await c(L):await W.withPropagatedContext(e.headers,()=>W.trace(d.BaseServerSpan.handleRequest,{spanName:`${M} ${k}`,kind:n.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},c))}catch(t){if(t instanceof _.NoFallbackError||await T.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:A})}),P)throw t;return await (0,w.sendResponse)(V,B,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>j,"routeModule",()=>T,"serverHooks",()=>$,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>P],8135)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_46302387.js.map