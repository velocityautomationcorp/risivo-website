{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 16, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/middleware.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\nimport type { NextRequest } from 'next/server'\n\n/**\n * RISIVO CRM Middleware\n * \n * Uses custom JWT verification to work with our custom login endpoint\n */\n\n// Routes that require authentication\nconst PROTECTED_ROUTE_PREFIXES = [\n  '/sub-account',\n  '/admin',\n  '/company',\n  '/agency',\n  '/dashboard',\n  '/super-admin',\n]\n\n// Routes that are always public\nconst PUBLIC_ROUTES = [\n  '/',\n  '/auth/signin',\n  '/auth/signup',\n  '/auth/forgot-password',\n  '/auth/reset-password',\n  '/demo/access',\n  '/demo/signup',\n  '/demo/verify',\n  '/demo/login',\n  '/demo/forgot-password',\n  '/demo/reset-password',\n  '/book',\n]\n\n// Demo users cannot access these routes\nconst DEMO_RESTRICTED_ROUTES = [\n  '/sub-account/settings',\n  '/sub-account/platform-admin',\n  '/sub-account/settings/my-staff',\n  '/sub-account/settings/business-profile',\n  '/sub-account/settings/branding',\n  '/sub-account/settings/import',\n  '/company/settings',\n  '/agency/settings',\n]\n\n// Redirect map from old admin paths to new platform-admin paths\nconst adminRedirects: Record<string, string> = {\n  '/super-admin': '/sub-account/platform-admin',\n  '/super-admin/agencies': '/sub-account/platform-admin/agencies',\n  '/super-admin/settings': '/sub-account/platform-admin/settings',\n  '/super-admin/settings/telephony': '/sub-account/platform-admin/settings/telephony',\n  '/super-admin/settings/subscriptions': '/sub-account/platform-admin/settings/subscriptions',\n  '/super-admin/billing': '/sub-account/platform-admin/billing',\n  '/super-admin/analytics': '/sub-account/platform-admin/analytics',\n  '/super-admin/health': '/sub-account/platform-admin/health',\n  '/super-admin/logs': '/sub-account/platform-admin/logs',\n  '/super-admin/features': '/sub-account/platform-admin/features',\n  '/admin': '/sub-account/platform-admin',\n  '/admin/overview': '/sub-account/platform-admin',\n  '/admin/staff': '/sub-account/platform-admin/staff',\n  '/admin/support': '/sub-account/platform-admin/support',\n  '/admin/users': '/sub-account/platform-admin/users',\n  '/admin/companies': '/sub-account/platform-admin/agencies',\n  '/admin/newsletters': '/sub-account/platform-admin/newsletters',\n  '/admin/settings': '/sub-account/platform-admin/settings',\n  '/admin/settings/roles': '/sub-account/platform-admin/settings/roles',\n  '/admin/settings/custom-fields': '/sub-account/platform-admin/settings/custom-fields',\n  '/admin/settings/email-service': '/sub-account/platform-admin/settings/email-service',\n}\n\n// Simple JWT decode (no verification in middleware - just check if token exists and not expired)\nfunction decodeJWT(token: string): Record<string, any> | null {\n  try {\n    const parts = token.split('.')\n    if (parts.length !== 3) return null\n    \n    const payload = parts[1]\n    const decoded = JSON.parse(Buffer.from(payload, 'base64url').toString('utf-8'))\n    \n    // Check expiration\n    if (decoded.exp && decoded.exp < Math.floor(Date.now() / 1000)) {\n      return null // Token expired\n    }\n    \n    return decoded\n  } catch {\n    return null\n  }\n}\n\nexport async function middleware(request: NextRequest) {\n  const { pathname } = request.nextUrl\n  \n  // Skip static files and API routes\n  if (\n    pathname.startsWith('/_next/') ||\n    pathname.startsWith('/favicon') ||\n    pathname.startsWith('/api/') ||\n    pathname.includes('.')\n  ) {\n    return NextResponse.next()\n  }\n\n  // Check for admin path redirects (only when ?no-redirect is not present)\n  const noRedirect = request.nextUrl.searchParams.get('no-redirect')\n  if (!noRedirect) {\n    if (adminRedirects[pathname]) {\n      const url = request.nextUrl.clone()\n      url.pathname = adminRedirects[pathname]\n      return NextResponse.redirect(url, { status: 301 })\n    }\n    \n    for (const [oldPath, newPath] of Object.entries(adminRedirects)) {\n      if (pathname.startsWith(oldPath + '/')) {\n        const remainingPath = pathname.slice(oldPath.length)\n        const url = request.nextUrl.clone()\n        url.pathname = newPath + remainingPath\n        return NextResponse.redirect(url, { status: 301 })\n      }\n    }\n  }\n  \n  // Handle locale prefixes\n  const localePattern = /^\\/(en|fr|es|de|pt|zh|ar|ja|ko|it|nl|ru|pl)(\\/|$)/\n  if (localePattern.test(pathname)) {\n    const newPath = pathname.replace(localePattern, '/')\n    const url = request.nextUrl.clone()\n    url.pathname = newPath || '/'\n    return NextResponse.redirect(url)\n  }\n\n  // Check if route is public\n  const isPublicRoute = PUBLIC_ROUTES.some(route => \n    pathname === route || pathname.startsWith(route + '/')\n  )\n  \n  if (isPublicRoute) {\n    return NextResponse.next()\n  }\n\n  // Check if route requires authentication\n  const isProtectedRoute = PROTECTED_ROUTE_PREFIXES.some(prefix =>\n    pathname.startsWith(prefix)\n  )\n\n  if (isProtectedRoute) {\n    // Get JWT from cookies - check both production and dev cookie names\n    const prodCookie = request.cookies.get('__Secure-authjs.session-token')?.value\n    const devCookie = request.cookies.get('authjs.session-token')?.value\n    const tokenValue = prodCookie || devCookie\n\n    // Decode the token\n    const token = tokenValue ? decodeJWT(tokenValue) : null\n\n    // Check for demo access token\n    const demoToken = request.cookies.get('demo_access_token')?.value\n\n    // If no session and no demo token, redirect to signin\n    if (!token && !demoToken) {\n      const signinUrl = new URL('/auth/signin', request.url)\n      signinUrl.searchParams.set('callbackUrl', pathname)\n      return NextResponse.redirect(signinUrl)\n    }\n\n    // Handle demo user restrictions\n    const isDemo = token?.role === 'demo' || demoToken\n    \n    if (isDemo) {\n      const isRestrictedForDemo = DEMO_RESTRICTED_ROUTES.some(route =>\n        pathname.startsWith(route)\n      )\n\n      if (isRestrictedForDemo) {\n        const dashboardUrl = new URL('/sub-account/dashboard', request.url)\n        dashboardUrl.searchParams.set('restricted', 'demo')\n        return NextResponse.redirect(dashboardUrl)\n      }\n    }\n\n    // Check user status\n    if (token?.status === 'suspended') {\n      const suspendedUrl = new URL('/auth/suspended', request.url)\n      return NextResponse.redirect(suspendedUrl)\n    }\n\n    // Add user info to headers for server components\n    const response = NextResponse.next()\n    \n    if (token) {\n      response.headers.set('x-user-id', String(token.id || ''))\n      response.headers.set('x-user-role', String(token.role || ''))\n      response.headers.set('x-user-email', String(token.email || ''))\n      response.headers.set('x-agency-id', String(token.agencyId || ''))\n      \n      if (token.isMasterAdmin) {\n        response.headers.set('x-is-master-admin', 'true')\n      }\n    }\n\n    if (demoToken) {\n      response.headers.set('x-demo-token', demoToken)\n      response.headers.set('x-user-role', 'demo')\n    }\n\n    return response\n  }\n\n  return NextResponse.next()\n}\n\nexport const config = {\n  matcher: [\n    '/((?!_next/static|_next/image|favicon.ico).*)',\n  ],\n}\n"],"names":[],"mappings":"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"}}]
}